{
  "doc_id": "backup-and-recovery-with-wal-g-and-rclone",
  "url": "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/backup-and-recovery-with-wal-g-and-rclone.html",
  "title": "Резервное копирование и восстановление баз данных с помощью WAL-G и Rclone",
  "breadcrumbs": [
    "ELMA365 On-Premises"
  ],
  "section": "ELMA365 On-Premises | [business_solutions]",
  "html": "<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n<title>Резервное копирование и восстановление баз данных с помощью WAL-G и Rclone </title>\n<meta content=\"Help+Manual\" name=\"generator\"/>\n<meta content=\"\" name=\"keywords\"/>\n<meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\"/>\n<meta content=\"IE=edge\" http-equiv=\"X-UA-Compatible\"/>\n<meta content=\"width=device-width, initial-scale=1.0\" name=\"viewport\"/>\n<meta content=\"Вы можете настроить резервное копирование и восстановление данных ELMA365 с помощью следующих программ:\" name=\"description\"/>\n<meta content=\"\" name=\"picture\"/>\n<meta content=\"website\" property=\"og:type\"/>\n<meta content=\"Cправка по Low-code платформе ELMA365\" property=\"og:title\"/>\n<meta content=\"https://elma365.com/ru/help\" property=\"og:url\"/>\n<meta content=\"\" property=\"og:image\"/>\n<meta content=\"ELMA365\" property=\"og:site_name\"/>\n<link href=\"favicon.png\" rel=\"icon\" type=\"image/png\"/>\n<link href=\"https://elma365.com/ru/help/platform/backup-and-recovery-with-wal-g-and-rclone.html\" rel=\"canonical\"/>\n<link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap\" rel=\"stylesheet\"/>\n<link href=\"./jquery-ui.min.css\" rel=\"stylesheet\"/>\n<link href=\"default.css\" rel=\"stylesheet\"/>\n<link href=\"./search-yandex.css\" rel=\"stylesheet\"/>\n<link href=\"./article.css\" rel=\"stylesheet\"/>\n<link href=\"./glossary.css\" rel=\"stylesheet\"/>\n<link href=\"./theme.css\" rel=\"stylesheet\"/>\n<link href=\"./tooltipster.bundle.min.css\" rel=\"stylesheet\" type=\"text/css\"/>\n<script src=\"jquery.js\" type=\"text/javascript\"></script>\n<script src=\"./tooltipster.bundle.min.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n        $(document).ready($('.tooltip').tooltipster({\n            contentCloning: true,\n            theme: 'tooltipster-borderless',\n        }));\n    </script>\n<script src=\"helpman_settings.js\" type=\"text/javascript\"></script>\n<script src=\"helpman_topicinit.js\" type=\"text/javascript\"></script>\n<script src=\"highlight.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n     $(document).ready(function(){highlight();});\n   </script>\n</head>\n<body>\n<script async=\"\" src=\"https://www.googletagmanager.com/gtag/js?id=G-M6ETBEC1R9\"></script><script>window.dataLayer=window.dataLayer || []; function gtag(){dataLayer.push(arguments);}gtag('js', new Date()); gtag('config', 'G-M6ETBEC1R9');</script>\n<script>!function(e,t,c,n,r,a,m){e.ym=e.ym||function(){(e.ym.a=e.ym.a||[]).push(arguments)},e.ym.l=1*new Date;for(var s=0;s<document.scripts.length;s++)if(document.scripts[s].src===n)return;a=t.createElement(c),m=t.getElementsByTagName(c)[0],a.async=1,a.src=n,m.parentNode.insertBefore(a,m)}(window,document,\"script\",\"https://mc.yandex.ru/metrika/tag.js\"),ym(83179930,\"init\",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0})</script><noscript><div><img alt=\"\" src=\"https://mc.yandex.ru/watch/83179930\" style=\"position:absolute;left:-9999px\"/></div></noscript> \n    \n    ﻿<header class=\"header elma-365\">\n<div class=\"container\">\n<div class=\"nav-container\">\n<div class=\"nav-wrap\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<div class=\"header__navi\">\n<ul class=\"header__list\"><li><span class=\"solution-select\"><span class=\"solution-select__selected\"></span><svg fill=\"none\" height=\"4\" viewbox=\"0 0 7 4\" width=\"7\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M1 1L3.5 3.5L6 1\" stroke=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg><ul class=\"solution-select__list\"><li class=\"header__list-item\"><a class=\"project-link\" href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">CSP</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/crm/crm-functions.html\">CRM+CX</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/kedo/kedo.html\">КЭДО</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/business_solutions/-elma365-store.html\">Бизнес-решения</a></li><ul class=\"social-links-header\"><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://elma-academy.com/ru/\" target=\"_blank\">Academy</a></li><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://community.elma365.com/ru/\" target=\"_blank\">Community</a></li><li></li></ul></ul></span></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://tssdk.elma365.com/latest/\" target=\"_blank\">SDK</a></li><li class=\"header__list-item header__list-item-latest\"><a class=\"header__list-item-url header__list-item-last\" href=\"https://elma365.com/ru/\" target=\"_blank\">Сайт ELMA365</a></li></ul>\n<div class=\"hero-wrap\" style=\"display: flex; align-items: center;\">\n<div class=\"hero__search\" style=\"display: flex; justify-content: space-between; width: 100%; padding-left: 0;\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<button class=\"hero__search-icon\" id=\"search-icon\">\n<img alt=\"search string\" src=\"search-icon-white.svg\"/>\n</button>\n<div class=\"hero__search-form\" id=\"search-panel\"><form class=\"search-form\"><label class=\"search-form__label\"><span class=\"search__icon\" id=\"reset-search\" src=\"Union.svg\"></span><input class=\"search-form__input\" type=\"text\"/></label><input class=\"search-form__submit\" type=\"submit\" value=\"Submit\"/></form></div>\n</div>\n</div>\n</div>\n</div>\n<a class=\"hero__side-icon\" href=\"#\" id=\"side-menu-icon\">\n<img alt=\"side menu\" src=\"side_menu.svg\"/>\n</a>\n</div>\n</div>\n</header>\n<main class=\"main container\">\n<aside class=\"sidebar\" id=\"sidebar\">\n<div class=\"sidebar__header\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img src=\"./logo-light.svg\"/>\n</a>\n<span class=\"sidebar__close elma-365-close\" id=\"close\"></span>\n</div>\n<div class=\"sidebar__wrapper\" id=\"side-menu\">\n</div>\n</aside>\n<article class=\"article\" id=\"article\">\n<div class=\"article-inner\">\n<div class=\"content\">\n<header class=\"article__header\">\n<div class=\"article__bread\" style=\"display:flex; gap:8px;\">\n<span class=\"search-res__item-category search-res__item-category_subcategory subcategory article__badge\" id=\"subcategory\"></span>\n<nav class=\"topic__breadcrumbs\">\n<p><a href=\"elma365-on-premises.html\">ELMA365 On-Premises</a> &gt; Администрирование ELMA365 Enterprise / Резервное копирование и восстановление баз данных с помощью WAL-G и Rclone </p>\n</nav>\n</div>\n<div class=\"topic__title\"><h1 class=\"p_Heading1\"><span class=\"f_Heading1\">Резервное копирование и восстановление баз данных с помощью WAL-G и Rclone </span></h1>\n</div>\n</header>\n<section class=\"article__content\">\n<div class=\"scroll-top-inner\">\n<a class=\"scroll-top\" href=\"#h1-article\"></a>\n</div>\n<!-- Placeholder for topic body. -->\n<p class=\"p_Normal\">Вы можете настроить резервное копирование и восстановление данных ELMA365 с помощью следующих программ:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">WAL-G — это утилита для создания резервных копий и восстановления баз данных, которая поддерживает несколько СУБД, включая <a class=\"topiclink\" href=\"backup-and-recovery-with-wal-g-and-rclone.html#wal-g-in-postgres\">PostgreSQL</a> и <a class=\"topiclink\" href=\"backup-and-recovery-with-wal-g-and-rclone.html#wal-g-in-mongo\">MongoDB</a>.<br/>\n <br/>\nОна использует механизм непрерывного архивирования (Continuous Archiving) и точки восстановления (Point-in-Time Recovery, PITR) для обеспечения надёжной архивации и восстановления данных.<br/>\n <br/>\nWAL-G поддерживает хранение резервных копий в различных облачных хранилищах, таких как Amazon S3, Google Cloud Storage, Azure Blob Storage и других;</li><li class=\"p_Normal\"><a class=\"topiclink\" href=\"backup-and-recovery-with-wal-g-and-rclone.html#rclone\">Rclone</a> — это многопоточная программа с открытым исходным кодом и командной строкой для управления контентом. Позволяет переносить данные в облако и другие хранилища. </li></ul>\n<p class=\"p_Normal\">В статье описан процесс резервного копирования и восстановления PostgreSQL 15 и MongoDB 6 в ОС Ubuntu Linux 22.04.</p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"wal-g-in-postgres\"></a><span class=\"f_Heading2\">Настройка WAL-G для PostgreSQL</span></h2>\n<p class=\"p_Normal\">С помощью WAL-G вы можете:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">выполнить резервное копирование данных;</li><li class=\"p_Normal\"><a class=\"topiclink\" href=\"backup-and-recovery-with-wal-g-and-rclone.html#psql-restore\">восстановить данные из резервной копии</a>.</li></ul>\n<h3 class=\"p_Heading3\"><span class=\"f_Heading3\">Резервное копирование для PostgreSQL</span></h3>\n<p class=\"p_Normal\">Для резервного копирования данных с помощью WAL-G выполните следующие действия:</p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Предварительно установите WAL-G с <a class=\"weblink\" href=\"https://github.com/wal-g/wal-g\" target=\"_blank\">официального GitHub-репозитория</a>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">wget https://github.com/wal-g/wal-g/releases/download/v3.0.5/wal-g-pg-ubuntu-22.04-amd64.tar.gz</span><br/>\n<span class=\"f_CodeExample\">tar -xzf wal-g-pg-ubuntu-22.04-amd64.tar.gz </span><br/>\n<span class=\"f_CodeExample\">sudo mv wal-g-pg-ubuntu-22.04-amd64 /usr/local/bin/wal-g-pg</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Настройте переменные окружения для доступа к облачному хранилищу. Для этого откройте файл конфигурации <code><b>/etc/postgresql/15/main/.walg.json</b></code> и добавьте следующие параметры:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">{</span><br/>\n<span class=\"f_CodeExample\">\"WALG_S3_PREFIX\": \"s3://elma365-backup/postgres\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_ENDPOINT\": \"https://storage.yandexcloud.net\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_ACCESS_KEY_ID\": \"&lt;your-access-key-id&gt;\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_SECRET_ACCESS_KEY\": \"&lt;your-secret-access-key&gt;\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_REGION\": \"us-east-1\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_S3_FORCE_PATH_STYLE\": \"true\",</span><br/>\n<span class=\"f_CodeExample\">\"WALG_COMPRESSION_METHOD\": \"brotli\",</span><br/>\n<span class=\"f_CodeExample\">\"WALG_DELTA_MAX_STEPS\": \"6\",</span><br/>\n<span class=\"f_CodeExample\">\"PGHOST\": \"/var/run/postgresql\",</span><br/>\n<span class=\"f_CodeExample\">\"PGDATA\": \"/var/lib/postgresql/15/main\",</span><br/>\n<span class=\"f_CodeExample\">\"PGSSLMODE\": \"disable\"</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 37px;\">Где:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><code><b>WALG_S3_PREFIX</b></code>  — путь к хранилищу S3, где будут храниться резервные копии и <span style=\"font-weight: bold;\">.WAL</span>-файлы (Write-Ahead Logs);</li><li class=\"p_Normal\"><code><b>AWS_ENDPOINT</b></code> — точка доступа (endpoint) для S3-совместимого хранилища;</li><li class=\"p_Normal\"><code><b>AWS_ACCESS_KEY_ID</b></code> — идентификатор ключа доступа (Access Key ID) для аутентификации в S3-совместимом хранилище;</li><li class=\"p_Normal\"><code><b>AWS_SECRET_ACCESS_KEY</b></code> — секретный ключ (Secret Access Key) для аутентификации в S3-совместимом хранилище;</li><li class=\"p_Normal\"><code><b>AWS_REGION</b></code> — регион, в котором находится S3-совместимое хранилище;</li><li class=\"p_Normal\"><code><b>AWS_S3_FORCE_PATH_STYLE</b></code>  — указывает, что нужно использовать path-style для доступа к S3-бакетам;</li><li class=\"p_Normal\"><code><b>WALG_COMPRESSION_METHOD</b></code>  — метод сжатия, используемый для резервных копий. В данном случае используется алгоритм <code><b>Brotli</b></code>, который обеспечивает хорошее соотношение между степенью сжатия и скоростью;</li><li class=\"p_Normal\"><code><b>WALG_DELTA_MAX_STEPS</b></code>  — максимальное количество шагов (delta steps), которые WAL-G может использовать для постепенно увеличивающихся (дельта) резервных копий. Позволяет экономить место, храня только изменения между резервными копиями;</li><li class=\"p_Normal\"><code><b>PGHOST</b></code> — путь к сокету PostgreSQL, через который WAL-G будет подключаться к базе данных. Используется для выполнения команд, требующих подключения к PostgreSQL;</li><li class=\"p_Normal\"><code><b>PGDATA</b></code> — путь к каталогу данных PostgreSQL. WAL-G использует этот параметр для определения, где находятся данные PostgreSQL, чтобы корректно выполнять резервное копирование и восстановление;</li><li class=\"p_Normal\"><code><b>PGSSLMODE</b></code> — указывает, что SSL/TLS-шифрование для подключения к PostgreSQL отключено. Это может быть полезно для локальных подключений, где шифрование не требуется.</li></ul>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Измените владельца файла:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">chown postgres: /etc/postgresql/15/main/.walg.json</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"4\">Чтобы использовать WAL-G, настройте PostgreSQL для работы с непрерывным архивированием. Для этого откройте файл конфигурации <code><b>/etc/postgresql/15/main/postgresql.conf</b></code> и добавьте следующие параметры:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">archive_mode = on</span><br/>\n<span class=\"f_CodeExample\">archive_timeout = 600s</span><br/>\n<span class=\"f_CodeExample\">archive_command = '/usr/local/bin/wal-g-pg wal-push \"%p\" --config /etc/postgresql/15/main/.walg.json &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1'</span><br/>\n<span class=\"f_CodeExample\">wal_level = replica</span><br/>\n<span class=\"f_CodeExample\">restore_command = '/usr/local/bin/wal-g-pg wal-fetch \"%f\" \"%p\" --config /etc/postgresql/15/main/.walg.json &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1'</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"5\">Для создания полной резервной копии базы данных выполните команду:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres /usr/local/bin/wal-g-pg backup-push --config /etc/postgresql/15/main/.walg.json /var/lib/postgresql/15/main/</span></p>\n<h3 class=\"p_Heading3\"><a class=\"hmanchor\" id=\"psql-restore\"></a><span class=\"f_Heading3\">Восстановление данных для PostgreSQL</span></h3>\n<p class=\"p_Normal\"><span style=\"font-weight: bold;\">Важно</span>: восстановление из резервной копии должно производиться в пустую базу данных. Предварительно убедитесь, что у вас есть резервная копия удаляемой БД. Только после этого приступайте к удалению. Подробнее о подготовке к восстановлению читайте в статье <a class=\"topiclink\" href=\"postgresql.html#prepare-to-recovery\">«PostgreSQL»</a>.</p>\n<p class=\"p_Normal\">Для восстановления базы данных из резервной копии с помощью WAL-G: </p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Остановите PostgreSQL, если он запущен:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo systemctl stop postgresql</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Переместите или удалите содержимое директории <code><b>/var/lib/postgresql/15/main</b></code>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo mv /var/lib/postgresql/15/main /var/lib/postgresql/15/main_old</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Создайте пустую директорию для восстановления:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo mkdir /var/lib/postgresql/15/main</span><br/>\n<span class=\"f_CodeExample\">sudo chown postgres:postgres /var/lib/postgresql/15/main</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"4\">Для просмотра списка резервных копий баз данных выполните команду:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres /usr/local/bin/wal-g-pg backup-list --config /etc/postgresql/15/main/.walg.json</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"5\">Выполните команду восстановления:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres /usr/local/bin/wal-g-pg backup-fetch /var/lib/postgresql/15/main LATEST --config /etc/postgresql/15/main/.walg.json</span></p>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 36px;\">Здесь <code><b>LATEST</b></code> указывает на последнюю резервную копию. Вы также можете ввести наименование нужной копии, полученной из списка на предыдущем шаге, например, <span style=\"font-weight: bold;\">base_000000010000000000000009</span>.</p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"6\">Запустите PostgreSQL:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo systemctl start postgresql</span></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"wal-g-in-mongo\"></a><span class=\"f_Heading2\">Настройка WAL-G для MongoDB</span></h2>\n<p class=\"p_Normal\">С помощью WAL-G вы можете:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">выполнить резервное копирование данных;</li><li class=\"p_Normal\"><a class=\"topiclink\" href=\"backup-and-recovery-with-wal-g-and-rclone.html#mongo-restore\">восстановить данные из резервной копии</a>.</li></ul>\n<h3 class=\"p_Heading3\"><span class=\"f_Heading3\">Резервное копирование для MongoDB</span></h3>\n<p class=\"p_Normal\">Для резервного копирования данных с помощью WAL-G выполните следующие действия:</p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Предварительно установите WAL-G с <a class=\"weblink\" href=\"https://github.com/wal-g/wal-g\" target=\"_blank\">официального GitHub-репозитория</a>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">wget https://github.com/wal-g/wal-g/releases/download/v3.0.5/wal-g-mongo-ubuntu-22.04-amd64.tar.gz</span><br/>\n<span class=\"f_CodeExample\">tar -xzf wal-g-mongo-ubuntu-22.04-amd64.tar.gz</span><br/>\n<span class=\"f_CodeExample\">sudo mv wal-g-mongo-ubuntu-22.04-amd64 /usr/local/bin/wal-g-mongo</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Настройте переменные окружения для доступа к облачному хранилищу. Откройте файл конфигурации <code><b>/home/user/.walg.json</b></code> и добавьте следующие параметры:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">{</span><br/>\n<span class=\"f_CodeExample\">\"WALG_S3_PREFIX\": \"s3://elma365-backup/mongo\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_ENDPOINT\": \"https://storage.yandexcloud.net\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_ACCESS_KEY_ID\": \"&lt;your-access-key-id&gt;\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_SECRET_ACCESS_KEY\": \"&lt;your-secret-access-key&gt;\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_REGION\": \"us-east-1\",</span><br/>\n<span class=\"f_CodeExample\">\"AWS_S3_FORCE_PATH_STYLE\": \"true\",</span><br/>\n<span class=\"f_CodeExample\">\"WALG_COMPRESSION_METHOD\": \"brotli\",</span><br/>\n<span class=\"f_CodeExample\">\"MONGODB_URI\": \"mongodb://superuser:SecretPassword@mongodb-server.your_domain:27017/?authSource=admin&amp;connect=direct&amp;socketTimeoutMS=60000&amp;connectTimeoutMS=10000\",</span><br/>\n<span class=\"f_CodeExample\">\"WALG_STREAM_CREATE_COMMAND\": \"mongodump --archive --oplog --uri='mongodb://superuser:SecretPassword@mongodb-server.your_domain:27017/?authSource=admin&amp;connectTimeoutMS=10000'\",</span><br/>\n<span class=\"f_CodeExample\">\"WALG_STREAM_RESTORE_COMMAND\": \"mongorestore --archive --oplogReplay --uri='mongodb://superuser:SecretPassword@mongodb-server.your_domain:27017/?authSource=admin&amp;connectTimeoutMS=10000'\"</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 37px;\">Где:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><code><b>WALG_S3_PREFIX</b></code> — путь к S3, где будут храниться резервные копии и <span style=\"font-weight: bold;\">.WAL</span>-файлы (Write-Ahead Logs);</li><li class=\"p_Normal\"><code><b>AWS_ENDPOINT</b></code> — точка доступа (endpoint) для S3-совместимого хранилища;</li><li class=\"p_Normal\"><code><b>AWS_ACCESS_KEY_ID</b></code> — идентификатор ключа доступа (Access Key ID) для аутентификации в S3-совместимом хранилище;</li><li class=\"p_Normal\"><code><b>AWS_SECRET_ACCESS_KEY</b></code> — секретный ключ (Secret Access Key) для аутентификации в S3-совместимом хранилище;</li><li class=\"p_Normal\"><code><b>AWS_REGION</b></code> — регион, в котором находится S3-совместимое хранилище;</li><li class=\"p_Normal\"><code><b>AWS_S3_FORCE_PATH_STYLE</b></code> — указывает, что нужно использовать path-style для доступа к S3-бакетам;</li><li class=\"p_Normal\"><code><b>WALG_COMPRESSION_METHOD</b></code> — метод сжатия, используемый для резервных копий. В данном случае используется алгоритм <code><b>Brotli</b></code>, который обеспечивает хорошее соотношение между степенью сжатия и скоростью;</li><li class=\"p_Normal\"><code><b>MONGODB_URI</b></code> — URI для подключения к MongoDB;</li><li class=\"p_Normal\"><code><b>WALG_STREAM_CREATE_COMMAND</b></code> — команда, используемая WAL-G для создания резервной копии MongoDB;</li><li class=\"p_Normal\"><code><b>ALG_STREAM_RESTORE_COMMAND</b></code> — команда, используемая WAL-G для восстановления резервной копии MongoDB.</li></ul>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Для создания полной резервной копии баз данных выполните команду:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">/usr/local/bin/wal-g-mongo backup-push --config /home/user/.walg.json</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"4\">Для просмотра списка резервных копий баз данных выполните команду:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">/usr/local/bin/wal-g-mongo backup-list --config /home/user/.walg.json</span></p>\n<h3 class=\"p_Heading3\"><a class=\"hmanchor\" id=\"mongo-restore\"></a><span class=\"f_Heading3\">Восстановление данных для MongoDB</span></h3>\n<p class=\"p_Normal\"><span style=\"font-weight: bold;\">Важно</span>: восстановление из резервной копии должно производиться в пустую базу данных. Предварительно убедитесь, что у вас есть резервная копия удаляемой базы данных. Только после этого приступайте к удалению БД. Подробнее о подготовке к восстановлению читайте в статье <a class=\"topiclink\" href=\"mongodb.html#prepare-to-recovery\">«MongoDB»</a>.</p>\n<p class=\"p_Normal\">Чтобы восстановить базу данных из резервной копии, используйте команду:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">/usr/local/bin/wal-g-mongo backup-fetch LATEST --config /home/user/.walg.json</span></p>\n<p class=\"p_Normal\">Здесь <code><b>LATEST</b></code> указывает на последнюю резервную копию. Вы также можете указать наименование нужной копии, полученной из списка на предыдущем шаге, например, <span style=\"font-weight: bold;\">stream_20250214T093724Z</span>.</p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"rclone\"></a><span class=\"f_Heading2\">Настройка Rclone</span></h2>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Установите Rclone с помощью команды:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -v ; curl https://rclone.org/install.sh | sudo bash</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Настройте Rclone для работы с S3:</li></ol>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"1\">Запустите команду для настройки нового S3-хранилища:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">rclone config</span></p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"2\">В открывшемся окне выберите опцию <span style=\"font-weight: bold;\">n</span> для создания нового хранилища.</li><li class=\"p_Normal\" value=\"3\">Введите имя для вашего хранилища. Например <span style=\"font-weight: bold;\">source-s3</span> для исходного хранилища и <span style=\"font-weight: bold;\">backup-s3</span> для целевого.</li><li class=\"p_Normal\" value=\"4\">Выберите тип хранилища <span style=\"font-weight: bold;\">s3</span>. </li><li class=\"p_Normal\" value=\"5\">Выберите провайдера <span style=\"font-weight: bold;\">Other</span>.  </li><li class=\"p_Normal\" value=\"6\">Введите параметры доступа к вашему S3-хранилищу:</li></ol>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><code><b>access_key_id</b></code> — ваш идентификатор ключа доступа;</li><li class=\"p_Normal\"><code><b>secret_access_key</b></code> — ваш секретный ключ;</li><li class=\"p_Normal\"><code><b>region</b></code> — регион вашего S3-хранилища;</li><li class=\"p_Normal\"><code><b>endpoint</b></code> — точка доступа S3-хранилища.</li></ul>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"7\">Повторите шаги для настройки второго S3-хранилища.</li></ol>\n<ol start=\"3\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Скопируйте данные из одного S3-хранилища в другое с помощью команды <code><b>rclone copy</b></code>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">rclone copy source-s3:bucket-name/path backup-s3:backup-bucket-name/path -v --ignore-errors --fast-list --checksum</span></p>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 32px;\">Где:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><code><b>source-s3</b></code> — имя удалённого хранилища, настроенного для исходного S3;</li><li class=\"p_Normal\"><code><b>bucket-name/path</b></code> — имя бакета и путь к данным в исходном хранилище;</li><li class=\"p_Normal\"><code><b>backup-s3</b></code> — имя удалённого хранилища, настроенного для целевого S3;</li><li class=\"p_Normal\"><code><b>backup-bucket-name/path</b></code> — имя бакета и путь для резервной копии в целевом хранилище;</li><li class=\"p_Normal\"><code><b>-v</b></code> — включает подробный вывод (verbose mode);</li><li class=\"p_Normal\"><code><b>--ignore-errors</b></code> — игнорирует ошибки, возникающие во время выполнения команды;</li><li class=\"p_Normal\"><code><b>--fast-list</b></code> — ускоряет процесс создания списка файлов и директорий, особенно при работе с облачными хранилищами, такими как S3, Google Drive и другими;</li><li class=\"p_Normal\"><code><b>--checksum</b></code> — включает проверку контрольных сумм (хешей) файлов при копировании или синхронизации.</li></ul>\n<div class=\"bottom-nav\">\n<a class=\"topic__navi_prev\" href=\"database-backup-and-recovery.html\" id=\"prev-link\">\n<span class=\"bottom-nav__arrow bottom-nav__arrow--prev\"></span> <span class=\"bottom-nav__link\">database-backup-and-recovery.html</span>\n</a>\n<a class=\"topic__navi_next\" href=\"dump_db.html\" id=\"next-link\">\n<span class=\"bottom-nav__link\">dump_db.html</span> <span class=\"bottom-nav__arrow bottom-nav__arrow--next\"></span>\n</a>\n</div>\n<!-- добавляет на страницу строку блок Была ли статья полезной?  -->\n<div class=\"feedback-wrap\"><div class=\"feedback\" id=\"feedback\"><span><b>Была ли статья полезной?</b></span><form action=\"\" class=\"feedback-form\" id=\"feedback-form\" method=\"POST\"><div class=\"feedback__popup feedback__popup-response\" id=\"feedback__popup_thx\">Спасибо за ваш отзыв!</div><div id=\"feedback-success-popup\"><div class=\"wrap\"><button class=\"feedback-popup-close\" type=\"button\">×</button><svg fill=\"none\" height=\"44\" viewbox=\"0 0 44 44\" width=\"44\" xmlns=\"http://www.w3.org/2000/svg\"><g clip-path=\"url(#clip0_212_2187)\"><path d=\"M22 0.6875C10.2294 0.6875 0.6875 10.2294 0.6875 22C0.6875 33.7706 10.2294 43.3125 22 43.3125C33.7706 43.3125 43.3125 33.7706 43.3125 22C43.3125 10.2294 33.7706 0.6875 22 0.6875ZM22 40.5625C11.8023 40.5625 3.4375 32.3078 3.4375 22C3.4375 11.8024 11.6922 3.4375 22 3.4375C32.1977 3.4375 40.5625 11.6922 40.5625 22C40.5625 32.1976 32.3078 40.5625 22 40.5625ZM34.1713 16.933L18.6613 32.3186C18.257 32.7197 17.604 32.7171 17.203 32.3128L9.82283 24.873C9.42176 24.4686 9.42434 23.8157 9.82867 23.4146L10.5609 22.6884C10.9652 22.2873 11.6181 22.2899 12.0192 22.6942L17.9468 28.6697L31.9926 14.7366C32.3969 14.3356 33.0498 14.3382 33.4509 14.7425L34.1772 15.4747C34.5783 15.879 34.5757 16.532 34.1713 16.933Z\" fill=\"#27AE60\"></path></g><defs><clippath id=\"clip0_212_2187\"><rect fill=\"white\" height=\"44\" width=\"44\"></rect></clippath></defs></svg><p>Ваш отзыв успешно отправлен!</p><span>Спасибо за обратную связь.</span></div></div><div class=\"feedback__popup\" id=\"feedback__popup_why\"><button class=\"feedback-popup-close\" type=\"button\">×</button><div class=\"feedback__popup-header\">Уточните, почему:</div><input id=\"bad_recommendation\" name=\"category\" type=\"radio\" value=\"bad_recommendation\"/><label for=\"bad_recommendation\">Рекомендации не помогли</label><input id=\"difficult_text\" name=\"category\" type=\"radio\" value=\"difficult_text\"/><label for=\"difficult_text\">Текст трудно понять</label><input id=\"no_answer\" name=\"category\" type=\"radio\" value=\"no_answer\"/><label for=\"no_answer\">Нет ответа на мой вопрос</label><input id=\"bad_header\" name=\"category\" type=\"radio\" value=\"bad_header\"/><label for=\"bad_header\">Содержание статьи не соответствует заголовку</label><input id=\"other_reason\" name=\"category\" type=\"radio\" value=\"other_reason\"/><label for=\"other_reason\">Другая причина</label></div><div class=\"feedback__popup\" id=\"feedback__popup-other\"><button class=\"feedback-popup-close\" type=\"button\">×</button> <div class=\"feedback__popup-header\">Расскажите, что вам не понравилось в статье:</div><textarea class=\"feedback__textarea\" id=\"\" name=\"other\"></textarea><input class=\"feedback__other-btn\" type=\"submit\" value=\"Отправить\"/></div><div class=\"feedback-form__btn-group\"><input id=\"feedback__useful_yes\" name=\"useful\" type=\"radio\" value=\"true\"/><label for=\"feedback__useful_yes\"><img src=\"like.svg\"/><span class=\"feedback-form__btn-group_yes-btn\">Да</span></label><input id=\"feedback__useful_no\" name=\"useful\" type=\"radio\" value=\"false\"/><label for=\"feedback__useful_no\"><img src=\"dislike.svg\"/><span class=\"feedback-form__btn-group_no-btn\">Нет</span></label></div><select name=\"category\"><option disabled=\"\">Выберите вариант</option><option selected=\"\" value=\"bad_recommendation\">Рекомендации не помогли</option><option value=\"difficult_text\">Текст трудно понять</option><option value=\"no_answer\">Нет ответа на мой вопрос</option><option value=\"bad_header\">Содержание статьи не соответствует заголовку</option><option value=\"other_reason\">Другая причина</option></select><input type=\"submit\"/></form></div></div>\n</section>\n</div>\n<aside class=\"article__sidebar\" style=\"display:none\">\n<input type=\"checkbox\"/>\n<div class=\"article__arrow\"></div>\n<div class=\"table-of-contents elma365-right\" id=\"toc2Content\">\n<h3 class=\"h3-toc\">В этой статье</h3>\n<nav id=\"toc2\"></nav>\n</div>\n</aside>\n</div>\n</article>\n</main>\n<footer class=\"footer\">\n<div class=\"footer-container\">\n<div class=\"footer-mobile\">\n<ul class=\"footer-mobile__list\"><li><a href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li><a href=\"https://tssdk.elma365.com/\" target=\"_blank\">TS SDK</a></li><li><a href=\"https://community.elma365.com/\" target=\"_blank\">Community</a></li><li><a href=\"https://elma-academy.com/ru/elma365\" target=\"_blank\">Академия</a></li></ul><ul class=\"footer-mobile__list\"><li><a href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">ECM</a></li><li><a href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li></ul>\n</div>\n<div class=\"container\">\n<div class=\"footer-wrap\">\n<div><span class=\"mobile-question-popup\">Отправить фидбэк</span><form action=\"\" class=\"question__popup question-xs\" id=\"question__popup\" method=\"POST\"><div class=\"question-wrap\"><span class=\"close\"></span><span class=\"title\">Задать вопрос</span><label for=\"help_question\" style=\"display: none;\"></label><textarea id=\"help_question\" name=\"help_question\"></textarea><input type=\"submit\" value=\"Отправить\"/></div></form><div class=\"hidden fade-in question-success-xs\">Ваш фидбэк отправлен.</div></div>\n<div class=\"footer-flex-b\">\n<div class=\"footer-top\">\n<span class=\"footer-copy\">© 2025 \n              ELMA365\n            \n            \n          </span>\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</div>\n<div class=\"footer-line\">\n<div class=\"footer-line-copy\">\n<span class=\"footer-copy\">© 2025 \n                  ELMA365\n                \n                \n              </span>\n</div>\n<ul class=\"footer-list\">\n<li class=\"footer-item footer-url-elma\"><a class=\"footer-link footer-url-link-elma\" href=\"https://elma365.com/ru/\" style=\"color: #0D4A75;\" target=\"_blank\"><img alt=\"browse icon\" class=\"footer-img footer-img-elma-url\" src=\"browse.svg\"/>elma365.com</a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vkvideo.ru/@elma_bpm\" target=\"_blank\"><img alt=\"vk-video icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk-video.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vk.com/elma_bpm\" target=\"_blank\"><img alt=\"vk icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://t.me/elmaday\" target=\"_blank\"><img alt=\"telegram icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"telegram.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://dzen.ru/elma\" target=\"_blank\"><img alt=\"dzen icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"social_dzen.svg\" width=\"20\"/></a></li>\n<li class=\"footer-item sk-footer-img\">\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<a class=\"arrow-top\" href=\"#\"></a>\n</div>\n</footer>\n<!--    <script type=\"text/javascript\" src=\"jquery1.min.js\"></script>-->\n<iframe name=\"hmnavigation\" style=\"display:none!important\"></iframe>\n<!--<script src=\"./jquery-ui.js\"></script> -->\n<script src=\"./jquery-ui.min.js\"></script>\n<!--script src=\"//cdn.jsdelivr.net/npm/featherlight@1.7.14/release/featherlight.min.js\" type=\"text/javascript\" charset=\"utf-8\"></script-->\n<script src=\"./jquery.tocify.min.js\"></script>\n<script src=\"./TypoReporter.min.js\"></script>\n<script src=\"./google-search.js\"></script>\n<script src=\"./main.js\"></script>\n</body>\n</html>\n",
  "plain_text": "Резервное копирование и восстановление баз данных с помощью WAL-G и Rclone ﻿ Платформа CSP CRM+CX Проекты Service КЭДО Бизнес-решения Academy Community API SDK Сайт ELMA365 ELMA365 On-Premises > Администрирование ELMA365 Enterprise / Резервное копирование и восстановление баз данных с помощью WAL-G и Rclone Резервное копирование и восстановление баз данных с помощью WAL-G и Rclone Вы можете настроить резервное копирование и восстановление данных ELMA365 с помощью следующих программ: WAL-G — это утилита для создания резервных копий и восстановления баз данных, которая поддерживает несколько СУБД, включая PostgreSQL и MongoDB . Она использует механизм непрерывного архивирования (Continuous Archiving) и точки восстановления (Point-in-Time Recovery, PITR) для обеспечения надёжной архивации и восстановления данных. WAL-G поддерживает хранение резервных копий в различных облачных хранилищах, таких как Amazon S3, Google Cloud Storage, Azure Blob Storage и других; Rclone — это многопоточная программа с открытым исходным кодом и командной строкой для управления контентом. Позволяет переносить данные в облако и другие хранилища. В статье описан процесс резервного копирования и восстановления PostgreSQL 15 и MongoDB 6 в ОС Ubuntu Linux 22.04. Настройка WAL-G для PostgreSQL С помощью WAL-G вы можете: выполнить резервное копирование данных; восстановить данные из резервной копии . Резервное копирование для PostgreSQL Для резервного копирования данных с помощью WAL-G выполните следующие действия: Предварительно установите WAL-G с официального GitHub-репозитория : wget https://github.com/wal-g/wal-g/releases/download/v3.0.5/wal-g-pg-ubuntu-22.04-amd64.tar.gz tar -xzf wal-g-pg-ubuntu-22.04-amd64.tar.gz sudo mv wal-g-pg-ubuntu-22.04-amd64 /usr/local/bin/wal-g-pg Настройте переменные окружения для доступа к облачному хранилищу. Для этого откройте файл конфигурации /etc/postgresql/15/main/.walg.json и добавьте следующие параметры: { \"WALG_S3_PREFIX\": \"s3://elma365-backup/postgres\", \"AWS_ENDPOINT\": \"https://storage.yandexcloud.net\", \"AWS_ACCESS_KEY_ID\": \"<your-access-key-id>\", \"AWS_SECRET_ACCESS_KEY\": \"<your-secret-access-key>\", \"AWS_REGION\": \"us-east-1\", \"AWS_S3_FORCE_PATH_STYLE\": \"true\", \"WALG_COMPRESSION_METHOD\": \"brotli\", \"WALG_DELTA_MAX_STEPS\": \"6\", \"PGHOST\": \"/var/run/postgresql\", \"PGDATA\": \"/var/lib/postgresql/15/main\", \"PGSSLMODE\": \"disable\" } Где: WALG_S3_PREFIX — путь к хранилищу S3, где будут храниться резервные копии и .WAL -файлы (Write-Ahead Logs); AWS_ENDPOINT — точка доступа (endpoint) для S3-совместимого хранилища; AWS_ACCESS_KEY_ID — идентификатор ключа доступа (Access Key ID) для аутентификации в S3-совместимом хранилище; AWS_SECRET_ACCESS_KEY — секретный ключ (Secret Access Key) для аутентификации в S3-совместимом хранилище; AWS_REGION — регион, в котором находится S3-совместимое хранилище; AWS_S3_FORCE_PATH_STYLE — указывает, что нужно использовать path-style для доступа к S3-бакетам; WALG_COMPRESSION_METHOD — метод сжатия, используемый для резервных копий. В данном случае используется алгоритм Brotli , который обеспечивает хорошее соотношение между степенью сжатия и скоростью; WALG_DELTA_MAX_STEPS — максимальное количество шагов (delta steps), которые WAL-G может использовать для постепенно увеличивающихся (дельта) резервных копий. Позволяет экономить место, храня только изменения между резервными копиями; PGHOST — путь к сокету PostgreSQL, через который WAL-G будет подключаться к базе данных. Используется для выполнения команд, требующих подключения к PostgreSQL; PGDATA — путь к каталогу данных PostgreSQL. WAL-G использует этот параметр для определения, где находятся данные PostgreSQL, чтобы корректно выполнять резервное копирование и восстановление; PGSSLMODE — указывает, что SSL/TLS-шифрование для подключения к PostgreSQL отключено. Это может быть полезно для локальных подключений, где шифрование не требуется. Измените владельца файла: chown postgres: /etc/postgresql/15/main/.walg.json Чтобы использовать WAL-G, настройте PostgreSQL для работы с непрерывным архивированием. Для этого откройте файл конфигурации /etc/postgresql/15/main/postgresql.conf и добавьте следующие параметры: archive_mode = on archive_timeout = 600s archive_command = '/usr/local/bin/wal-g-pg wal-push \"%p\" --config /etc/postgresql/15/main/.walg.json >> /var/log/postgresql/archive_command.log 2>&1' wal_level = replica restore_command = '/usr/local/bin/wal-g-pg wal-fetch \"%f\" \"%p\" --config /etc/postgresql/15/main/.walg.json >> /var/log/postgresql/restore_command.log 2>&1' Для создания полной резервной копии базы данных выполните команду: sudo -u postgres /usr/local/bin/wal-g-pg backup-push --config /etc/postgresql/15/main/.walg.json /var/lib/postgresql/15/main/ Восстановление данных для PostgreSQL Важно : восстановление из резервной копии должно производиться в пустую базу данных. Предварительно убедитесь, что у вас есть резервная копия удаляемой БД. Только после этого приступайте к удалению. Подробнее о подготовке к восстановлению читайте в статье «PostgreSQL» . Для восстановления базы данных из резервной копии с помощью WAL-G: Остановите PostgreSQL, если он запущен: sudo systemctl stop postgresql Переместите или удалите содержимое директории /var/lib/postgresql/15/main : sudo mv /var/lib/postgresql/15/main /var/lib/postgresql/15/main_old Создайте пустую директорию для восстановления: sudo mkdir /var/lib/postgresql/15/main sudo chown postgres:postgres /var/lib/postgresql/15/main Для просмотра списка резервных копий баз данных выполните команду: sudo -u postgres /usr/local/bin/wal-g-pg backup-list --config /etc/postgresql/15/main/.walg.json Выполните команду восстановления: sudo -u postgres /usr/local/bin/wal-g-pg backup-fetch /var/lib/postgresql/15/main LATEST --config /etc/postgresql/15/main/.walg.json Здесь LATEST указывает на последнюю резервную копию. Вы также можете ввести наименование нужной копии, полученной из списка на предыдущем шаге, например, base_000000010000000000000009 . Запустите PostgreSQL: sudo systemctl start postgresql Настройка WAL-G для MongoDB С помощью WAL-G вы можете: выполнить резервное копирование данных; восстановить данные из резервной копии . Резервное копирование для MongoDB Для резервного копирования данных с помощью WAL-G выполните следующие действия: Предварительно установите WAL-G с официального GitHub-репозитория : wget https://github.com/wal-g/wal-g/releases/download/v3.0.5/wal-g-mongo-ubuntu-22.04-amd64.tar.gz tar -xzf wal-g-mongo-ubuntu-22.04-amd64.tar.gz sudo mv wal-g-mongo-ubuntu-22.04-amd64 /usr/local/bin/wal-g-mongo Настройте переменные окружения для доступа к облачному хранилищу. Откройте файл конфигурации /home/user/.walg.json и добавьте следующие параметры: { \"WALG_S3_PREFIX\": \"s3://elma365-backup/mongo\", \"AWS_ENDPOINT\": \"https://storage.yandexcloud.net\", \"AWS_ACCESS_KEY_ID\": \"<your-access-key-id>\", \"AWS_SECRET_ACCESS_KEY\": \"<your-secret-access-key>\", \"AWS_REGION\": \"us-east-1\", \"AWS_S3_FORCE_PATH_STYLE\": \"true\", \"WALG_COMPRESSION_METHOD\": \"brotli\", \"MONGODB_URI\": \"mongodb://superuser:SecretPassword@mongodb-server.your_domain:27017/?authSource=admin&connect=direct&socketTimeoutMS=60000&connectTimeoutMS=10000\", \"WALG_STREAM_CREATE_COMMAND\": \"mongodump --archive --oplog --uri='mongodb://superuser:SecretPassword@mongodb-server.your_domain:27017/?authSource=admin&connectTimeoutMS=10000'\", \"WALG_STREAM_RESTORE_COMMAND\": \"mongorestore --archive --oplogReplay --uri='mongodb://superuser:SecretPassword@mongodb-server.your_domain:27017/?authSource=admin&connectTimeoutMS=10000'\" } Где: WALG_S3_PREFIX — путь к S3, где будут храниться резервные копии и .WAL -файлы (Write-Ahead Logs); AWS_ENDPOINT — точка доступа (endpoint) для S3-совместимого хранилища; AWS_ACCESS_KEY_ID — идентификатор ключа доступа (Access Key ID) для аутентификации в S3-совместимом хранилище; AWS_SECRET_ACCESS_KEY — секретный ключ (Secret Access Key) для аутентификации в S3-совместимом хранилище; AWS_REGION — регион, в котором находится S3-совместимое хранилище; AWS_S3_FORCE_PATH_STYLE — указывает, что нужно использовать path-style для доступа к S3-бакетам; WALG_COMPRESSION_METHOD — метод сжатия, используемый для резервных копий. В данном случае используется алгоритм Brotli , который обеспечивает хорошее соотношение между степенью сжатия и скоростью; MONGODB_URI — URI для подключения к MongoDB; WALG_STREAM_CREATE_COMMAND — команда, используемая WAL-G для создания резервной копии MongoDB; ALG_STREAM_RESTORE_COMMAND — команда, используемая WAL-G для восстановления резервной копии MongoDB. Для создания полной резервной копии баз данных выполните команду: /usr/local/bin/wal-g-mongo backup-push --config /home/user/.walg.json Для просмотра списка резервных копий баз данных выполните команду: /usr/local/bin/wal-g-mongo backup-list --config /home/user/.walg.json Восстановление данных для MongoDB Важно : восстановление из резервной копии должно производиться в пустую базу данных. Предварительно убедитесь, что у вас есть резервная копия удаляемой базы данных. Только после этого приступайте к удалению БД. Подробнее о подготовке к восстановлению читайте в статье «MongoDB» . Чтобы восстановить базу данных из резервной копии, используйте команду: /usr/local/bin/wal-g-mongo backup-fetch LATEST --config /home/user/.walg.json Здесь LATEST указывает на последнюю резервную копию. Вы также можете указать наименование нужной копии, полученной из списка на предыдущем шаге, например, stream_20250214T093724Z . Настройка Rclone Установите Rclone с помощью команды: sudo -v ; curl https://rclone.org/install.sh | sudo bash Настройте Rclone для работы с S3: Запустите команду для настройки нового S3-хранилища: rclone config В открывшемся окне выберите опцию n для создания нового хранилища. Введите имя для вашего хранилища. Например source-s3 для исходного хранилища и backup-s3 для целевого. Выберите тип хранилища s3 . Выберите провайдера Other . Введите параметры доступа к вашему S3-хранилищу: access_key_id — ваш идентификатор ключа доступа; secret_access_key — ваш секретный ключ; region — регион вашего S3-хранилища; endpoint — точка доступа S3-хранилища. Повторите шаги для настройки второго S3-хранилища. Скопируйте данные из одного S3-хранилища в другое с помощью команды rclone copy : rclone copy source-s3:bucket-name/path backup-s3:backup-bucket-name/path -v --ignore-errors --fast-list --checksum Где: source-s3 — имя удалённого хранилища, настроенного для исходного S3; bucket-name/path — имя бакета и путь к данным в исходном хранилище; backup-s3 — имя удалённого хранилища, настроенного для целевого S3; backup-bucket-name/path — имя бакета и путь для резервной копии в целевом хранилище; -v — включает подробный вывод (verbose mode); --ignore-errors — игнорирует ошибки, возникающие во время выполнения команды; --fast-list — ускоряет процесс создания списка файлов и директорий, особенно при работе с облачными хранилищами, такими как S3, Google Drive и другими; --checksum — включает проверку контрольных сумм (хешей) файлов при копировании или синхронизации. database-backup-and-recovery.html dump_db.html Была ли статья полезной? Спасибо за ваш отзыв! × Ваш отзыв успешно отправлен! Спасибо за обратную связь. × Уточните, почему: Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина × Расскажите, что вам не понравилось в статье: Да Нет Выберите вариант Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина В этой статье API TS SDK Community Академия Платформа ECM Service Проекты Отправить фидбэк Задать вопрос Ваш фидбэк отправлен. © 2025 ELMA365 © 2025 ELMA365 elma365.com",
  "links": [
    "https://elma365.com/ru/help",
    "https://elma365.com/ru/help/platform/get-trial.html",
    "https://elma365.com/ru/help/ecm/ecm-functions.html",
    "https://elma365.com/ru/help/crm/crm-functions.html",
    "https://elma365.com/ru/help/projects/projects-functions.html",
    "https://elma365.com/ru/help/service/service-functions.html",
    "https://elma365.com/ru/help/kedo/kedo.html",
    "https://elma365.com/ru/help/business_solutions/-elma365-store.html",
    "https://elma-academy.com/ru/",
    "https://community.elma365.com/ru/",
    "https://api.elma365.com/ru/",
    "https://tssdk.elma365.com/latest/",
    "https://elma365.com/ru/",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/elma365-on-premises.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/backup-and-recovery-with-wal-g-and-rclone.html",
    "https://github.com/wal-g/wal-g",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/postgresql.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/mongodb.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/database-backup-and-recovery.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/dump_db.html",
    "https://tssdk.elma365.com/",
    "https://community.elma365.com/",
    "https://elma-academy.com/ru/elma365",
    "https://navigator.sk.ru/orn/1122971",
    "https://vkvideo.ru/@elma_bpm",
    "https://vk.com/elma_bpm",
    "https://t.me/elmaday",
    "https://dzen.ru/elma"
  ],
  "last_crawled": "2025-11-29T22:03:22.099674",
  "metadata": {
    "depth": 10,
    "saved_at": "2025-11-29T22:03:22.235122"
  }
}