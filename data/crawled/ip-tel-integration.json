{
  "doc_id": "ip-tel-integration",
  "url": "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/ip-tel-integration.html",
  "title": "Интеграция с IP-телефонией через пользовательский модуль",
  "breadcrumbs": [
    "Модули расширения системы"
  ],
  "section": "Модули расширения системы | [business_solutions]",
  "html": "<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n<title>Интеграция с IP-телефонией через пользовательский модуль</title>\n<meta content=\"Help+Manual\" name=\"generator\"/>\n<meta content=\"\" name=\"keywords\"/>\n<meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\"/>\n<meta content=\"IE=edge\" http-equiv=\"X-UA-Compatible\"/>\n<meta content=\"width=device-width, initial-scale=1.0\" name=\"viewport\"/>\n<meta content=\"Вы можете настроить интеграцию с провайдерами IP-телефонии, чтобы сотрудники могли совершать и принимать звонки от клиентов. Для этого используйте:\" name=\"description\"/>\n<meta content=\"\" name=\"picture\"/>\n<meta content=\"website\" property=\"og:type\"/>\n<meta content=\"Cправка по Low-code платформе ELMA365\" property=\"og:title\"/>\n<meta content=\"https://elma365.com/ru/help\" property=\"og:url\"/>\n<meta content=\"\" property=\"og:image\"/>\n<meta content=\"ELMA365\" property=\"og:site_name\"/>\n<link href=\"favicon.png\" rel=\"icon\" type=\"image/png\"/>\n<link href=\"https://elma365.com/ru/help/platform/ip-tel-integration.html\" rel=\"canonical\"/>\n<link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap\" rel=\"stylesheet\"/>\n<link href=\"./jquery-ui.min.css\" rel=\"stylesheet\"/>\n<link href=\"default.css\" rel=\"stylesheet\"/>\n<link href=\"./search-yandex.css\" rel=\"stylesheet\"/>\n<link href=\"./article.css\" rel=\"stylesheet\"/>\n<link href=\"./glossary.css\" rel=\"stylesheet\"/>\n<link href=\"./theme.css\" rel=\"stylesheet\"/>\n<link href=\"./tooltipster.bundle.min.css\" rel=\"stylesheet\" type=\"text/css\"/>\n<script src=\"jquery.js\" type=\"text/javascript\"></script>\n<script src=\"./tooltipster.bundle.min.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n        $(document).ready($('.tooltip').tooltipster({\n            contentCloning: true,\n            theme: 'tooltipster-borderless',\n        }));\n    </script>\n<script src=\"helpman_settings.js\" type=\"text/javascript\"></script>\n<script src=\"helpman_topicinit.js\" type=\"text/javascript\"></script>\n<script src=\"highlight.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n     $(document).ready(function(){highlight();});\n   </script>\n</head>\n<body>\n<script async=\"\" src=\"https://www.googletagmanager.com/gtag/js?id=G-M6ETBEC1R9\"></script><script>window.dataLayer=window.dataLayer || []; function gtag(){dataLayer.push(arguments);}gtag('js', new Date()); gtag('config', 'G-M6ETBEC1R9');</script>\n<script>!function(e,t,c,n,r,a,m){e.ym=e.ym||function(){(e.ym.a=e.ym.a||[]).push(arguments)},e.ym.l=1*new Date;for(var s=0;s<document.scripts.length;s++)if(document.scripts[s].src===n)return;a=t.createElement(c),m=t.getElementsByTagName(c)[0],a.async=1,a.src=n,m.parentNode.insertBefore(a,m)}(window,document,\"script\",\"https://mc.yandex.ru/metrika/tag.js\"),ym(83179930,\"init\",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0})</script><noscript><div><img alt=\"\" src=\"https://mc.yandex.ru/watch/83179930\" style=\"position:absolute;left:-9999px\"/></div></noscript> \n    \n    ﻿<header class=\"header elma-365\">\n<div class=\"container\">\n<div class=\"nav-container\">\n<div class=\"nav-wrap\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<div class=\"header__navi\">\n<ul class=\"header__list\"><li><span class=\"solution-select\"><span class=\"solution-select__selected\"></span><svg fill=\"none\" height=\"4\" viewbox=\"0 0 7 4\" width=\"7\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M1 1L3.5 3.5L6 1\" stroke=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg><ul class=\"solution-select__list\"><li class=\"header__list-item\"><a class=\"project-link\" href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">CSP</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/crm/crm-functions.html\">CRM+CX</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/kedo/kedo.html\">КЭДО</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/business_solutions/-elma365-store.html\">Бизнес-решения</a></li><ul class=\"social-links-header\"><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://elma-academy.com/ru/\" target=\"_blank\">Academy</a></li><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://community.elma365.com/ru/\" target=\"_blank\">Community</a></li><li></li></ul></ul></span></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://tssdk.elma365.com/latest/\" target=\"_blank\">SDK</a></li><li class=\"header__list-item header__list-item-latest\"><a class=\"header__list-item-url header__list-item-last\" href=\"https://elma365.com/ru/\" target=\"_blank\">Сайт ELMA365</a></li></ul>\n<div class=\"hero-wrap\" style=\"display: flex; align-items: center;\">\n<div class=\"hero__search\" style=\"display: flex; justify-content: space-between; width: 100%; padding-left: 0;\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<button class=\"hero__search-icon\" id=\"search-icon\">\n<img alt=\"search string\" src=\"search-icon-white.svg\"/>\n</button>\n<div class=\"hero__search-form\" id=\"search-panel\"><form class=\"search-form\"><label class=\"search-form__label\"><span class=\"search__icon\" id=\"reset-search\" src=\"Union.svg\"></span><input class=\"search-form__input\" type=\"text\"/></label><input class=\"search-form__submit\" type=\"submit\" value=\"Submit\"/></form></div>\n</div>\n</div>\n</div>\n</div>\n<a class=\"hero__side-icon\" href=\"#\" id=\"side-menu-icon\">\n<img alt=\"side menu\" src=\"side_menu.svg\"/>\n</a>\n</div>\n</div>\n</header>\n<main class=\"main container\">\n<aside class=\"sidebar\" id=\"sidebar\">\n<div class=\"sidebar__header\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img src=\"./logo-light.svg\"/>\n</a>\n<span class=\"sidebar__close elma-365-close\" id=\"close\"></span>\n</div>\n<div class=\"sidebar__wrapper\" id=\"side-menu\">\n</div>\n</aside>\n<article class=\"article\" id=\"article\">\n<div class=\"article-inner\">\n<div class=\"content\">\n<header class=\"article__header\">\n<div class=\"article__bread\" style=\"display:flex; gap:8px;\">\n<span class=\"search-res__item-category search-res__item-category_subcategory subcategory article__badge\" id=\"subcategory\"></span>\n<nav class=\"topic__breadcrumbs\">\n<p><a href=\"360024498352.html\">Модули расширения системы</a> &gt; Примеры модулей интеграции с ELMA365 / Интеграция с IP-телефонией через пользовательский модуль</p>\n</nav>\n</div>\n<div class=\"topic__title\"><h1 class=\"p_Heading1\"><span class=\"f_Heading1\">Интеграция с IP-телефонией через пользовательский модуль</span></h1>\n</div>\n</header>\n<section class=\"article__content\">\n<div class=\"scroll-top-inner\">\n<a class=\"scroll-top\" href=\"#h1-article\"></a>\n</div>\n<!-- Placeholder for topic body. -->\n<p class=\"p_Normal\">Вы можете настроить интеграцию с провайдерами IP-телефонии, чтобы сотрудники могли совершать и принимать звонки от клиентов. Для этого используйте:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">готовые модули из каталога <a class=\"weblink\" href=\"https://store.elma365.ru/\" target=\"_blank\">ELMA365 Store</a>: <a class=\"topiclink\" href=\"telephony-gravitel.html\">Гравител</a>, <a class=\"topiclink\" href=\"telephony-sipnet.html\">SIPNET</a>, <a class=\"topiclink\" href=\"telephony-zadarma.html\">Zadarma</a>, <a class=\"topiclink\" href=\"mango.html\">MANGO OFFICE</a>, <a class=\"topiclink\" href=\"sipuni.html\">Sipuni</a>, <a class=\"topiclink\" href=\"beeline.html\">Билайн</a>, <a class=\"topiclink\" href=\"asterisk.html\">Asterisk</a> (доступен только для ELMA365 On-Premises);</li><li class=\"p_Normal\">пользовательский модуль. Чтобы принимать и инициировать вызовы, нужно соединить модуль с провайдером.</li></ul>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">Начало внимание</span></p>\n<p class=\"p_Normal\">Функциональные возможности телефонии доступны при активации одного из <a class=\"weblink\" href=\"/ru/help/crm/licenses-crm.html\" target=\"_blank\">платных решений CRM</a>, в состав которого входит решение <span style=\"font-weight: bold;\">ELMA365 Управление коммуникациями</span>.</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">Конец внимание</span></p>\n<p class=\"p_Normal\">Чтобы настроить интеграцию с помощью пользовательского модуля:</p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"1\">Выполните <a class=\"topiclink\" href=\"ip-tel-integration.html#prepair\">предварительные настройки</a>, например, проверьте доступ к аккаунту телефонии, установите SIP-софтфон и т. д.</li><li class=\"p_Normal\" value=\"2\"><a class=\"topiclink\" href=\"ip-tel-integration.html#create-extention\">Создайте модуль</a> и в его скриптах пропишите методы Web API, чтобы получить сгенерированный Webhook и токен для обмена данными с провайдером телефонии. </li><li class=\"p_Normal\" value=\"3\"><a class=\"topiclink\" href=\"ip-tel-integration.html#integrate\">Соедините модуль с провайдером</a> — в настройках на стороне провайдера укажите токен и Webhook, а в модуль скопируйте ключ авторизации и URL телефонной станции. </li></ol>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 36px;\">Чтобы пользователи могли <a class=\"weblink\" href=\"/ru/help/crm/work-with-call.html#call-recording\" target=\"_blank\">обработать звонок</a> в его карточке, например принять или переназначить вызов и т. д., добавьте в скрипты модуля соответствующие методы Web API.</p>\n<p class=\"p_Normal\">В статье рассмотрен пример интеграции с телефонией Гравител. </p>\n<p class=\"p_Normal\">Подробнее о настройке интеграции при помощи пользовательского модуля читайте в <a class=\"weblink\" href=\"https://tssdk.t-elma365.com/ru/develop/modules/_201_integration_voip_.html\" target=\"_blank\">справке ELMA365 TS SDK</a>. </p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"prepair\"></a><span class=\"f_Heading2\">Предварительные настройки для интеграции с телефонией</span></h2>\n<p class=\"p_Normal\">Перед началом настройки:</p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"1\">Проверьте, что ваш аккаунт у выбранного провайдера телефонии активен.</li><li class=\"p_Normal\" value=\"2\">Ознакомьтесь с условиями и сроком хранения записи звонка на сервере провайдера. В течение этого срока в интерфейсе ELMA365 пользователь может прослушать и загрузить запись себе на компьютер. Если запись удалена, появится сообщение об ошибке.</li><li class=\"p_Normal\" value=\"3\">Убедитесь, что в настройках провайдера можно указать Webhook системы. С его помощью будут обрабатываться HTTP-запросы о событиях телефонии. Если такой возможности нет, создайте промежуточный сервис, который преобразует данные провайдера в запрос на сервер ELMA365. Подробнее читайте в статье <a class=\"topiclink\" href=\"portable-microservices.html\">«Переносимые сервисы в модулях»</a>.</li><li class=\"p_Normal\" value=\"4\">Для совершения и приёма звонков на рабочих местах сотрудников убедитесь, что провайдер предоставляет SIP-софтфон. В противном случае установите облачную или локальную программу, которая поддерживает SIP-протокол и обеспечивает голосовую связь, например, MicroSip.</li><li class=\"p_Normal\" value=\"5\">Чтобы использовать телефонию для работы с продажами, активируйте одно из <a class=\"weblink\" href=\"/ru/help/crm/crm-functions.html\" target=\"_blank\">системных решений CRM</a>. Без лицензии функциональные возможности CRM недоступны.</li></ol>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"create-extention\"></a><span class=\"f_Heading2\">Создать пользовательский модуль интеграции с телефонией</span></h2>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Heading2\" value=\"1\">Перейдите в раздел <span style=\"font-weight: bold;\">Администрирование &gt; Модули</span> и в правом верхнем углу нажмите кнопку <span style=\"font-weight: bold;\">+ Модуль</span>.</li><li class=\"p_Normal\" value=\"2\">В открывшемся окне выберите опцию <span style=\"font-weight: bold;\">Создать</span>, введите название и описание модуля. Нажмите кнопку <span style=\"font-weight: bold;\">Создать</span>.</li><li class=\"p_Normal\" value=\"3\">На странице управления модулем перейдите на вкладку <span style=\"font-weight: bold;\">Методы API</span> и нажмите кнопку <span style=\"font-weight: bold;\">Редактировать</span>. На открывшейся странице перейдите на вкладку <span style=\"font-weight: bold;\">Скрипты</span>.</li><li class=\"p_Normal\" value=\"4\">Вставьте код-заготовку для методов, которые реализуют интеграцию и обмен данными с телефонией.</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">// Проверить соединение с телефонией</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipTestConnection(): Promise&lt;VoipTestConnectionResult&gt; {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> {</span><br/>\n<span class=\"f_CodeExample\">       success: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><span class=\"f_CodeExample\">,</span><br/>\n<span class=\"f_CodeExample\">       failReason: 'Функция проверки соединения не реализована.',</span><br/>\n<span class=\"f_CodeExample\">   };</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Обработать запрос от провайдера IP-телефонии</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipParseWebhookRequest(request: FetchRequest): Promise&lt;VoipWebhookParseResult&gt; {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> {</span><br/>\n<span class=\"f_CodeExample\">       response: </span><span style=\"font-size: 11px; font-family: Consolas;\">new</span><span class=\"f_CodeExample\"> HttpResponse()</span><br/>\n<span class=\"f_CodeExample\">           .status(400)</span><br/>\n<span class=\"f_CodeExample\">           .content('Hello, world!'),</span><br/>\n<span class=\"f_CodeExample\">   };</span><br/>\n<span class=\"f_CodeExample\">} </span><br/>\n<span class=\"f_CodeExample\">// Получить список пользователей IP-телефонии</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipGetMembers(): Promise&lt;VoipMember[]&gt; {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">throw new</span><span class=\"f_CodeExample\"> Error('Функция не реализована.');</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Сгенерировать звонок</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipGenerateCall(srcPhone: string, dstPhone: string): Promise&lt;</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">void</span><span class=\"f_CodeExample\">&gt; {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">throw new</span><span class=\"f_CodeExample\"> Error('Функция не реализована.');</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Получить ссылку на запись звонка</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipGetCallLink(callData: any): Promise&lt;string&gt; {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">throw new</span><span class=\"f_CodeExample\"> Error('Функция не реализована.');</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"5\">Сохраните и опубликуйте изменения. </li></ol>\n<p class=\"p_Normal\">На странице модуля отобразятся разделы:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><span style=\"font-weight: bold;\">Настройки телефонии</span>, где указаны автоматически сгенерированные токен и Webhook;</li><li class=\"p_Normal\"><span style=\"font-weight: bold;\">Настройки обработки входящего звонка</span>, где по умолчанию выбрано приложение для хранения контактных данных клиентов. </li></ul>\n<p style=\"line-height: 1.28; margin: 0 0 11px 0;\"><img alt=\"IP-Tel-integration-1\" height=\"463\" src=\"ip-tel-integration-1.png\" style=\"margin:0;width:817px;height:463px;border:none\" width=\"817\"/></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"integrate\"></a><span class=\"f_Heading2\">Соединить модуль с провайдером телефонии</span></h2>\n<p class=\"p_Normal\">Рассмотрим настройку интеграции пользовательского модуля с провайдером на примере телефонии Гравител.</p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">На странице модуля перейдите на вкладку <span style=\"font-weight: bold;\">Настройки</span> и добавьте два строковых поля <span style=\"font-weight: bold;\">Ключ для авторизации в облачной АТС</span> (<code><b>apiKey</b></code>) и <span style=\"font-weight: bold;\">Адрес облачной АТС</span> (<code><b>endpoint</b></code>). В эти поля позднее вы запишете данные из настроек провайдера для подключения к Гравител. </li></ol>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 37px;\"><img alt=\"IP-Tel-integration-3\" height=\"329\" src=\"ip-tel-integration-3.png\" style=\"margin:0;width:709px;height:329px;border:none\" width=\"709\"/></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Вернитесь на страницу модуля — на ней появятся добавленные в предыдущем пункте поля. Cкопируйте значения полей <span style=\"font-weight: bold;\">Webhook URL</span> и <span style=\"font-weight: bold;\">Токен</span>.</li><li class=\"p_Normal\" value=\"3\">Перейдите в панель управления Гравител. Интеграция настраивается по Web API Гравител предыдущего поколения. В зависимости от версии личного кабинета, которую вы используете, выполните следующие шаги:</li></ol>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">для актуальной версии — перейдите в <span style=\"font-weight: bold;\">Интеграции </span>и выберите блок <span style=\"font-weight: bold;\">API Гравител</span>. Нажмите<span style=\"font-weight: bold;\"> Установить</span>;</li><li class=\"p_Normal\">для предыдущей версии — перейдите в <span style=\"font-weight: bold;\">Интеграция с CRM </span>и на открывшейся странице в правом нижнем углу выберите <span style=\"font-weight: bold;\">Интеграции с вашей CRM</span>.</li></ul>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"4\">На открывшейся странице заполните поля <span style=\"font-weight: bold;\">Название интеграции, Ваша CRM</span>, <span style=\"font-weight: bold;\">Адрес вашей CRM </span>и <span style=\"font-weight: bold;\">Ключ для авторизации в</span> <span style=\"font-weight: bold;\">вашей CRM</span> значениями из настроек модуля. </li></ol>\n<p style=\"margin: 0 0 0 36px;\">Затем скопируйте значения полей <span style=\"font-weight: bold;\">Ключ для авторизации в Облачной АТС </span>и <span style=\"font-weight: bold;\">Адрес Облачной АТС</span>. Перейдите в ELMA365 и вставьте их в соответствующие поля на странице модуля.<span style=\"font-size: 13px; color: #394149;\"> </span></p>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 35px;\"><img alt=\"IP-Tel-integration-6\" height=\"612\" src=\"ip-tel-integration-6.png\" style=\"margin:0;width:854px;height:612px;border:none\" width=\"854\"/></p>\n<p class=\"p_Normal\" style=\"margin: 0 0 0 35px;\">Подробнее о настройке интеграции в личном кабинете Гравител читайте в статье <a class=\"topiclink\" href=\"telephony-gravitel.html\">«Телефония Гравител»</a>.</p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"5\">Сохраните настройки в панели управления Гравител и на странице модуля.</li><li class=\"p_Normal\" value=\"6\">Перейдите на страницу управления модулем и откройте вкладку <span style=\"font-weight: bold;\">Методы API &gt; Скрипты</span>. Нажмите кнопку <span style=\"font-weight: bold;\">Редактировать</span> и добавьте в начало скрипта следующий код:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">// Загрузить значение поля Ключ для авторизации в облачной АТС из настроек модуля</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">function</span><span class=\"f_CodeExample\"> getApiKey() {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> apiKey = Namespace.params.data.apiKey;</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">if</span><span class=\"f_CodeExample\"> (!apiKey) {</span><br/>\n<span class=\"f_CodeExample\">       </span><span style=\"font-size: 11px; font-family: Consolas;\">throw new</span><span class=\"f_CodeExample\"> Error('invalid API key');</span><br/>\n<span class=\"f_CodeExample\">   }</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> apiKey;  </span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Загрузить значение поля Адрес облачной АТС из настроек модуля</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">function</span><span class=\"f_CodeExample\"> getEndpoint() {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> endpoint = Namespace.params.data.endpoint;</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">if</span><span class=\"f_CodeExample\"> (!endpoint) {</span><br/>\n<span class=\"f_CodeExample\">       </span><span style=\"font-size: 11px; font-family: Consolas;\">throw new</span><span class=\"f_CodeExample\"> Error('invalid endpoint URL');</span><br/>\n<span class=\"f_CodeExample\">   }</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> endpoint;</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Выполнить запрос к Гравител</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> fetchEndpoint(command: string, body: Object = {}): Promise&lt;FetchResponse&gt; {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> fetch(getEndpoint(), {</span><br/>\n<span class=\"f_CodeExample\">       method: 'POST',   </span><br/>\n<span class=\"f_CodeExample\">       headers: {</span><br/>\n<span class=\"f_CodeExample\">           'Content-Type': 'application/json',</span><br/>\n<span class=\"f_CodeExample\">       },</span><br/>\n<span class=\"f_CodeExample\">       body: JSON.stringify({</span><br/>\n<span class=\"f_CodeExample\">           cmd: command,</span><br/>\n<span class=\"f_CodeExample\">           token: getApiKey(),</span><br/>\n<span class=\"f_CodeExample\">           ...body,</span><br/>\n<span class=\"f_CodeExample\">       }),</span><br/>\n<span class=\"f_CodeExample\">   });</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Распарсить контент с типом application/x-www-form-urlencoded</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">function</span><span class=\"f_CodeExample\"> parseUrlEncoded(body: string): Record&lt;string, string&gt; {</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> result: Record&lt;string, string&gt; = {};</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">for</span><span class=\"f_CodeExample\"> (</span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> pair </span><span style=\"font-size: 11px; font-family: Consolas;\">of</span><span class=\"f_CodeExample\"> body.split('&amp;')) {</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> keyValue = pair.split('=');</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">if</span><span class=\"f_CodeExample\"> (keyValue.length === 2) {</span><br/>\n<span class=\"f_CodeExample\">            </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> key = decodeURIComponent(keyValue[0]);</span><br/>\n<span class=\"f_CodeExample\">            </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> value = decodeURIComponent(keyValue[1]);</span><br/>\n<span class=\"f_CodeExample\">            result[key] = value;</span><br/>\n<span class=\"f_CodeExample\">        }</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> result;</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Сообщение от Гравител</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">interface</span><span class=\"f_CodeExample\"> GravitelWebhookRequest {</span><br/>\n<span class=\"f_CodeExample\">    cmd: string; // Тип операции</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">type</span><span class=\"f_CodeExample\">: string; // Тип события, связанного со звонком</span><br/>\n<span class=\"f_CodeExample\">    phone: string; // Номер телефона клиента (в формате E.164)</span><br/>\n<span class=\"f_CodeExample\">    ext?: string; // Внутренний номер пользователя облачной АТС, если есть</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Данные, передающиеся с командой history</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">interface</span><span class=\"f_CodeExample\"> GravitelWebhookHistoryCommand </span><span style=\"font-size: 11px; font-family: Consolas;\">extends</span><span class=\"f_CodeExample\"> GravitelWebhookRequest {</span><br/>\n<span class=\"f_CodeExample\">    duration: string; // Общая длительность звонка в секундах</span><br/>\n<span class=\"f_CodeExample\">    callid: string; // Уникальный id звонка</span><br/>\n<span class=\"f_CodeExample\">    link?: string; // Ссылка на запись звонка, если она включена в Облачной АТС</span><br/>\n<span class=\"f_CodeExample\">    status: string; // Статус входящего или исходящего звонка</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Данные, которые сохраняются с каждым звонком</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">interface</span><span class=\"f_CodeExample\"> GravitelCallData {</span><br/>\n<span class=\"f_CodeExample\">    id: string;</span><br/>\n<span class=\"f_CodeExample\">    link: string;</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\">// Сконвертировать статус звонка Гравител в статус звонка ELMA365</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">function</span><span class=\"f_CodeExample\"> toCallDisposition(status: string): VoipCallDisposition {</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">switch</span><span class=\"f_CodeExample\"> (status) {</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">case</span><span class=\"f_CodeExample\"> 'Success':</span><br/>\n<span class=\"f_CodeExample\">            </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> VoipCallDisposition.Answered;</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">case</span><span class=\"f_CodeExample\"> 'Busy':</span><br/>\n<span class=\"f_CodeExample\">            </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> VoipCallDisposition.Busy;</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">case</span><span class=\"f_CodeExample\"> 'Missed':</span><br/>\n<span class=\"f_CodeExample\">            </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> VoipCallDisposition.Cancel;</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">case</span><span class=\"f_CodeExample\"> 'NotAvailable':</span><br/>\n<span class=\"f_CodeExample\">            </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> VoipCallDisposition.NoAnswer;</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">case</span><span class=\"f_CodeExample\"> 'NotAllowed':</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">default</span><span class=\"f_CodeExample\">:</span><br/>\n<span class=\"f_CodeExample\">            </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> VoipCallDisposition.Unknown;</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"7\"><span style=\"font-family: 'Times New Roman',Times,Georgia,serif;\">Добавьте или замените метод </span><code><b>VoipTestConnection</b></code>, который позволяет проверить соединение с телефонией. В данном примере тестируется команда для получения списка пользователей. Вы можете указать другую команду.</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid; page-break-after: avoid;\"><span class=\"f_CodeExample\">// Проверить соединение к телефонии</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipTestConnection(): Promise&lt;VoipTestConnectionResult&gt; {</span><br/>\n<span class=\"f_CodeExample\">   </span><span style=\"font-size: 11px; font-family: Consolas;\">try</span><span class=\"f_CodeExample\"> {</span><br/>\n<span class=\"f_CodeExample\">       // Выполняем команду для получения списка пользователей телефонии</span><br/>\n<span class=\"f_CodeExample\">       </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> response = </span><span style=\"font-size: 11px; font-family: Consolas;\">await</span><span class=\"f_CodeExample\"> fetchEndpoint('accounts');</span><br/>\n<span class=\"f_CodeExample\">       </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> message = </span><span style=\"font-size: 11px; font-family: Consolas;\">await</span><span class=\"f_CodeExample\"> response.json();</span><br/>\n<span class=\"f_CodeExample\">       </span><span style=\"font-size: 11px; font-family: Consolas;\">if</span><span class=\"f_CodeExample\"> (response.status !== 200) {</span><br/>\n<span class=\"f_CodeExample\">           </span><span style=\"font-size: 11px; font-family: Consolas;\">throw new</span><span class=\"f_CodeExample\"> Error(`${response.status} ${response.statusText}: ${message.error}`);</span><br/>\n<span class=\"f_CodeExample\">       }</span><br/>\n<span class=\"f_CodeExample\">       </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> { success: </span><span style=\"font-size: 11px; font-family: Consolas;\">true</span><span class=\"f_CodeExample\"> };</span><br/>\n<span class=\"f_CodeExample\">   } </span><span style=\"font-size: 11px; font-family: Consolas;\">catch</span><span class=\"f_CodeExample\"> (e) {</span><br/>\n<span class=\"f_CodeExample\">       </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> {</span><br/>\n<span class=\"f_CodeExample\">           success: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><span class=\"f_CodeExample\">,</span><br/>\n<span class=\"f_CodeExample\">           failReason: e.message,</span><br/>\n<span class=\"f_CodeExample\">       };</span><br/>\n<span class=\"f_CodeExample\">   }</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"8\">Сохраните и опубликуйте скрипты, после чего перейдите на страницу модуля и нажмите кнопку <span style=\"font-weight: bold;\">Проверить соединение</span>. Появится сообщение об успешном подключении к телефонии. </li></ol>\n<p class=\"p_Normal\" style=\"text-indent: -1px; margin: 0 0 0 36px;\">Если вы видите ошибку при проверке соединения:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">убедитесь, что поля на странице модуля и в панели управления Гравител заполнены корректно. Например, ошибка «Invalid token» означает, что неверно заполнено поле <span style=\"font-weight: bold;\">Токен</span>;</li><li class=\"p_Normal\">проверьте, что скрипты составлены без ошибок, а также успешно сохранены и опубликованы;</li><li class=\"p_Normal\">убедитесь, что ваш аккаунт Гравител активен.</li></ul>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"9\">После этого добавьте или замените следующие методы для интеграции с Гравител:</li></ol>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">метод <code><b>VoipParseWebhookRequest</b></code> — позволяет модулю обработать данные из HTTP-запроса от провайдера и передать их в ELMA365;</li></ul>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">// Обработать запрос от провайдера IP-телефонии</span><br/>\n<span class=\"f_CodeExample\">async function VoipParseWebhookRequest(request: FetchRequest): Promise&lt;VoipWebhookParseResult&gt; {</span><br/>\n<span class=\"f_CodeExample\">    try {</span><br/>\n<span class=\"f_CodeExample\">        const headers = request.headers;</span><br/>\n<span class=\"f_CodeExample\">        const contentType = headers ? headers['Content-Type'] : undefined;</span><br/>\n<span class=\"f_CodeExample\">        if (contentType !== 'application/x-www-form-urlencoded') {</span><br/>\n<span class=\"f_CodeExample\">            throw new Error(`Expected Content-Type to be \"application/x-www-form-urlencoded\" (got: \"${contentType}\"`);</span><br/>\n<span class=\"f_CodeExample\">        }</span><br/>\n<span class=\"f_CodeExample\">        if (typeof request.body !== 'string') {</span><br/>\n<span class=\"f_CodeExample\">            throw new Error('Expected request body to be string')</span><br/>\n<span class=\"f_CodeExample\">        }</span><br/>\n<span class=\"f_CodeExample\">        let event: VoipWebhookRequest | undefined;</span><br/>\n<span class=\"f_CodeExample\">        let callRecord: VoipCallRecord | undefined;</span><br/>\n<span class=\"f_CodeExample\">        let response: HttpResponse | undefined;</span><br/>\n<span class=\"f_CodeExample\">        const data = &lt;GravitelWebhookRequest&gt;&lt;unknown&gt; parseUrlEncoded(request.body);</span><br/>\n<span class=\"f_CodeExample\">        switch (data.cmd) {</span><br/>\n<span class=\"f_CodeExample\">            case 'event': {</span><br/>\n<span class=\"f_CodeExample\">// Облачная АТС отправляет в вашу CRM уведомления о событиях входящих звонков пользователям: </span><br/>\n<span class=\"f_CodeExample\">появлении, принятии или завершении звонка. Команда может быть использована для отображения </span><br/>\n<span class=\"f_CodeExample\">всплывающей карточки клиента в интерфейсе CRM</span><br/>\n<span class=\"f_CodeExample\">                const dstPhone = data.ext ?? '';</span><br/>\n<span class=\"f_CodeExample\">                switch (data.type) {</span><br/>\n<span class=\"f_CodeExample\">                    case 'INCOMING': {</span><br/>\n<span class=\"f_CodeExample\">// Пришёл входящий звонок. В это время у менеджера должен начать звонить телефон</span><br/>\n<span class=\"f_CodeExample\">                        event = {</span><br/>\n<span class=\"f_CodeExample\">                            event: VoipWebhookEvent.NotifyStart,</span><br/>\n<span class=\"f_CodeExample\">                            direction: VoipCallDirection.In,</span><br/>\n<span class=\"f_CodeExample\">                            dstPhone: dstPhone,</span><br/>\n<span class=\"f_CodeExample\">                            srcPhone: data.phone,</span><br/>\n<span class=\"f_CodeExample\">                            disposition: VoipCallDisposition.Unknown,</span><br/>\n<span class=\"f_CodeExample\">                        };</span><br/>\n<span class=\"f_CodeExample\">                    } break;</span><br/>\n<span class=\"f_CodeExample\">                    case 'ACCEPTED': {</span><br/>\n<span class=\"f_CodeExample\">// Звонок успешно принят, т. е. менеджер снял трубку. В этот момент можно убрать всплывающую </span><br/>\n<span class=\"f_CodeExample\">карточку контакта в CRM</span><br/>\n<span class=\"f_CodeExample\">                        event = {</span><br/>\n<span class=\"f_CodeExample\">                            event: VoipWebhookEvent.NotifyAnswer,</span><br/>\n<span class=\"f_CodeExample\">                            direction: VoipCallDirection.In,</span><br/>\n<span class=\"f_CodeExample\">                            dstPhone: dstPhone,</span><br/>\n<span class=\"f_CodeExample\">                            srcPhone: data.phone,</span><br/>\n<span class=\"f_CodeExample\">                            disposition: VoipCallDisposition.Unknown,</span><br/>\n<span class=\"f_CodeExample\">                        }</span><br/>\n<span class=\"f_CodeExample\">                    } break;</span><br/>\n<span class=\"f_CodeExample\">                    case 'COMPLETED': {</span><br/>\n<span class=\"f_CodeExample\">// Звонок успешно завершён, т. е. менеджер или клиент положили трубку после разговора</span><br/>\n<span class=\"f_CodeExample\">                        event = {</span><br/>\n<span class=\"f_CodeExample\">                            event: VoipWebhookEvent.NotifyEnd,</span><br/>\n<span class=\"f_CodeExample\">                            direction: VoipCallDirection.In,</span><br/>\n<span class=\"f_CodeExample\">                            dstPhone: dstPhone,</span><br/>\n<span class=\"f_CodeExample\">                            srcPhone: data.phone,</span><br/>\n<span class=\"f_CodeExample\">                            disposition: VoipCallDisposition.Unknown,</span><br/>\n<span class=\"f_CodeExample\">                        }</span><br/>\n<span class=\"f_CodeExample\">                    } break;</span><br/>\n<span class=\"f_CodeExample\">                    case 'CANCELLED': {</span><br/>\n<span class=\"f_CodeExample\">// Звонок сброшен, т.е. клиент не дождался пока менеджер снимет трубку. Либо, если это был </span><br/>\n<span class=\"f_CodeExample\">звонок сразу на группу менеджеров, на звонок мог ответить кто-то ещё</span><br/>\n<span class=\"f_CodeExample\">                        event = {</span><br/>\n<span class=\"f_CodeExample\">                            event: VoipWebhookEvent.NotifyEnd,</span><br/>\n<span class=\"f_CodeExample\">                            direction: VoipCallDirection.In,</span><br/>\n<span class=\"f_CodeExample\">                            dstPhone: dstPhone,</span><br/>\n<span class=\"f_CodeExample\">                            srcPhone: data.phone,</span><br/>\n<span class=\"f_CodeExample\">                            disposition: VoipCallDisposition.Cancel, </span><br/>\n<span class=\"f_CodeExample\">                        }</span><br/>\n<span class=\"f_CodeExample\">                    } break;</span><br/>\n<span class=\"f_CodeExample\">                    case 'OUTGOING': {</span><br/>\n<span class=\"f_CodeExample\">// Менеджер совершает исходящий звонок. В это время облачная АТС пытается дозвониться до клиента</span><br/>\n<span class=\"f_CodeExample\">                        event = {</span><br/>\n<span class=\"f_CodeExample\">                            event: VoipWebhookEvent.NotifyStart,</span><br/>\n<span class=\"f_CodeExample\">                            direction: VoipCallDirection.Out,</span><br/>\n<span class=\"f_CodeExample\">                            dstPhone: dstPhone,</span><br/>\n<span class=\"f_CodeExample\">                            srcPhone: data.phone,</span><br/>\n<span class=\"f_CodeExample\">                            disposition: VoipCallDisposition.Unknown, </span><br/>\n<span class=\"f_CodeExample\">                        }</span><br/>\n<span class=\"f_CodeExample\">                    } break;</span><br/>\n<span class=\"f_CodeExample\">                    default: throw new Error(`Unknown event type \"${data.type}\"`)</span><br/>\n<span class=\"f_CodeExample\">                }</span><br/>\n<span class=\"f_CodeExample\">            } break;</span><br/>\n<span class=\"f_CodeExample\">            case 'history': {</span><br/>\n<span class=\"f_CodeExample\">// После успешного звонка в CRM отправляется запрос с данными о звонке и ссылкой на запись </span><br/>\n<span class=\"f_CodeExample\">разговора. Команда может быть использована для сохранения в данных ваших клиентов истории </span><br/>\n<span class=\"f_CodeExample\">и записей входящих и исходящих звонков</span><br/>\n<span class=\"f_CodeExample\">                const cmd = &lt;GravitelWebhookHistoryCommand&gt; data;</span><br/>\n<span class=\"f_CodeExample\">                callRecord = {</span><br/>\n<span class=\"f_CodeExample\">                   srcPhone: cmd.phone,</span><br/>\n<span class=\"f_CodeExample\">                   dstPhone: cmd.ext ?? '',</span><br/>\n<span class=\"f_CodeExample\">                   direction: cmd.type === 'out' ? VoipCallDirection.Out : VoipCallDirection.In,</span><br/>\n<span class=\"f_CodeExample\">                   duration: parseInt(cmd.duration),</span><br/>\n<span class=\"f_CodeExample\">// Данные из этого поля будут доступны в функции VoipGetCallLink</span><br/>\n<span class=\"f_CodeExample\">                    call: &lt;GravitelCallData&gt;{</span><br/>\n<span class=\"f_CodeExample\">                        link: cmd.link,</span><br/>\n<span class=\"f_CodeExample\">                        id: cmd.callid,</span><br/>\n<span class=\"f_CodeExample\">                    },</span><br/>\n<span class=\"f_CodeExample\">                    disposition: toCallDisposition(cmd.status),</span><br/>\n<span class=\"f_CodeExample\">                }</span><br/>\n<span class=\"f_CodeExample\">            } break;</span><br/>\n<span class=\"f_CodeExample\">        }</span><br/>\n<span class=\"f_CodeExample\">        return { </span><br/>\n<span class=\"f_CodeExample\">            event: event,</span><br/>\n<span class=\"f_CodeExample\">            callRecord: callRecord,</span><br/>\n<span class=\"f_CodeExample\">            response: response,</span><br/>\n<span class=\"f_CodeExample\">        };</span><br/>\n<span class=\"f_CodeExample\">    } catch (e) {</span><br/>\n<span class=\"f_CodeExample\">        return {</span><br/>\n<span class=\"f_CodeExample\">            response: new HttpResponse()</span><br/>\n<span class=\"f_CodeExample\">                .status(400)</span><br/>\n<span class=\"f_CodeExample\">                .content(JSON.stringify({</span><br/>\n<span class=\"f_CodeExample\">                    error: e.message ?? 'internal error',</span><br/>\n<span class=\"f_CodeExample\">                }))</span><br/>\n<span class=\"f_CodeExample\">        };</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">метод <code><b>VoipGetMembers</b></code> — позволяет получить данные о пользователях телефонии. Эти данные отображаются на странице модуля при сопоставлении пользователей провайдера и пользователей ELMA365;</li></ul>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">// Получить список пользователей от провайдера IP-телефонии</span><br/>\n<span class=\"f_CodeExample\">async function VoipGetMembers(): Promise&lt;VoipMember[]&gt; {</span><br/>\n<span class=\"f_CodeExample\">    const response = await fetchEndpoint('accounts');</span><br/>\n<span class=\"f_CodeExample\">    if (response.status !== 200) {</span><br/>\n<span class=\"f_CodeExample\">        throw new Error(`received error response ${response.status}: ${response.statusText}`);</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">    interface GravitelVoipUser {</span><br/>\n<span class=\"f_CodeExample\">        name: string;</span><br/>\n<span class=\"f_CodeExample\">        ext: string;</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">    const voipUsers = &lt;GravitelVoipUser[]&gt; (await response.json());</span><br/>\n<span class=\"f_CodeExample\">    return voipUsers.map(user =&gt; ({</span><br/>\n<span class=\"f_CodeExample\">        id: user.ext,</span><br/>\n<span class=\"f_CodeExample\">        label: user.name,</span><br/>\n<span class=\"f_CodeExample\">    }));</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">метод <code><b>VoipGenerateCall</b></code> — позволяет инициировать звонок из интерфейса ELMA365;</li></ul>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid; page-break-after: avoid;\"><span class=\"f_CodeExample\">// Сгенерировать звонок</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipGenerateCall(srcPhone: string, dstPhone: string): Promise&lt;</span><span style=\"font-size: 11px; font-family: Consolas;\">void</span><span class=\"f_CodeExample\">&gt; {</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">const</span><span class=\"f_CodeExample\"> response = </span><span style=\"font-size: 11px; font-family: Consolas;\">await</span><span class=\"f_CodeExample\"> fetchEndpoint('makeCall', {</span><br/>\n<span class=\"f_CodeExample\">        phone: dstPhone,</span><br/>\n<span class=\"f_CodeExample\">        user: srcPhone,</span><br/>\n<span class=\"f_CodeExample\">    });</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">if</span><span class=\"f_CodeExample\"> (response.status !== 200) {</span><br/>\n<span class=\"f_CodeExample\">        </span><span style=\"font-size: 11px; font-family: Consolas;\">throw new</span><span class=\"f_CodeExample\"> Error(`received error response ${response.status}: ${response.statusText}`);</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">метод <code><b>VoipGetCallLink</b></code> — позволяет сохранить запись разговора. В качестве аргумента передаются данные из поля <span style=\"font-weight: bold;\">call</span> параметра <code><b>VoipCallRecord</b></code> (заполняется в методе <code><b>VoipParseWebhookRequest</b></code>).</li></ul>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">// Получить ссылку на запись разговора</span><br/>\n<span style=\"font-size: 11px; font-family: Consolas;\">async function</span><span class=\"f_CodeExample\"> VoipGetCallLink(callData: GravitelCallData): Promise&lt;string&gt; {</span><br/>\n<span class=\"f_CodeExample\">    </span><span style=\"font-size: 11px; font-family: Consolas;\">return</span><span class=\"f_CodeExample\"> callData.link;</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"10\">Чтобы реализовать функциональность кнопок для обработки звонка в его карточке, добавьте методы, перечисленные в <a class=\"weblink\" href=\"https://tssdk.t-elma365.com/ru/develop/modules/_201_integration_voip_.html#2\" target=\"_blank\">справке ELMA365 TS SDK</a>. </li><li class=\"p_Normal\" value=\"11\">Сохраните и опубликуйте скрипты. </li><li class=\"p_Normal\" value=\"12\">На странице модуля нажмите на появившуюся кнопку <span style=\"font-weight: bold;\">Настроить</span> и сопоставьте номера пользователей из настроек провайдера с пользователями ELMA365. Подробнее читайте в статье <a class=\"weblink\" href=\"/ru/help/business_solutions/telephony-gravitel.html#users\" target=\"_blank\">«Телефония Гравител»</a>.</li></ol>\n<p class=\"p_Normal\" style=\"text-indent: -1px; margin: 0 0 0 36px;\"><img alt=\"IP-Tel-integration-7\" height=\"610\" src=\"ip-tel-integration-7.png\" style=\"margin:0;width:834px;height:610px;border:none\" width=\"834\"/></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"13\"><span style=\"font-family: 'Times New Roman',Times,Georgia,serif;\">Сохраните настройки. </span></li></ol>\n<p class=\"p_Normal\"><span style=\"font-family: 'Times New Roman',Times,Georgia,serif;\">Теперь интеграция с Гравител полностью функционирует.</span></p>\n<div class=\"bottom-nav\">\n<a class=\"topic__navi_prev\" href=\"dadata_integration.html\" id=\"prev-link\">\n<span class=\"bottom-nav__arrow bottom-nav__arrow--prev\"></span> <span class=\"bottom-nav__link\">dadata_integration.html</span>\n</a>\n<a class=\"topic__navi_next\" href=\"360009906679.html\" id=\"next-link\">\n<span class=\"bottom-nav__link\">360009906679.html</span> <span class=\"bottom-nav__arrow bottom-nav__arrow--next\"></span>\n</a>\n</div>\n<!-- добавляет на страницу строку блок Была ли статья полезной?  -->\n<div class=\"feedback-wrap\"><div class=\"feedback\" id=\"feedback\"><span><b>Была ли статья полезной?</b></span><form action=\"\" class=\"feedback-form\" id=\"feedback-form\" method=\"POST\"><div class=\"feedback__popup feedback__popup-response\" id=\"feedback__popup_thx\">Спасибо за ваш отзыв!</div><div id=\"feedback-success-popup\"><div class=\"wrap\"><button class=\"feedback-popup-close\" type=\"button\">×</button><svg fill=\"none\" height=\"44\" viewbox=\"0 0 44 44\" width=\"44\" xmlns=\"http://www.w3.org/2000/svg\"><g clip-path=\"url(#clip0_212_2187)\"><path d=\"M22 0.6875C10.2294 0.6875 0.6875 10.2294 0.6875 22C0.6875 33.7706 10.2294 43.3125 22 43.3125C33.7706 43.3125 43.3125 33.7706 43.3125 22C43.3125 10.2294 33.7706 0.6875 22 0.6875ZM22 40.5625C11.8023 40.5625 3.4375 32.3078 3.4375 22C3.4375 11.8024 11.6922 3.4375 22 3.4375C32.1977 3.4375 40.5625 11.6922 40.5625 22C40.5625 32.1976 32.3078 40.5625 22 40.5625ZM34.1713 16.933L18.6613 32.3186C18.257 32.7197 17.604 32.7171 17.203 32.3128L9.82283 24.873C9.42176 24.4686 9.42434 23.8157 9.82867 23.4146L10.5609 22.6884C10.9652 22.2873 11.6181 22.2899 12.0192 22.6942L17.9468 28.6697L31.9926 14.7366C32.3969 14.3356 33.0498 14.3382 33.4509 14.7425L34.1772 15.4747C34.5783 15.879 34.5757 16.532 34.1713 16.933Z\" fill=\"#27AE60\"></path></g><defs><clippath id=\"clip0_212_2187\"><rect fill=\"white\" height=\"44\" width=\"44\"></rect></clippath></defs></svg><p>Ваш отзыв успешно отправлен!</p><span>Спасибо за обратную связь.</span></div></div><div class=\"feedback__popup\" id=\"feedback__popup_why\"><button class=\"feedback-popup-close\" type=\"button\">×</button><div class=\"feedback__popup-header\">Уточните, почему:</div><input id=\"bad_recommendation\" name=\"category\" type=\"radio\" value=\"bad_recommendation\"/><label for=\"bad_recommendation\">Рекомендации не помогли</label><input id=\"difficult_text\" name=\"category\" type=\"radio\" value=\"difficult_text\"/><label for=\"difficult_text\">Текст трудно понять</label><input id=\"no_answer\" name=\"category\" type=\"radio\" value=\"no_answer\"/><label for=\"no_answer\">Нет ответа на мой вопрос</label><input id=\"bad_header\" name=\"category\" type=\"radio\" value=\"bad_header\"/><label for=\"bad_header\">Содержание статьи не соответствует заголовку</label><input id=\"other_reason\" name=\"category\" type=\"radio\" value=\"other_reason\"/><label for=\"other_reason\">Другая причина</label></div><div class=\"feedback__popup\" id=\"feedback__popup-other\"><button class=\"feedback-popup-close\" type=\"button\">×</button> <div class=\"feedback__popup-header\">Расскажите, что вам не понравилось в статье:</div><textarea class=\"feedback__textarea\" id=\"\" name=\"other\"></textarea><input class=\"feedback__other-btn\" type=\"submit\" value=\"Отправить\"/></div><div class=\"feedback-form__btn-group\"><input id=\"feedback__useful_yes\" name=\"useful\" type=\"radio\" value=\"true\"/><label for=\"feedback__useful_yes\"><img src=\"like.svg\"/><span class=\"feedback-form__btn-group_yes-btn\">Да</span></label><input id=\"feedback__useful_no\" name=\"useful\" type=\"radio\" value=\"false\"/><label for=\"feedback__useful_no\"><img src=\"dislike.svg\"/><span class=\"feedback-form__btn-group_no-btn\">Нет</span></label></div><select name=\"category\"><option disabled=\"\">Выберите вариант</option><option selected=\"\" value=\"bad_recommendation\">Рекомендации не помогли</option><option value=\"difficult_text\">Текст трудно понять</option><option value=\"no_answer\">Нет ответа на мой вопрос</option><option value=\"bad_header\">Содержание статьи не соответствует заголовку</option><option value=\"other_reason\">Другая причина</option></select><input type=\"submit\"/></form></div></div>\n</section>\n</div>\n<aside class=\"article__sidebar\" style=\"display:none\">\n<input type=\"checkbox\"/>\n<div class=\"article__arrow\"></div>\n<div class=\"table-of-contents elma365-right\" id=\"toc2Content\">\n<h3 class=\"h3-toc\">В этой статье</h3>\n<nav id=\"toc2\"></nav>\n</div>\n</aside>\n</div>\n</article>\n</main>\n<footer class=\"footer\">\n<div class=\"footer-container\">\n<div class=\"footer-mobile\">\n<ul class=\"footer-mobile__list\"><li><a href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li><a href=\"https://tssdk.elma365.com/\" target=\"_blank\">TS SDK</a></li><li><a href=\"https://community.elma365.com/\" target=\"_blank\">Community</a></li><li><a href=\"https://elma-academy.com/ru/elma365\" target=\"_blank\">Академия</a></li></ul><ul class=\"footer-mobile__list\"><li><a href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">ECM</a></li><li><a href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li></ul>\n</div>\n<div class=\"container\">\n<div class=\"footer-wrap\">\n<div><span class=\"mobile-question-popup\">Отправить фидбэк</span><form action=\"\" class=\"question__popup question-xs\" id=\"question__popup\" method=\"POST\"><div class=\"question-wrap\"><span class=\"close\"></span><span class=\"title\">Задать вопрос</span><label for=\"help_question\" style=\"display: none;\"></label><textarea id=\"help_question\" name=\"help_question\"></textarea><input type=\"submit\" value=\"Отправить\"/></div></form><div class=\"hidden fade-in question-success-xs\">Ваш фидбэк отправлен.</div></div>\n<div class=\"footer-flex-b\">\n<div class=\"footer-top\">\n<span class=\"footer-copy\">© 2025 \n              ELMA365\n            \n            \n          </span>\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</div>\n<div class=\"footer-line\">\n<div class=\"footer-line-copy\">\n<span class=\"footer-copy\">© 2025 \n                  ELMA365\n                \n                \n              </span>\n</div>\n<ul class=\"footer-list\">\n<li class=\"footer-item footer-url-elma\"><a class=\"footer-link footer-url-link-elma\" href=\"https://elma365.com/ru/\" style=\"color: #0D4A75;\" target=\"_blank\"><img alt=\"browse icon\" class=\"footer-img footer-img-elma-url\" src=\"browse.svg\"/>elma365.com</a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vkvideo.ru/@elma_bpm\" target=\"_blank\"><img alt=\"vk-video icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk-video.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vk.com/elma_bpm\" target=\"_blank\"><img alt=\"vk icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://t.me/elmaday\" target=\"_blank\"><img alt=\"telegram icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"telegram.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://dzen.ru/elma\" target=\"_blank\"><img alt=\"dzen icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"social_dzen.svg\" width=\"20\"/></a></li>\n<li class=\"footer-item sk-footer-img\">\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<a class=\"arrow-top\" href=\"#\"></a>\n</div>\n</footer>\n<!--    <script type=\"text/javascript\" src=\"jquery1.min.js\"></script>-->\n<iframe name=\"hmnavigation\" style=\"display:none!important\"></iframe>\n<!--<script src=\"./jquery-ui.js\"></script> -->\n<script src=\"./jquery-ui.min.js\"></script>\n<!--script src=\"//cdn.jsdelivr.net/npm/featherlight@1.7.14/release/featherlight.min.js\" type=\"text/javascript\" charset=\"utf-8\"></script-->\n<script src=\"./jquery.tocify.min.js\"></script>\n<script src=\"./TypoReporter.min.js\"></script>\n<script src=\"./google-search.js\"></script>\n<script src=\"./main.js\"></script>\n</body>\n</html>\n",
  "plain_text": "Интеграция с IP-телефонией через пользовательский модуль ﻿ Платформа CSP CRM+CX Проекты Service КЭДО Бизнес-решения Academy Community API SDK Сайт ELMA365 Модули расширения системы > Примеры модулей интеграции с ELMA365 / Интеграция с IP-телефонией через пользовательский модуль Интеграция с IP-телефонией через пользовательский модуль Вы можете настроить интеграцию с провайдерами IP-телефонии, чтобы сотрудники могли совершать и принимать звонки от клиентов. Для этого используйте: готовые модули из каталога ELMA365 Store : Гравител , SIPNET , Zadarma , MANGO OFFICE , Sipuni , Билайн , Asterisk (доступен только для ELMA365 On-Premises); пользовательский модуль. Чтобы принимать и инициировать вызовы, нужно соединить модуль с провайдером. Начало внимание Функциональные возможности телефонии доступны при активации одного из платных решений CRM , в состав которого входит решение ELMA365 Управление коммуникациями . Конец внимание Чтобы настроить интеграцию с помощью пользовательского модуля: Выполните предварительные настройки , например, проверьте доступ к аккаунту телефонии, установите SIP-софтфон и т. д. Создайте модуль и в его скриптах пропишите методы Web API, чтобы получить сгенерированный Webhook и токен для обмена данными с провайдером телефонии. Соедините модуль с провайдером — в настройках на стороне провайдера укажите токен и Webhook, а в модуль скопируйте ключ авторизации и URL телефонной станции. Чтобы пользователи могли обработать звонок в его карточке, например принять или переназначить вызов и т. д., добавьте в скрипты модуля соответствующие методы Web API. В статье рассмотрен пример интеграции с телефонией Гравител. Подробнее о настройке интеграции при помощи пользовательского модуля читайте в справке ELMA365 TS SDK . Предварительные настройки для интеграции с телефонией Перед началом настройки: Проверьте, что ваш аккаунт у выбранного провайдера телефонии активен. Ознакомьтесь с условиями и сроком хранения записи звонка на сервере провайдера. В течение этого срока в интерфейсе ELMA365 пользователь может прослушать и загрузить запись себе на компьютер. Если запись удалена, появится сообщение об ошибке. Убедитесь, что в настройках провайдера можно указать Webhook системы. С его помощью будут обрабатываться HTTP-запросы о событиях телефонии. Если такой возможности нет, создайте промежуточный сервис, который преобразует данные провайдера в запрос на сервер ELMA365. Подробнее читайте в статье «Переносимые сервисы в модулях» . Для совершения и приёма звонков на рабочих местах сотрудников убедитесь, что провайдер предоставляет SIP-софтфон. В противном случае установите облачную или локальную программу, которая поддерживает SIP-протокол и обеспечивает голосовую связь, например, MicroSip. Чтобы использовать телефонию для работы с продажами, активируйте одно из системных решений CRM . Без лицензии функциональные возможности CRM недоступны. Создать пользовательский модуль интеграции с телефонией Перейдите в раздел Администрирование > Модули и в правом верхнем углу нажмите кнопку + Модуль . В открывшемся окне выберите опцию Создать , введите название и описание модуля. Нажмите кнопку Создать . На странице управления модулем перейдите на вкладку Методы API и нажмите кнопку Редактировать . На открывшейся странице перейдите на вкладку Скрипты . Вставьте код-заготовку для методов, которые реализуют интеграцию и обмен данными с телефонией. // Проверить соединение с телефонией async function VoipTestConnection(): Promise<VoipTestConnectionResult> { return { success: false , failReason: 'Функция проверки соединения не реализована.', }; } // Обработать запрос от провайдера IP-телефонии async function VoipParseWebhookRequest(request: FetchRequest): Promise<VoipWebhookParseResult> { return { response: new HttpResponse() .status(400) .content('Hello, world!'), }; } // Получить список пользователей IP-телефонии async function VoipGetMembers(): Promise<VoipMember[]> { throw new Error('Функция не реализована.'); } // Сгенерировать звонок async function VoipGenerateCall(srcPhone: string, dstPhone: string): Promise< void > { throw new Error('Функция не реализована.'); } // Получить ссылку на запись звонка async function VoipGetCallLink(callData: any): Promise<string> { throw new Error('Функция не реализована.'); } Сохраните и опубликуйте изменения. На странице модуля отобразятся разделы: Настройки телефонии , где указаны автоматически сгенерированные токен и Webhook; Настройки обработки входящего звонка , где по умолчанию выбрано приложение для хранения контактных данных клиентов. Соединить модуль с провайдером телефонии Рассмотрим настройку интеграции пользовательского модуля с провайдером на примере телефонии Гравител. На странице модуля перейдите на вкладку Настройки и добавьте два строковых поля Ключ для авторизации в облачной АТС ( apiKey ) и Адрес облачной АТС ( endpoint ). В эти поля позднее вы запишете данные из настроек провайдера для подключения к Гравител. Вернитесь на страницу модуля — на ней появятся добавленные в предыдущем пункте поля. Cкопируйте значения полей Webhook URL и Токен . Перейдите в панель управления Гравител. Интеграция настраивается по Web API Гравител предыдущего поколения. В зависимости от версии личного кабинета, которую вы используете, выполните следующие шаги: для актуальной версии — перейдите в Интеграции и выберите блок API Гравител . Нажмите Установить ; для предыдущей версии — перейдите в Интеграция с CRM и на открывшейся странице в правом нижнем углу выберите Интеграции с вашей CRM . На открывшейся странице заполните поля Название интеграции, Ваша CRM , Адрес вашей CRM и Ключ для авторизации в вашей CRM значениями из настроек модуля. Затем скопируйте значения полей Ключ для авторизации в Облачной АТС и Адрес Облачной АТС . Перейдите в ELMA365 и вставьте их в соответствующие поля на странице модуля. Подробнее о настройке интеграции в личном кабинете Гравител читайте в статье «Телефония Гравител» . Сохраните настройки в панели управления Гравител и на странице модуля. Перейдите на страницу управления модулем и откройте вкладку Методы API > Скрипты . Нажмите кнопку Редактировать и добавьте в начало скрипта следующий код: // Загрузить значение поля Ключ для авторизации в облачной АТС из настроек модуля function getApiKey() { const apiKey = Namespace.params.data.apiKey; if (!apiKey) { throw new Error('invalid API key'); } return apiKey; } // Загрузить значение поля Адрес облачной АТС из настроек модуля function getEndpoint() { const endpoint = Namespace.params.data.endpoint; if (!endpoint) { throw new Error('invalid endpoint URL'); } return endpoint; } // Выполнить запрос к Гравител async function fetchEndpoint(command: string, body: Object = {}): Promise<FetchResponse> { return fetch(getEndpoint(), { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ cmd: command, token: getApiKey(), ...body, }), }); } // Распарсить контент с типом application/x-www-form-urlencoded function parseUrlEncoded(body: string): Record<string, string> { const result: Record<string, string> = {}; for ( const pair of body.split('&')) { const keyValue = pair.split('='); if (keyValue.length === 2) { const key = decodeURIComponent(keyValue[0]); const value = decodeURIComponent(keyValue[1]); result[key] = value; } } return result; } // Сообщение от Гравител interface GravitelWebhookRequest { cmd: string; // Тип операции type : string; // Тип события, связанного со звонком phone: string; // Номер телефона клиента (в формате E.164) ext?: string; // Внутренний номер пользователя облачной АТС, если есть } // Данные, передающиеся с командой history interface GravitelWebhookHistoryCommand extends GravitelWebhookRequest { duration: string; // Общая длительность звонка в секундах callid: string; // Уникальный id звонка link?: string; // Ссылка на запись звонка, если она включена в Облачной АТС status: string; // Статус входящего или исходящего звонка } // Данные, которые сохраняются с каждым звонком interface GravitelCallData { id: string; link: string; } // Сконвертировать статус звонка Гравител в статус звонка ELMA365 function toCallDisposition(status: string): VoipCallDisposition { switch (status) { case 'Success': return VoipCallDisposition.Answered; case 'Busy': return VoipCallDisposition.Busy; case 'Missed': return VoipCallDisposition.Cancel; case 'NotAvailable': return VoipCallDisposition.NoAnswer; case 'NotAllowed': default : return VoipCallDisposition.Unknown; } } Добавьте или замените метод VoipTestConnection , который позволяет проверить соединение с телефонией. В данном примере тестируется команда для получения списка пользователей. Вы можете указать другую команду. // Проверить соединение к телефонии async function VoipTestConnection(): Promise<VoipTestConnectionResult> { try { // Выполняем команду для получения списка пользователей телефонии const response = await fetchEndpoint('accounts'); const message = await response.json(); if (response.status !== 200) { throw new Error(`${response.status} ${response.statusText}: ${message.error}`); } return { success: true }; } catch (e) { return { success: false , failReason: e.message, }; } } Сохраните и опубликуйте скрипты, после чего перейдите на страницу модуля и нажмите кнопку Проверить соединение . Появится сообщение об успешном подключении к телефонии. Если вы видите ошибку при проверке соединения: убедитесь, что поля на странице модуля и в панели управления Гравител заполнены корректно. Например, ошибка «Invalid token» означает, что неверно заполнено поле Токен ; проверьте, что скрипты составлены без ошибок, а также успешно сохранены и опубликованы; убедитесь, что ваш аккаунт Гравител активен. После этого добавьте или замените следующие методы для интеграции с Гравител: метод VoipParseWebhookRequest — позволяет модулю обработать данные из HTTP-запроса от провайдера и передать их в ELMA365; // Обработать запрос от провайдера IP-телефонии async function VoipParseWebhookRequest(request: FetchRequest): Promise<VoipWebhookParseResult> { try { const headers = request.headers; const contentType = headers ? headers['Content-Type'] : undefined; if (contentType !== 'application/x-www-form-urlencoded') { throw new Error(`Expected Content-Type to be \"application/x-www-form-urlencoded\" (got: \"${contentType}\"`); } if (typeof request.body !== 'string') { throw new Error('Expected request body to be string') } let event: VoipWebhookRequest | undefined; let callRecord: VoipCallRecord | undefined; let response: HttpResponse | undefined; const data = <GravitelWebhookRequest><unknown> parseUrlEncoded(request.body); switch (data.cmd) { case 'event': { // Облачная АТС отправляет в вашу CRM уведомления о событиях входящих звонков пользователям: появлении, принятии или завершении звонка. Команда может быть использована для отображения всплывающей карточки клиента в интерфейсе CRM const dstPhone = data.ext ?? ''; switch (data.type) { case 'INCOMING': { // Пришёл входящий звонок. В это время у менеджера должен начать звонить телефон event = { event: VoipWebhookEvent.NotifyStart, direction: VoipCallDirection.In, dstPhone: dstPhone, srcPhone: data.phone, disposition: VoipCallDisposition.Unknown, }; } break; case 'ACCEPTED': { // Звонок успешно принят, т. е. менеджер снял трубку. В этот момент можно убрать всплывающую карточку контакта в CRM event = { event: VoipWebhookEvent.NotifyAnswer, direction: VoipCallDirection.In, dstPhone: dstPhone, srcPhone: data.phone, disposition: VoipCallDisposition.Unknown, } } break; case 'COMPLETED': { // Звонок успешно завершён, т. е. менеджер или клиент положили трубку после разговора event = { event: VoipWebhookEvent.NotifyEnd, direction: VoipCallDirection.In, dstPhone: dstPhone, srcPhone: data.phone, disposition: VoipCallDisposition.Unknown, } } break; case 'CANCELLED': { // Звонок сброшен, т.е. клиент не дождался пока менеджер снимет трубку. Либо, если это был звонок сразу на группу менеджеров, на звонок мог ответить кто-то ещё event = { event: VoipWebhookEvent.NotifyEnd, direction: VoipCallDirection.In, dstPhone: dstPhone, srcPhone: data.phone, disposition: VoipCallDisposition.Cancel, } } break; case 'OUTGOING': { // Менеджер совершает исходящий звонок. В это время облачная АТС пытается дозвониться до клиента event = { event: VoipWebhookEvent.NotifyStart, direction: VoipCallDirection.Out, dstPhone: dstPhone, srcPhone: data.phone, disposition: VoipCallDisposition.Unknown, } } break; default: throw new Error(`Unknown event type \"${data.type}\"`) } } break; case 'history': { // После успешного звонка в CRM отправляется запрос с данными о звонке и ссылкой на запись разговора. Команда может быть использована для сохранения в данных ваших клиентов истории и записей входящих и исходящих звонков const cmd = <GravitelWebhookHistoryCommand> data; callRecord = { srcPhone: cmd.phone, dstPhone: cmd.ext ?? '', direction: cmd.type === 'out' ? VoipCallDirection.Out : VoipCallDirection.In, duration: parseInt(cmd.duration), // Данные из этого поля будут доступны в функции VoipGetCallLink call: <GravitelCallData>{ link: cmd.link, id: cmd.callid, }, disposition: toCallDisposition(cmd.status), } } break; } return { event: event, callRecord: callRecord, response: response, }; } catch (e) { return { response: new HttpResponse() .status(400) .content(JSON.stringify({ error: e.message ?? 'internal error', })) }; } } метод VoipGetMembers — позволяет получить данные о пользователях телефонии. Эти данные отображаются на странице модуля при сопоставлении пользователей провайдера и пользователей ELMA365; // Получить список пользователей от провайдера IP-телефонии async function VoipGetMembers(): Promise<VoipMember[]> { const response = await fetchEndpoint('accounts'); if (response.status !== 200) { throw new Error(`received error response ${response.status}: ${response.statusText}`); } interface GravitelVoipUser { name: string; ext: string; } const voipUsers = <GravitelVoipUser[]> (await response.json()); return voipUsers.map(user => ({ id: user.ext, label: user.name, })); } метод VoipGenerateCall — позволяет инициировать звонок из интерфейса ELMA365; // Сгенерировать звонок async function VoipGenerateCall(srcPhone: string, dstPhone: string): Promise< void > { const response = await fetchEndpoint('makeCall', { phone: dstPhone, user: srcPhone, }); if (response.status !== 200) { throw new Error(`received error response ${response.status}: ${response.statusText}`); } } метод VoipGetCallLink — позволяет сохранить запись разговора. В качестве аргумента передаются данные из поля call параметра VoipCallRecord (заполняется в методе VoipParseWebhookRequest ). // Получить ссылку на запись разговора async function VoipGetCallLink(callData: GravitelCallData): Promise<string> { return callData.link; } Чтобы реализовать функциональность кнопок для обработки звонка в его карточке, добавьте методы, перечисленные в справке ELMA365 TS SDK . Сохраните и опубликуйте скрипты. На странице модуля нажмите на появившуюся кнопку Настроить и сопоставьте номера пользователей из настроек провайдера с пользователями ELMA365. Подробнее читайте в статье «Телефония Гравител» . Сохраните настройки. Теперь интеграция с Гравител полностью функционирует. dadata_integration.html 360009906679.html Была ли статья полезной? Спасибо за ваш отзыв! × Ваш отзыв успешно отправлен! Спасибо за обратную связь. × Уточните, почему: Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина × Расскажите, что вам не понравилось в статье: Да Нет Выберите вариант Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина В этой статье API TS SDK Community Академия Платформа ECM Service Проекты Отправить фидбэк Задать вопрос Ваш фидбэк отправлен. © 2025 ELMA365 © 2025 ELMA365 elma365.com",
  "links": [
    "https://elma365.com/ru/help",
    "https://elma365.com/ru/help/platform/get-trial.html",
    "https://elma365.com/ru/help/ecm/ecm-functions.html",
    "https://elma365.com/ru/help/crm/crm-functions.html",
    "https://elma365.com/ru/help/projects/projects-functions.html",
    "https://elma365.com/ru/help/service/service-functions.html",
    "https://elma365.com/ru/help/kedo/kedo.html",
    "https://elma365.com/ru/help/business_solutions/-elma365-store.html",
    "https://elma-academy.com/ru/",
    "https://community.elma365.com/ru/",
    "https://api.elma365.com/ru/",
    "https://tssdk.elma365.com/latest/",
    "https://elma365.com/ru/",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/360024498352.html",
    "https://store.elma365.ru/",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/telephony-gravitel.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/telephony-sipnet.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/telephony-zadarma.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/mango.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/sipuni.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/beeline.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/asterisk.html",
    "https://elma365.com/ru/help/crm/licenses-crm.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/ip-tel-integration.html",
    "https://elma365.com/ru/help/crm/work-with-call.html",
    "https://tssdk.t-elma365.com/ru/develop/modules/_201_integration_voip_.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/portable-microservices.html",
    "https://elma365.com/ru/help/business_solutions/telephony-gravitel.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/dadata_integration.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/360009906679.html",
    "https://tssdk.elma365.com/",
    "https://community.elma365.com/",
    "https://elma-academy.com/ru/elma365",
    "https://navigator.sk.ru/orn/1122971",
    "https://vkvideo.ru/@elma_bpm",
    "https://vk.com/elma_bpm",
    "https://t.me/elmaday",
    "https://dzen.ru/elma"
  ],
  "last_crawled": "2025-11-29T22:03:06.602585",
  "metadata": {
    "depth": 10,
    "saved_at": "2025-11-29T22:03:06.713226"
  }
}