{
  "doc_id": "two-factor-integration",
  "url": "https://elma365.com/ru/help/business_solutions/ru/help/crm/two-factor-integration.html",
  "title": "Пользовательский модуль для двухфакторной аутентификации",
  "breadcrumbs": [
    "Модули расширения системы"
  ],
  "section": "Модули расширения системы | [business_solutions]",
  "html": "<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n<title>Пользовательский модуль для двухфакторной аутентификации</title>\n<meta content=\"Help+Manual\" name=\"generator\"/>\n<meta content=\"\" name=\"keywords\"/>\n<meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\"/>\n<meta content=\"IE=edge\" http-equiv=\"X-UA-Compatible\"/>\n<meta content=\"width=device-width, initial-scale=1.0\" name=\"viewport\"/>\n<meta content=\"Вы можете включить двухэтапную аутентификацию при входе в систему или на внешний портал, чтобы в качестве второго фактора использовался код подтверждения. Пользователь получит...\" name=\"description\"/>\n<meta content=\"\" name=\"picture\"/>\n<meta content=\"website\" property=\"og:type\"/>\n<meta content=\"Cправка по Low-code платформе ELMA365\" property=\"og:title\"/>\n<meta content=\"https://elma365.com/ru/help\" property=\"og:url\"/>\n<meta content=\"\" property=\"og:image\"/>\n<meta content=\"ELMA365\" property=\"og:site_name\"/>\n<link href=\"favicon.png\" rel=\"icon\" type=\"image/png\"/>\n<link href=\"https://elma365.com/ru/help/platform/two-factor-integration.html\" rel=\"canonical\"/>\n<link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap\" rel=\"stylesheet\"/>\n<link href=\"./jquery-ui.min.css\" rel=\"stylesheet\"/>\n<link href=\"default.css\" rel=\"stylesheet\"/>\n<link href=\"./search-yandex.css\" rel=\"stylesheet\"/>\n<link href=\"./article.css\" rel=\"stylesheet\"/>\n<link href=\"./glossary.css\" rel=\"stylesheet\"/>\n<link href=\"./theme.css\" rel=\"stylesheet\"/>\n<link href=\"./tooltipster.bundle.min.css\" rel=\"stylesheet\" type=\"text/css\"/>\n<script src=\"jquery.js\" type=\"text/javascript\"></script>\n<script src=\"./tooltipster.bundle.min.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n        $(document).ready($('.tooltip').tooltipster({\n            contentCloning: true,\n            theme: 'tooltipster-borderless',\n        }));\n    </script>\n<script src=\"helpman_settings.js\" type=\"text/javascript\"></script>\n<script src=\"helpman_topicinit.js\" type=\"text/javascript\"></script>\n<script src=\"highlight.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n     $(document).ready(function(){highlight();});\n   </script>\n</head>\n<body>\n<script async=\"\" src=\"https://www.googletagmanager.com/gtag/js?id=G-M6ETBEC1R9\"></script><script>window.dataLayer=window.dataLayer || []; function gtag(){dataLayer.push(arguments);}gtag('js', new Date()); gtag('config', 'G-M6ETBEC1R9');</script>\n<script>!function(e,t,c,n,r,a,m){e.ym=e.ym||function(){(e.ym.a=e.ym.a||[]).push(arguments)},e.ym.l=1*new Date;for(var s=0;s<document.scripts.length;s++)if(document.scripts[s].src===n)return;a=t.createElement(c),m=t.getElementsByTagName(c)[0],a.async=1,a.src=n,m.parentNode.insertBefore(a,m)}(window,document,\"script\",\"https://mc.yandex.ru/metrika/tag.js\"),ym(83179930,\"init\",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0})</script><noscript><div><img alt=\"\" src=\"https://mc.yandex.ru/watch/83179930\" style=\"position:absolute;left:-9999px\"/></div></noscript> \n    \n    ﻿<header class=\"header elma-365\">\n<div class=\"container\">\n<div class=\"nav-container\">\n<div class=\"nav-wrap\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<div class=\"header__navi\">\n<ul class=\"header__list\"><li><span class=\"solution-select\"><span class=\"solution-select__selected\"></span><svg fill=\"none\" height=\"4\" viewbox=\"0 0 7 4\" width=\"7\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M1 1L3.5 3.5L6 1\" stroke=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg><ul class=\"solution-select__list\"><li class=\"header__list-item\"><a class=\"project-link\" href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">CSP</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/crm/crm-functions.html\">CRM+CX</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/kedo/kedo.html\">КЭДО</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/business_solutions/-elma365-store.html\">Бизнес-решения</a></li><ul class=\"social-links-header\"><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://elma-academy.com/ru/\" target=\"_blank\">Academy</a></li><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://community.elma365.com/ru/\" target=\"_blank\">Community</a></li><li></li></ul></ul></span></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://tssdk.elma365.com/latest/\" target=\"_blank\">SDK</a></li><li class=\"header__list-item header__list-item-latest\"><a class=\"header__list-item-url header__list-item-last\" href=\"https://elma365.com/ru/\" target=\"_blank\">Сайт ELMA365</a></li></ul>\n<div class=\"hero-wrap\" style=\"display: flex; align-items: center;\">\n<div class=\"hero__search\" style=\"display: flex; justify-content: space-between; width: 100%; padding-left: 0;\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<button class=\"hero__search-icon\" id=\"search-icon\">\n<img alt=\"search string\" src=\"search-icon-white.svg\"/>\n</button>\n<div class=\"hero__search-form\" id=\"search-panel\"><form class=\"search-form\"><label class=\"search-form__label\"><span class=\"search__icon\" id=\"reset-search\" src=\"Union.svg\"></span><input class=\"search-form__input\" type=\"text\"/></label><input class=\"search-form__submit\" type=\"submit\" value=\"Submit\"/></form></div>\n</div>\n</div>\n</div>\n</div>\n<a class=\"hero__side-icon\" href=\"#\" id=\"side-menu-icon\">\n<img alt=\"side menu\" src=\"side_menu.svg\"/>\n</a>\n</div>\n</div>\n</header>\n<main class=\"main container\">\n<aside class=\"sidebar\" id=\"sidebar\">\n<div class=\"sidebar__header\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img src=\"./logo-light.svg\"/>\n</a>\n<span class=\"sidebar__close elma-365-close\" id=\"close\"></span>\n</div>\n<div class=\"sidebar__wrapper\" id=\"side-menu\">\n</div>\n</aside>\n<article class=\"article\" id=\"article\">\n<div class=\"article-inner\">\n<div class=\"content\">\n<header class=\"article__header\">\n<div class=\"article__bread\" style=\"display:flex; gap:8px;\">\n<span class=\"search-res__item-category search-res__item-category_subcategory subcategory article__badge\" id=\"subcategory\"></span>\n<nav class=\"topic__breadcrumbs\">\n<p><a href=\"360024498352.html\">Модули расширения системы</a> &gt; Примеры модулей интеграции с ELMA365 / Пользовательский модуль для двухфакторной аутентификации</p>\n</nav>\n</div>\n<div class=\"topic__title\"><h1 class=\"p_Heading1\"><span class=\"f_Heading1\">Пользовательский модуль для двухфакторной аутентификации</span></h1>\n</div>\n</header>\n<section class=\"article__content\">\n<div class=\"scroll-top-inner\">\n<a class=\"scroll-top\" href=\"#h1-article\"></a>\n</div>\n<!-- Placeholder for topic body. -->\n<p class=\"p_Normal\">Вы можете включить двухэтапную аутентификацию при входе в систему или на <a class=\"topiclink\" href=\"service-portal.html\">внешний портал</a>, чтобы в качестве второго фактора использовался код подтверждения. Пользователь получит этот код через сторонний сервис, например мессенджер. </p>\n<p class=\"p_Normal\">Для этого создайте <a class=\"topiclink\" href=\"extentions.html\">пользовательский модуль</a> и затем выберите его:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">в <a class=\"topiclink\" href=\"security_settings.html#authorization\">настройках безопасности</a>, чтобы включить двухфакторную аутентификацию при входе в систему;</li><li class=\"p_Normal\">в <a class=\"topiclink\" href=\"portal-login-page.html#two-factor\">настройках портала</a> на вкладке <span style=\"font-weight: bold;\">Авторизация</span>, чтобы включить двухфакторную аутентификацию при входе на портал для внутренних пользователей.</li></ul>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">начало внимание</span></p>\n<p class=\"p_Normal\">Работать с модулями и настраивать их могут только пользователи, включённые в группу <a class=\"topiclink\" href=\"360006871932.html#administrators\">Администраторы</a>.</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">конец внимание</span></p>\n<p class=\"p_Normal\">Для примера настроим получение кода подтверждения через Telegram-бот, выполнив шаги:</p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"1\">Настроить получение кода из стороннего сервиса.</li><li class=\"p_Normal\" value=\"2\">Создать и настроить модуль.</li><li class=\"p_Normal\" value=\"3\">Включить модуль для второго фактора аутентификации.</li></ol>\n<h2 class=\"p_Heading2\"><span class=\"f_Heading2\">Шаг 1. Настроить получение кода из стороннего сервиса</span> </h2>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Перейдите в Telegram.</li><li class=\"p_Normal\" value=\"2\">Создайте бота. Подробнее читайте в <a class=\"weblink\" href=\"https://core.telegram.org/bots/tutorial\" target=\"_blank\">официальной документации Telegram</a>.</li><li class=\"p_Normal\" value=\"3\">Скопируйте токен бота.</li><li class=\"p_Normal\" value=\"4\">С помощью токена получите идентификатор чата для пользователя. Вы можете использовать следующий способ:</li></ol>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"1\">Пользователь пишет любое сообщение созданному боту.</li><li class=\"p_Normal\" style=\"page-break-inside: avoid; page-break-after: avoid;\" value=\"2\">Администратор системы получает идентификатор чата пользователя с ботом. Для этого:</li></ol>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\" style=\"page-break-inside: avoid; page-break-after: avoid;\">введите следующий запрос в браузере: <code><b>https://api.telegram.org/bottoken/getUpdates</b></code>, где <code><b>token</b></code> — токен, полученный при создании бота;</li><li class=\"p_Normal\" style=\"page-break-after: avoid;\">в ответ на этот запрос на странице браузера появится JSON-текст, в котором содержится идентификатор чата.</li></ul>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A1')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Пример JSON-текста</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A1\" style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_CodeExample\" style=\"white-space: normal; page-break-inside: avoid;\"><span class=\"f_CodeExample\">{</span><br/>\n<span class=\"f_CodeExample\">  \"ok\": true,</span><br/>\n<span class=\"f_CodeExample\">  \"result\": [</span><br/>\n<span class=\"f_CodeExample\">    {</span><br/>\n<span class=\"f_CodeExample\">      \"update_id\": 000000000,</span><br/>\n<span class=\"f_CodeExample\">      \"message\": {</span><br/>\n<span class=\"f_CodeExample\">        \"message_id\": 17,</span><br/>\n<span class=\"f_CodeExample\">        \"from\": {</span><br/>\n<span class=\"f_CodeExample\">          \"id\": 0000000001,</span><br/>\n<span class=\"f_CodeExample\">          \"is_bot\": false,</span><br/>\n<span class=\"f_CodeExample\">          \"first_name\": \"UserName\",</span><br/>\n<span class=\"f_CodeExample\">          \"language_code\": \"ru\"</span><br/>\n<span class=\"f_CodeExample\">        },</span><br/>\n<span class=\"f_CodeExample\">        \"chat\": {</span><br/>\n<span class=\"f_CodeExample\">          \"id\": 0000000001,</span><br/>\n<span class=\"f_CodeExample\">          \"first_name\": \"UserName\",</span><br/>\n<span class=\"f_CodeExample\">          \"type\": \"private\"</span><br/>\n<span class=\"f_CodeExample\">        },</span><br/>\n<span class=\"f_CodeExample\">        \"date\": 1724073228,</span><br/>\n<span class=\"f_CodeExample\">        \"text\": \"Привет\"</span><br/>\n<span class=\"f_CodeExample\">      }</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">  ]</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n</td>\n</tr>\n</table>\n</div>\n<ol start=\"5\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"5\">В профиле пользователя укажите его идентификатор чата в поле <a class=\"topiclink\" href=\"360004833572.html#accounts\">Учетные записи</a>. Если идентификатор не указан, сотрудник войдёт в систему только по логину и паролю. </li></ol>\n<h2 class=\"p_Heading2\"><span class=\"f_Heading2\">Шаг 2. Создать и настроить модуль</span></h2>\n<p class=\"p_Normal\">Перейдите в <span style=\"font-weight: bold;\">Администрирование &gt; Модули</span> и <a class=\"topiclink\" href=\"create-extention.html\">создайте модуль</a>. Затем выполните настройки на открывшейся странице <span style=\"font-weight: bold;\">Управление</span>:</p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">На вкладке <a class=\"topiclink\" href=\"extention-settings.html\">Настройки</a> создайте свойства типа <a class=\"topiclink\" href=\"360009707032.html#string\">Строка</a>, которые будут использованы в скриптах для получения кода подтверждения через бот мессенджера:</li></ol>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><span style=\"font-weight: bold;\">Тип аккаунта</span> (<code><b>accountType</b></code>) — название стороннего сервиса, через который настраивается двухфакторная аутентификация;</li><li class=\"p_Normal\"><span style=\"font-weight: bold;\">Токен бота</span> (<code><b>botToken</b></code>) — идентификатор бота на стороне внешнего сервиса. Выдаётся при создании бота;</li><li class=\"p_Normal\"><span style=\"font-weight: bold;\">Сообщение</span> (<code><b>message</b></code>) — сообщение, которое получит пользовать вместе с кодом подтверждения, например «Вы заходите в ELMA365. Ваш проверочный код: ».</li></ul>\n<p class=\"p_Normal\">Если все свойства указаны, перейдите на вкладку <span style=\"font-weight: bold;\">Основные</span> и нажмите <span style=\"font-weight: bold;\">Сохранить</span>.</p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Перейдите на вкладку <span style=\"font-weight: bold;\">Методы API</span> и нажмите <span style=\"font-weight: bold;\">Редактировать</span>. Откроется редактор методов. На вкладке <span style=\"font-weight: bold;\">Скрипты</span> напишите код, используя следующий шаблон:</li></ol>\n<p class=\"p_CodeExample\" style=\"white-space: normal; page-break-inside: avoid;\"><span class=\"f_CodeExample\">// Интерфейс позволят задать условия в указанной ниже функции, при которых у пользователя будет запрашиваться код второго фактора аутентификации</span><br/>\n<span class=\"f_CodeExample\">interface SecondFactor_sendError { error: string; skip2fa: boolean; }</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">// Функция определяет входящего пользователя по идентификатору и принимает код подтверждения</span><br/>\n<span class=\"f_CodeExample\">async function secondFactor_sendCode(userID: string, code: string): Promise&lt;SecondFactor_sendError&gt; {} </span></p>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A2')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Пример скрипта для поиска входящего пользователя по идентификатору чата с Telegram-ботом</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A2\" style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_CodeExample\" style=\"white-space: normal; page-break-inside: avoid;\"><span class=\"f_CodeExample\">interface SecondFactor_sendError {</span><br/>\n<span class=\"f_CodeExample\">    error: string;</span><br/>\n<span class=\"f_CodeExample\">    skip2fa: boolean;</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">async function secondFactor_sendCode(userID:string, code: string): Promise&lt;SecondFactor_sendError&gt;{</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">    let accountType = Namespace.params.data.accountType;</span><br/>\n<span class=\"f_CodeExample\">    const result:SecondFactor_sendError={error: \"\", skip2fa: false};</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">    const user = await System.users.search().where(f =&gt; f.__id.eq(userID)).first();</span><br/>\n<span class=\"f_CodeExample\">    if(!user){</span><br/>\n<span class=\"f_CodeExample\">        result.error = 'no user';</span><br/>\n<span class=\"f_CodeExample\">        return result</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\">    if (!user.data.accounts) {</span><br/>\n<span class=\"f_CodeExample\">        result.error = 'user has no accounts';</span><br/>\n<span class=\"f_CodeExample\">        result.skip2fa = true;</span><br/>\n<span class=\"f_CodeExample\">        return result;</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">    for (var account of user.data.accounts) {</span><br/>\n<span class=\"f_CodeExample\">        if (account.type === accountType) {</span><br/>\n<span class=\"f_CodeExample\">            sendToTelegram(account.login, code);</span><br/>\n<span class=\"f_CodeExample\">            return result;</span><br/>\n<span class=\"f_CodeExample\">        }</span><br/>\n<span class=\"f_CodeExample\">    }</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">    result.error = 'user has no such account type';</span><br/>\n<span class=\"f_CodeExample\">    result.skip2fa = true;</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">    return result;</span><br/>\n<span class=\"f_CodeExample\">}</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">function sendToTelegram(chatId: string, code: string):void {</span><br/>\n<span class=\"f_CodeExample\">   </span><br/>\n<span class=\"f_CodeExample\">    let botToken = Namespace.params.data.botToken;</span><br/>\n<span class=\"f_CodeExample\">    let message = Namespace.params.data.message;</span><br/>\n<span class=\"f_CodeExample\">    const method = 'sendMessage';</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">    fetch(\"https://api.telegram.org/bot\"+botToken+\"/\"+method,{</span><br/>\n<span class=\"f_CodeExample\">        method:\"POST\",</span><br/>\n<span class=\"f_CodeExample\">        headers: {</span><br/>\n<span class=\"f_CodeExample\">            'Content-Type': 'application/json'</span><br/>\n<span class=\"f_CodeExample\">        },</span><br/>\n<span class=\"f_CodeExample\">        body:JSON.stringify({'chat_id': chatId, 'text': message+code})</span><br/>\n<span class=\"f_CodeExample\">    });</span><br/>\n<span class=\"f_CodeExample\">}</span></p>\n</td>\n</tr>\n</table>\n</div>\n<h2 class=\"p_Heading2\"><span class=\"f_Heading2\">Шаг 3. Включить модуль для второго фактора аутентификации</span></h2>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Перейдите в <span style=\"font-weight: bold;\">Администрирование &gt; Модули</span>, откройте страницу модуля и включите его.</li><li class=\"p_Normal\" value=\"2\">В открывшемся окне заполните поля:</li></ol>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><span style=\"font-weight: bold;\">Токен бота</span> — значение скопированного токена;</li><li class=\"p_Normal\"><span style=\"font-weight: bold;\">Тип аккаунта</span> — название стороннего сервиса;</li><li class=\"p_Normal\"><span style=\"font-weight: bold;\">Сообщение</span> — текст, который нужно отобразить перед кодом подтверждения.</li></ul>\n<p class=\"p_Normal\"><img alt=\"2fa-integration-2\" height=\"327\" src=\"2fa-integration-2.png\" style=\"margin:0;width:851px;height:327px;border:none\" width=\"851\"/></p>\n<ol start=\"3\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Сохраните настройки. Модуль готов к использованию.</li><li class=\"p_Normal\" value=\"4\">Перейдите в <span style=\"font-weight: bold;\">Администрирование &gt; Настройки безопасности &gt; Двухфакторная аутентификация</span> и выберите настроенный <a class=\"topiclink\" href=\"security_settings.html#2fa\">модуль для второго фактора аутентификации</a>.</li></ol>\n<p class=\"p_Normal\">Теперь, если у пользователя в профиле указан его идентификатор чата с Telegram-ботом, сотруднику придёт код подтверждения при входе в систему.</p>\n<p class=\"p_Normal\"><img alt=\"2fa-integration-1\" height=\"221\" src=\"2fa-integration-1.png\" style=\"margin:0;width:419px;height:221px;border:none\" width=\"419\"/></p>\n<div class=\"bottom-nav\">\n<a class=\"topic__navi_prev\" href=\"external-oauth2-integration.html\" id=\"prev-link\">\n<span class=\"bottom-nav__arrow bottom-nav__arrow--prev\"></span> <span class=\"bottom-nav__link\">external-oauth2-integration.html</span>\n</a>\n<a class=\"topic__navi_next\" href=\"dadata_integration.html\" id=\"next-link\">\n<span class=\"bottom-nav__link\">dadata_integration.html</span> <span class=\"bottom-nav__arrow bottom-nav__arrow--next\"></span>\n</a>\n</div>\n<!-- добавляет на страницу строку блок Была ли статья полезной?  -->\n<div class=\"feedback-wrap\"><div class=\"feedback\" id=\"feedback\"><span><b>Была ли статья полезной?</b></span><form action=\"\" class=\"feedback-form\" id=\"feedback-form\" method=\"POST\"><div class=\"feedback__popup feedback__popup-response\" id=\"feedback__popup_thx\">Спасибо за ваш отзыв!</div><div id=\"feedback-success-popup\"><div class=\"wrap\"><button class=\"feedback-popup-close\" type=\"button\">×</button><svg fill=\"none\" height=\"44\" viewbox=\"0 0 44 44\" width=\"44\" xmlns=\"http://www.w3.org/2000/svg\"><g clip-path=\"url(#clip0_212_2187)\"><path d=\"M22 0.6875C10.2294 0.6875 0.6875 10.2294 0.6875 22C0.6875 33.7706 10.2294 43.3125 22 43.3125C33.7706 43.3125 43.3125 33.7706 43.3125 22C43.3125 10.2294 33.7706 0.6875 22 0.6875ZM22 40.5625C11.8023 40.5625 3.4375 32.3078 3.4375 22C3.4375 11.8024 11.6922 3.4375 22 3.4375C32.1977 3.4375 40.5625 11.6922 40.5625 22C40.5625 32.1976 32.3078 40.5625 22 40.5625ZM34.1713 16.933L18.6613 32.3186C18.257 32.7197 17.604 32.7171 17.203 32.3128L9.82283 24.873C9.42176 24.4686 9.42434 23.8157 9.82867 23.4146L10.5609 22.6884C10.9652 22.2873 11.6181 22.2899 12.0192 22.6942L17.9468 28.6697L31.9926 14.7366C32.3969 14.3356 33.0498 14.3382 33.4509 14.7425L34.1772 15.4747C34.5783 15.879 34.5757 16.532 34.1713 16.933Z\" fill=\"#27AE60\"></path></g><defs><clippath id=\"clip0_212_2187\"><rect fill=\"white\" height=\"44\" width=\"44\"></rect></clippath></defs></svg><p>Ваш отзыв успешно отправлен!</p><span>Спасибо за обратную связь.</span></div></div><div class=\"feedback__popup\" id=\"feedback__popup_why\"><button class=\"feedback-popup-close\" type=\"button\">×</button><div class=\"feedback__popup-header\">Уточните, почему:</div><input id=\"bad_recommendation\" name=\"category\" type=\"radio\" value=\"bad_recommendation\"/><label for=\"bad_recommendation\">Рекомендации не помогли</label><input id=\"difficult_text\" name=\"category\" type=\"radio\" value=\"difficult_text\"/><label for=\"difficult_text\">Текст трудно понять</label><input id=\"no_answer\" name=\"category\" type=\"radio\" value=\"no_answer\"/><label for=\"no_answer\">Нет ответа на мой вопрос</label><input id=\"bad_header\" name=\"category\" type=\"radio\" value=\"bad_header\"/><label for=\"bad_header\">Содержание статьи не соответствует заголовку</label><input id=\"other_reason\" name=\"category\" type=\"radio\" value=\"other_reason\"/><label for=\"other_reason\">Другая причина</label></div><div class=\"feedback__popup\" id=\"feedback__popup-other\"><button class=\"feedback-popup-close\" type=\"button\">×</button> <div class=\"feedback__popup-header\">Расскажите, что вам не понравилось в статье:</div><textarea class=\"feedback__textarea\" id=\"\" name=\"other\"></textarea><input class=\"feedback__other-btn\" type=\"submit\" value=\"Отправить\"/></div><div class=\"feedback-form__btn-group\"><input id=\"feedback__useful_yes\" name=\"useful\" type=\"radio\" value=\"true\"/><label for=\"feedback__useful_yes\"><img src=\"like.svg\"/><span class=\"feedback-form__btn-group_yes-btn\">Да</span></label><input id=\"feedback__useful_no\" name=\"useful\" type=\"radio\" value=\"false\"/><label for=\"feedback__useful_no\"><img src=\"dislike.svg\"/><span class=\"feedback-form__btn-group_no-btn\">Нет</span></label></div><select name=\"category\"><option disabled=\"\">Выберите вариант</option><option selected=\"\" value=\"bad_recommendation\">Рекомендации не помогли</option><option value=\"difficult_text\">Текст трудно понять</option><option value=\"no_answer\">Нет ответа на мой вопрос</option><option value=\"bad_header\">Содержание статьи не соответствует заголовку</option><option value=\"other_reason\">Другая причина</option></select><input type=\"submit\"/></form></div></div>\n</section>\n</div>\n<aside class=\"article__sidebar\" style=\"display:none\">\n<input type=\"checkbox\"/>\n<div class=\"article__arrow\"></div>\n<div class=\"table-of-contents elma365-right\" id=\"toc2Content\">\n<h3 class=\"h3-toc\">В этой статье</h3>\n<nav id=\"toc2\"></nav>\n</div>\n</aside>\n</div>\n</article>\n</main>\n<footer class=\"footer\">\n<div class=\"footer-container\">\n<div class=\"footer-mobile\">\n<ul class=\"footer-mobile__list\"><li><a href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li><a href=\"https://tssdk.elma365.com/\" target=\"_blank\">TS SDK</a></li><li><a href=\"https://community.elma365.com/\" target=\"_blank\">Community</a></li><li><a href=\"https://elma-academy.com/ru/elma365\" target=\"_blank\">Академия</a></li></ul><ul class=\"footer-mobile__list\"><li><a href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">ECM</a></li><li><a href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li></ul>\n</div>\n<div class=\"container\">\n<div class=\"footer-wrap\">\n<div><span class=\"mobile-question-popup\">Отправить фидбэк</span><form action=\"\" class=\"question__popup question-xs\" id=\"question__popup\" method=\"POST\"><div class=\"question-wrap\"><span class=\"close\"></span><span class=\"title\">Задать вопрос</span><label for=\"help_question\" style=\"display: none;\"></label><textarea id=\"help_question\" name=\"help_question\"></textarea><input type=\"submit\" value=\"Отправить\"/></div></form><div class=\"hidden fade-in question-success-xs\">Ваш фидбэк отправлен.</div></div>\n<div class=\"footer-flex-b\">\n<div class=\"footer-top\">\n<span class=\"footer-copy\">© 2025 \n              ELMA365\n            \n            \n          </span>\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</div>\n<div class=\"footer-line\">\n<div class=\"footer-line-copy\">\n<span class=\"footer-copy\">© 2025 \n                  ELMA365\n                \n                \n              </span>\n</div>\n<ul class=\"footer-list\">\n<li class=\"footer-item footer-url-elma\"><a class=\"footer-link footer-url-link-elma\" href=\"https://elma365.com/ru/\" style=\"color: #0D4A75;\" target=\"_blank\"><img alt=\"browse icon\" class=\"footer-img footer-img-elma-url\" src=\"browse.svg\"/>elma365.com</a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vkvideo.ru/@elma_bpm\" target=\"_blank\"><img alt=\"vk-video icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk-video.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vk.com/elma_bpm\" target=\"_blank\"><img alt=\"vk icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://t.me/elmaday\" target=\"_blank\"><img alt=\"telegram icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"telegram.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://dzen.ru/elma\" target=\"_blank\"><img alt=\"dzen icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"social_dzen.svg\" width=\"20\"/></a></li>\n<li class=\"footer-item sk-footer-img\">\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<a class=\"arrow-top\" href=\"#\"></a>\n</div>\n</footer>\n<!--    <script type=\"text/javascript\" src=\"jquery1.min.js\"></script>-->\n<iframe name=\"hmnavigation\" style=\"display:none!important\"></iframe>\n<!--<script src=\"./jquery-ui.js\"></script> -->\n<script src=\"./jquery-ui.min.js\"></script>\n<!--script src=\"//cdn.jsdelivr.net/npm/featherlight@1.7.14/release/featherlight.min.js\" type=\"text/javascript\" charset=\"utf-8\"></script-->\n<script src=\"./jquery.tocify.min.js\"></script>\n<script src=\"./TypoReporter.min.js\"></script>\n<script src=\"./google-search.js\"></script>\n<script src=\"./main.js\"></script>\n<script type=\"text/javascript\">\nHMInitToggle('TOGGLE0186A1','hm.type','dropdown','hm.state','0');\nHMInitToggle('TOGGLE0186A2','hm.type','dropdown','hm.state','0');\n</script>\n</body>\n</html>\n",
  "plain_text": "Пользовательский модуль для двухфакторной аутентификации ﻿ Платформа CSP CRM+CX Проекты Service КЭДО Бизнес-решения Academy Community API SDK Сайт ELMA365 Модули расширения системы > Примеры модулей интеграции с ELMA365 / Пользовательский модуль для двухфакторной аутентификации Пользовательский модуль для двухфакторной аутентификации Вы можете включить двухэтапную аутентификацию при входе в систему или на внешний портал , чтобы в качестве второго фактора использовался код подтверждения. Пользователь получит этот код через сторонний сервис, например мессенджер. Для этого создайте пользовательский модуль и затем выберите его: в настройках безопасности , чтобы включить двухфакторную аутентификацию при входе в систему; в настройках портала на вкладке Авторизация , чтобы включить двухфакторную аутентификацию при входе на портал для внутренних пользователей. начало внимание Работать с модулями и настраивать их могут только пользователи, включённые в группу Администраторы . конец внимание Для примера настроим получение кода подтверждения через Telegram-бот, выполнив шаги: Настроить получение кода из стороннего сервиса. Создать и настроить модуль. Включить модуль для второго фактора аутентификации. Шаг 1. Настроить получение кода из стороннего сервиса Перейдите в Telegram. Создайте бота. Подробнее читайте в официальной документации Telegram . Скопируйте токен бота. С помощью токена получите идентификатор чата для пользователя. Вы можете использовать следующий способ: Пользователь пишет любое сообщение созданному боту. Администратор системы получает идентификатор чата пользователя с ботом. Для этого: введите следующий запрос в браузере: https://api.telegram.org/bottoken/getUpdates , где token — токен, полученный при создании бота; в ответ на этот запрос на странице браузера появится JSON-текст, в котором содержится идентификатор чата. Пример JSON-текста { \"ok\": true, \"result\": [ { \"update_id\": 000000000, \"message\": { \"message_id\": 17, \"from\": { \"id\": 0000000001, \"is_bot\": false, \"first_name\": \"UserName\", \"language_code\": \"ru\" }, \"chat\": { \"id\": 0000000001, \"first_name\": \"UserName\", \"type\": \"private\" }, \"date\": 1724073228, \"text\": \"Привет\" } } ] } В профиле пользователя укажите его идентификатор чата в поле Учетные записи . Если идентификатор не указан, сотрудник войдёт в систему только по логину и паролю. Шаг 2. Создать и настроить модуль Перейдите в Администрирование > Модули и создайте модуль . Затем выполните настройки на открывшейся странице Управление : На вкладке Настройки создайте свойства типа Строка , которые будут использованы в скриптах для получения кода подтверждения через бот мессенджера: Тип аккаунта ( accountType ) — название стороннего сервиса, через который настраивается двухфакторная аутентификация; Токен бота ( botToken ) — идентификатор бота на стороне внешнего сервиса. Выдаётся при создании бота; Сообщение ( message ) — сообщение, которое получит пользовать вместе с кодом подтверждения, например «Вы заходите в ELMA365. Ваш проверочный код: ». Если все свойства указаны, перейдите на вкладку Основные и нажмите Сохранить . Перейдите на вкладку Методы API и нажмите Редактировать . Откроется редактор методов. На вкладке Скрипты напишите код, используя следующий шаблон: // Интерфейс позволят задать условия в указанной ниже функции, при которых у пользователя будет запрашиваться код второго фактора аутентификации interface SecondFactor_sendError { error: string; skip2fa: boolean; } // Функция определяет входящего пользователя по идентификатору и принимает код подтверждения async function secondFactor_sendCode(userID: string, code: string): Promise<SecondFactor_sendError> {} Пример скрипта для поиска входящего пользователя по идентификатору чата с Telegram-ботом interface SecondFactor_sendError { error: string; skip2fa: boolean; } async function secondFactor_sendCode(userID:string, code: string): Promise<SecondFactor_sendError>{ let accountType = Namespace.params.data.accountType; const result:SecondFactor_sendError={error: \"\", skip2fa: false}; const user = await System.users.search().where(f => f.__id.eq(userID)).first(); if(!user){ result.error = 'no user'; return result } if (!user.data.accounts) { result.error = 'user has no accounts'; result.skip2fa = true; return result; } for (var account of user.data.accounts) { if (account.type === accountType) { sendToTelegram(account.login, code); return result; } } result.error = 'user has no such account type'; result.skip2fa = true; return result; } function sendToTelegram(chatId: string, code: string):void { let botToken = Namespace.params.data.botToken; let message = Namespace.params.data.message; const method = 'sendMessage'; fetch(\"https://api.telegram.org/bot\"+botToken+\"/\"+method,{ method:\"POST\", headers: { 'Content-Type': 'application/json' }, body:JSON.stringify({'chat_id': chatId, 'text': message+code}) }); } Шаг 3. Включить модуль для второго фактора аутентификации Перейдите в Администрирование > Модули , откройте страницу модуля и включите его. В открывшемся окне заполните поля: Токен бота — значение скопированного токена; Тип аккаунта — название стороннего сервиса; Сообщение — текст, который нужно отобразить перед кодом подтверждения. Сохраните настройки. Модуль готов к использованию. Перейдите в Администрирование > Настройки безопасности > Двухфакторная аутентификация и выберите настроенный модуль для второго фактора аутентификации . Теперь, если у пользователя в профиле указан его идентификатор чата с Telegram-ботом, сотруднику придёт код подтверждения при входе в систему. external-oauth2-integration.html dadata_integration.html Была ли статья полезной? Спасибо за ваш отзыв! × Ваш отзыв успешно отправлен! Спасибо за обратную связь. × Уточните, почему: Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина × Расскажите, что вам не понравилось в статье: Да Нет Выберите вариант Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина В этой статье API TS SDK Community Академия Платформа ECM Service Проекты Отправить фидбэк Задать вопрос Ваш фидбэк отправлен. © 2025 ELMA365 © 2025 ELMA365 elma365.com",
  "links": [
    "https://elma365.com/ru/help",
    "https://elma365.com/ru/help/platform/get-trial.html",
    "https://elma365.com/ru/help/ecm/ecm-functions.html",
    "https://elma365.com/ru/help/crm/crm-functions.html",
    "https://elma365.com/ru/help/projects/projects-functions.html",
    "https://elma365.com/ru/help/service/service-functions.html",
    "https://elma365.com/ru/help/kedo/kedo.html",
    "https://elma365.com/ru/help/business_solutions/-elma365-store.html",
    "https://elma-academy.com/ru/",
    "https://community.elma365.com/ru/",
    "https://api.elma365.com/ru/",
    "https://tssdk.elma365.com/latest/",
    "https://elma365.com/ru/",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/360024498352.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/service-portal.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/extentions.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/security_settings.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/portal-login-page.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/360006871932.html",
    "https://core.telegram.org/bots/tutorial",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/360004833572.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/create-extention.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/extention-settings.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/360009707032.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/external-oauth2-integration.html",
    "https://elma365.com/ru/help/business_solutions/ru/help/crm/dadata_integration.html",
    "https://tssdk.elma365.com/",
    "https://community.elma365.com/",
    "https://elma-academy.com/ru/elma365",
    "https://navigator.sk.ru/orn/1122971",
    "https://vkvideo.ru/@elma_bpm",
    "https://vk.com/elma_bpm",
    "https://t.me/elmaday",
    "https://dzen.ru/elma"
  ],
  "last_crawled": "2025-11-29T22:03:49.194030",
  "metadata": {
    "depth": 10,
    "saved_at": "2025-11-29T22:03:49.321767"
  }
}