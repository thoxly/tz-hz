{
  "doc_id": "configure-postgresql",
  "url": "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/configure-postgresql.html",
  "title": "Кластер PostgreSQL",
  "breadcrumbs": [
    "ELMA365 On-Premises",
    "Подготовка инфраструктуры ELMA365 On-Premises"
  ],
  "section": "ELMA365 On-Premises > Подготовка инфраструктуры ELMA365 On-Premises | [business_solutions]",
  "html": "<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n<title>Кластер PostgreSQL</title>\n<meta content=\"Help+Manual\" name=\"generator\"/>\n<meta content=\"«Системные требования ELMA365 On-Premises Enterprise»\" name=\"keywords\"/>\n<meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\"/>\n<meta content=\"IE=edge\" http-equiv=\"X-UA-Compatible\"/>\n<meta content=\"width=device-width, initial-scale=1.0\" name=\"viewport\"/>\n<meta content=\"В статье описана установка PostgreSQL 13 для ОС Ubuntu Linux 20.04 и 22.04. Смотрите поддерживаемые версии PostgreSQL для корректной работы системы в статье «Системные...\" name=\"description\"/>\n<meta content=\"\" name=\"picture\"/>\n<meta content=\"website\" property=\"og:type\"/>\n<meta content=\"Cправка по Low-code платформе ELMA365\" property=\"og:title\"/>\n<meta content=\"https://elma365.com/ru/help\" property=\"og:url\"/>\n<meta content=\"\" property=\"og:image\"/>\n<meta content=\"ELMA365\" property=\"og:site_name\"/>\n<link href=\"favicon.png\" rel=\"icon\" type=\"image/png\"/>\n<link href=\"https://elma365.com/ru/help/platform/configure-postgresql.html\" rel=\"canonical\"/>\n<link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap\" rel=\"stylesheet\"/>\n<link href=\"./jquery-ui.min.css\" rel=\"stylesheet\"/>\n<link href=\"default.css\" rel=\"stylesheet\"/>\n<link href=\"./search-yandex.css\" rel=\"stylesheet\"/>\n<link href=\"./article.css\" rel=\"stylesheet\"/>\n<link href=\"./glossary.css\" rel=\"stylesheet\"/>\n<link href=\"./theme.css\" rel=\"stylesheet\"/>\n<link href=\"./tooltipster.bundle.min.css\" rel=\"stylesheet\" type=\"text/css\"/>\n<script src=\"jquery.js\" type=\"text/javascript\"></script>\n<script src=\"./tooltipster.bundle.min.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n        $(document).ready($('.tooltip').tooltipster({\n            contentCloning: true,\n            theme: 'tooltipster-borderless',\n        }));\n    </script>\n<script src=\"helpman_settings.js\" type=\"text/javascript\"></script>\n<script src=\"helpman_topicinit.js\" type=\"text/javascript\"></script>\n<script src=\"highlight.js\" type=\"text/javascript\"></script>\n<script type=\"text/javascript\">\n     $(document).ready(function(){highlight();});\n   </script>\n</head>\n<body>\n<script async=\"\" src=\"https://www.googletagmanager.com/gtag/js?id=G-M6ETBEC1R9\"></script><script>window.dataLayer=window.dataLayer || []; function gtag(){dataLayer.push(arguments);}gtag('js', new Date()); gtag('config', 'G-M6ETBEC1R9');</script>\n<script>!function(e,t,c,n,r,a,m){e.ym=e.ym||function(){(e.ym.a=e.ym.a||[]).push(arguments)},e.ym.l=1*new Date;for(var s=0;s<document.scripts.length;s++)if(document.scripts[s].src===n)return;a=t.createElement(c),m=t.getElementsByTagName(c)[0],a.async=1,a.src=n,m.parentNode.insertBefore(a,m)}(window,document,\"script\",\"https://mc.yandex.ru/metrika/tag.js\"),ym(83179930,\"init\",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0})</script><noscript><div><img alt=\"\" src=\"https://mc.yandex.ru/watch/83179930\" style=\"position:absolute;left:-9999px\"/></div></noscript> \n    \n    ﻿<header class=\"header elma-365\">\n<div class=\"container\">\n<div class=\"nav-container\">\n<div class=\"nav-wrap\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<div class=\"header__navi\">\n<ul class=\"header__list\"><li><span class=\"solution-select\"><span class=\"solution-select__selected\"></span><svg fill=\"none\" height=\"4\" viewbox=\"0 0 7 4\" width=\"7\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M1 1L3.5 3.5L6 1\" stroke=\"white\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg><ul class=\"solution-select__list\"><li class=\"header__list-item\"><a class=\"project-link\" href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">CSP</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/crm/crm-functions.html\">CRM+CX</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/kedo/kedo.html\">КЭДО</a></li><li><a class=\"project-link\" href=\"https://elma365.com/ru/help/business_solutions/-elma365-store.html\">Бизнес-решения</a></li><ul class=\"social-links-header\"><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://elma-academy.com/ru/\" target=\"_blank\">Academy</a></li><li class=\"social-link-header\"><a class=\"project-link\" href=\"https://community.elma365.com/ru/\" target=\"_blank\">Community</a></li><li></li></ul></ul></span></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li class=\"header__list-item\"><a class=\"header__list-item-url\" href=\"https://tssdk.elma365.com/latest/\" target=\"_blank\">SDK</a></li><li class=\"header__list-item header__list-item-latest\"><a class=\"header__list-item-url header__list-item-last\" href=\"https://elma365.com/ru/\" target=\"_blank\">Сайт ELMA365</a></li></ul>\n<div class=\"hero-wrap\" style=\"display: flex; align-items: center;\">\n<div class=\"hero__search\" style=\"display: flex; justify-content: space-between; width: 100%; padding-left: 0;\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img alt=\"header logo\" src=\"./logo.svg\"/>\n</a>\n<button class=\"hero__search-icon\" id=\"search-icon\">\n<img alt=\"search string\" src=\"search-icon-white.svg\"/>\n</button>\n<div class=\"hero__search-form\" id=\"search-panel\"><form class=\"search-form\"><label class=\"search-form__label\"><span class=\"search__icon\" id=\"reset-search\" src=\"Union.svg\"></span><input class=\"search-form__input\" type=\"text\"/></label><input class=\"search-form__submit\" type=\"submit\" value=\"Submit\"/></form></div>\n</div>\n</div>\n</div>\n</div>\n<a class=\"hero__side-icon\" href=\"#\" id=\"side-menu-icon\">\n<img alt=\"side menu\" src=\"side_menu.svg\"/>\n</a>\n</div>\n</div>\n</header>\n<main class=\"main container\">\n<aside class=\"sidebar\" id=\"sidebar\">\n<div class=\"sidebar__header\">\n<a class=\"header__logo\" href=\"https://elma365.com/ru/help\">\n<img src=\"./logo-light.svg\"/>\n</a>\n<span class=\"sidebar__close elma-365-close\" id=\"close\"></span>\n</div>\n<div class=\"sidebar__wrapper\" id=\"side-menu\">\n</div>\n</aside>\n<article class=\"article\" id=\"article\">\n<div class=\"article-inner\">\n<div class=\"content\">\n<header class=\"article__header\">\n<div class=\"article__bread\" style=\"display:flex; gap:8px;\">\n<span class=\"search-res__item-category search-res__item-category_subcategory subcategory article__badge\" id=\"subcategory\"></span>\n<nav class=\"topic__breadcrumbs\">\n<p><a href=\"elma365-on-premises.html\">ELMA365 On-Premises</a> &gt; <a href=\"infrastructure-preparation.html\">Подготовка инфраструктуры ELMA365 On-Premises</a> &gt; Базы данных &gt; Отказоустойчивая инфраструктура / Кластер PostgreSQL</p>\n</nav>\n</div>\n<div class=\"topic__title\"><h1 class=\"p_Heading1\"><span class=\"f_Heading1\">Кластер PostgreSQL</span></h1>\n</div>\n</header>\n<section class=\"article__content\">\n<div class=\"scroll-top-inner\">\n<a class=\"scroll-top\" href=\"#h1-article\"></a>\n</div>\n<!-- Placeholder for topic body. -->\n<p class=\"p_Normal\">В статье описана установка PostgreSQL 13 для ОС Ubuntu Linux 20.04 и 22.04. Смотрите поддерживаемые версии PostgreSQL для корректной работы системы в статье <a class=\"topiclink\" href=\"elma365-enterprise-on-premises.html#postgresql\">«Системные требования ELMA365 On-Premises»</a>. Также вы можете ознакомиться с руководством в <a class=\"weblink\" href=\"https://www.postgresql.org/docs/13/high-availability.html\" target=\"_blank\">официальной документации PostgreSQL</a>.</p>\n<p class=\"p_Normal\">Установка состоит из нескольких этапов:</p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"1\"><a class=\"topiclink\" href=\"configure-postgresql.html#preparation-node\">Подготовка нод (серверов)</a>.</li><li class=\"p_Normal\" value=\"2\"><a class=\"topiclink\" href=\"configure-postgresql.html#preparation-etcd\">Подготовка кластера etcd</a>.</li><li class=\"p_Normal\" value=\"3\"><a class=\"topiclink\" href=\"configure-postgresql.html#install-postgresql\">Установка PostgreSQL</a>.</li><li class=\"p_Normal\" value=\"4\"><a class=\"topiclink\" href=\"configure-postgresql.html#setting-postgresql\">Настройка PostgreSQL</a>.</li><li class=\"p_Normal\" value=\"5\"><a class=\"topiclink\" href=\"configure-postgresql.html#install-patroni\">Установка Patroni</a>.</li><li class=\"p_Normal\" value=\"6\"><a class=\"topiclink\" href=\"configure-postgresql.html#setting-patroni\">Настройка Patroni</a>.</li><li class=\"p_Normal\" value=\"7\"><a class=\"topiclink\" href=\"configure-postgresql.html#preparation-postgresql-patroni\">Подготовка кластера PostgreSQL+Patroni</a>.</li><li class=\"p_Normal\" value=\"8\"><a class=\"topiclink\" href=\"configure-postgresql.html#prepare-pgbouncer\">Подготовка PGBouncer (опционально)</a>.</li><li class=\"p_Normal\" value=\"9\"><a class=\"topiclink\" href=\"configure-postgresql.html#haproxy-configuration\">Конфигурация HAProxy (блок postgres)</a>.</li><li class=\"p_Normal\" value=\"10\"><a class=\"topiclink\" href=\"configure-postgresql.html#connecting-to-postgresql\">Подключение к PostgreSQL</a>.</li></ol>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"preparation-node\"></a><span class=\"f_Heading2\">Шаг 1. Подготовка нод (серверов)</span></h2>\n<p class=\"p_Normal\">Создайте три ноды (сервера) с последовательно пронумерованными именами хостов.</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">начало внимание</span></p>\n<p class=\"p_Normal\">Минимальное количество серверов для организации кластера <span style=\"font-size: 15px; font-family: Calibri,Vectora,'Droid Sans','Open Sans',Frutiger,sans-serif;\">— </span>три.</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">конец внимание</span></p>\n<p class=\"p_Normal\" style=\"line-height: 1.50;\"><span style=\"font-size: 15px;\">В этом примере используется три узла со следующими hostname и IP-адресами:</span></p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\"><span style=\"font-weight: bold;\">postgres-server1.your_domain, 192.168.1.1</span>;</li><li class=\"p_Normal\"><span style=\"font-weight: bold;\">postgres-server2.your_domain, 192.168.1.2</span>;</li><li class=\"p_Normal\"><span style=\"font-weight: bold;\">postgres-server3.your_domain, 192.168.1.3</span>.</li></ul>\n<p class=\"p_Normal\">Создайте необходимые сопоставления имён хостов в DNS. Если такой возможности нет, внесите нужные записи в <code><b>/etc/hosts</b></code>.</p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"preparation-etcd\"></a><span class=\"f_Heading2\">Шаг 2. Подготовка кластера etcd</span></h2>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68; margin-top: 10px; margin-right: 0; margin-bottom: 0;\" value=\"1\">Установите <code><b>etcd</b></code> на все узлы:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo apt-</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">get</span><span class=\"f_CodeExample\"> install etcd -y</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"2\">Остановите <code><b>etcd</b></code> на всех узлах:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo systemctl stop etcd</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"3\">Удалите каталог данных:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo rm -rf /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/lib/etcd</span><span class=\"f_CodeExample\" style=\"font-style: italic;\">/*</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"4\">Переместите конфигурационный файл по умолчанию:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo mv /etc/default/etcd{,.original}</span></p>\n<ol start=\"5\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"5\">Создайте и откройте для редактирования новый конфигурационный файл:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo nano /etc/default/etcd</span></p>\n<ol start=\"6\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"6\">Добавьте пример конфигураций в файл для узла<span style=\"font-weight: bold;\"> postgres-server1.your_domain</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">ETCD_NAME=\"postgres-server1\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_DATA_DIR=\"/var/lib/etcd/default\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_HEARTBEAT_INTERVAL=\"1000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ELECTION_TIMEOUT=\"5000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_PEER_URLS=\"http://192.168.1.1:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_CLIENT_URLS=\"http://192.168.1.1:2379,http://localhost:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.1.1:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER=\"postgres-server1=http://192.168.1.1:2380,postgres-server2=http://192.168.1.2:2380,postgres-server3=http://192.168.1.3:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_STATE=\"new\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.1.1:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ENABLE_V2=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\"</span></p>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A1')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Пример конфигураций с включением TLS/SSL для узла postgres-server1.your_domain</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A1\" style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">ETCD_NAME=\"postgres-server1\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_DATA_DIR=\"/var/lib/etcd/default\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_HEARTBEAT_INTERVAL=\"1000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ELECTION_TIMEOUT=\"5000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_PEER_URLS=\"https://192.168.1.1:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_CLIENT_URLS=\"https://192.168.1.1:2379,https://localhost:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://postgres-server1.your_domain:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER=\"postgres-server1=https://postgres-server1.your_domain:2380,postgres-server2=https://postgres-server2.your_domain:2380,postgres-server3=https://postgres-server3.your_domain:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_STATE=\"new\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ADVERTISE_CLIENT_URLS=\"https://postgres-server1.your_domain:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ENABLE_V2=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_CERT_FILE=\"/path/to/public.crt\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_KEY_FILE=\"/path/to/private.key\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_CLIENT_CERT_AUTH=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_TRUSTED_CA_FILE=\"/path/to/certCA.pem\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_CERT_FILE=\"/path/to/public.crt\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_KEY_FILE=\"/path/to/private.key\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_CLIENT_CERT_AUTH=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_TRUSTED_CA_FILE=\"/path/to/certCA.pem\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\"</span></p>\n</td>\n</tr>\n</table>\n</div>\n<ol start=\"7\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"7\">Добавьте пример конфигураций в файл для узла <span style=\"font-weight: bold;\">postgres-server2.your_domain</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">ETCD_NAME=\"postgres-server2\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_DATA_DIR=\"/var/lib/etcd/default\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_HEARTBEAT_INTERVAL=\"1000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ELECTION_TIMEOUT=\"5000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_PEER_URLS=\"http://192.168.1.2:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_CLIENT_URLS=\"http://192.168.1.2:2379,http://127.0.0.1:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.1.2:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER=\"postgres-server1=http://192.168.1.1:2380,postgres-server2=http://192.168.1.2:2380,postgres-server3=http://192.168.1.3:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_STATE=\"new\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.1.2:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ENABLE_V2=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\"</span></p>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A2')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Пример конфигураций с включением TLS/SSL для узла postgres-server2.your_domain</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A2\" style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">ETCD_NAME=\"postgres-server2\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_DATA_DIR=\"/var/lib/etcd/default\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_HEARTBEAT_INTERVAL=\"1000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ELECTION_TIMEOUT=\"5000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_PEER_URLS=\"https://192.168.1.2:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_CLIENT_URLS=\"https://192.168.1.2:2379,https://localhost:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://postgres-server2.your_domain:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER=\"postgres-server1=https://postgres-server1.your_domain:2380,postgres-server2=https://postgres-server2.your_domain:2380,postgres-server3=https://postgres-server3.your_domain:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_STATE=\"new\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ADVERTISE_CLIENT_URLS=\"https://postgres-server2.your_domain:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ENABLE_V2=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_CERT_FILE=\"/path/to/public.crt\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_KEY_FILE=\"/path/to/private.key\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_CLIENT_CERT_AUTH=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_TRUSTED_CA_FILE=\"/path/to/certCA.pem\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_CERT_FILE=\"/path/to/public.crt\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_KEY_FILE=\"/path/to/private.key\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_CLIENT_CERT_AUTH=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_TRUSTED_CA_FILE=\"/path/to/certCA.pem\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\"</span></p>\n</td>\n</tr>\n</table>\n</div>\n<ol start=\"8\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"8\">Добавьте пример конфигураций в файл для узла <span style=\"font-weight: bold;\">postgres-server3.your_domain</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">ETCD_NAME=\"postgres-server3\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_DATA_DIR=\"/var/lib/etcd/default\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_HEARTBEAT_INTERVAL=\"1000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ELECTION_TIMEOUT=\"5000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_PEER_URLS=\"http://192.168.1.3:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_CLIENT_URLS=\"http://192.168.1.3:2379,http://localhost:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.1.3:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER=\"postgres-server1=http://192.168.1.1:2380,postgres-server2=http://192.168.1.2:2380,postgres-server3=http://192.168.1.3:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_STATE=\"new\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.1.3:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ENABLE_V2=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\"</span></p>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A3')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Пример конфигураций с включением TLS/SSL для узла postgres-server3.your_domain</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A3\" style=\"text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">ETCD_NAME=\"postgres-server3\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_DATA_DIR=\"/var/lib/etcd/default\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_HEARTBEAT_INTERVAL=\"1000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ELECTION_TIMEOUT=\"5000\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_PEER_URLS=\"https://192.168.1.3:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_LISTEN_CLIENT_URLS=\"https://192.168.1.3:2379,https://localhost:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://postgres-server3.your_domain:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER=\"postgres-server1=https://postgres-server1.your_domain:2380,postgres-server2=https://postgres-server2.your_domain:2380,postgres-server3=https://postgres-server3.your_domain:2380\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_STATE=\"new\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ADVERTISE_CLIENT_URLS=\"https://postgres-server3.your_domain:2379\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_ENABLE_V2=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_CERT_FILE=\"/path/to/public.crt\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_KEY_FILE=\"/path/to/private.key\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_CLIENT_CERT_AUTH=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_TRUSTED_CA_FILE=\"/path/to/certCA.pem\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_CERT_FILE=\"/path/to/public.crt\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_KEY_FILE=\"/path/to/private.key\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_CLIENT_CERT_AUTH=\"true\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_PEER_TRUSTED_CA_FILE=\"/path/to/certCA.pem\"</span><br/>\n<span class=\"f_CodeExample\">ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\"</span></p>\n</td>\n</tr>\n</table>\n</div>\n<p class=\"p_Normal\" style=\"line-height: 1.68;\">Рассмотрим введённые параметры:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_NAME</b></code> — имя этого узла кластера. Должно быть уникально в кластере;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_LISTEN_CLIENT_URLS</b></code> — точка подключения для клиентов кластера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_ADVERTISE_CLIENT_URLS</b></code> — список URL-адресов, по которым его могут найти остальные узлы кластера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_LISTEN_PEER_URLS</b></code> — точка подключения для остальных узлов кластера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_INITIAL_ADVERTISE_PEER_URLS</b></code> — начальный список URL-адресов, по которым его могут найти остальные узлы кластера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_INITIAL_CLUSTER_TOKEN</b></code> — токен кластера, должен совпадать на всех узлах кластера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_INITIAL_CLUSTER</b></code> — список узлов кластера на момент запуска;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_INITIAL_CLUSTER_STATE</b></code> — может принимать два значения: <code><b>new</b></code> и <code><b>existing</b></code>;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_DATA_DIR</b></code> — расположение каталога данных кластера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_ELECTION_TIMEOUT</b></code> — время в миллисекундах, которое проходит между последним принятым оповещением от лидера кластера, до попытки захватить роль лидера на ведомом узле;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_HEARTBEAT_INTERVAL</b></code> — время в миллисекундах между рассылками лидером оповещений о том, что он всё ещё лидер;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_CERT_FILE</b></code> — путь до файла сертификата сервера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_KEY_FILE</b></code> — путь до файла закрытого ключа;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_TRUSTED_CA_FILE</b></code> — путь до файла корневого CA;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_CLIENT_CERT_AUTH</b></code> — может принимать два значения: <code><b>true</b></code> и <code><b>false</b></code>;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_PEER_CERT_FILE</b></code> — путь до файла сертификата сервера;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_PEER_KEY_FILE</b></code> — путь до файла закрытого ключа;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_PEER_TRUSTED_CA_FILE</b></code> — путь до файла корневого CA;</li><li class=\"p_Normal\" style=\"line-height: 1.68;\"><code><b>ETCD_PEER_CLIENT_CERT_AUTH</b></code> — может принимать два значения: <code><b>true</b></code> и <code><b>false</b></code>.</li></ul>\n<ol start=\"9\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"9\">Перезапустите <code><b>etcd</b></code> на всех узлах:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo systemctl restart etcd</span></p>\n<ol start=\"10\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" style=\"line-height: 1.68;\" value=\"10\">Проверьте состояние кластера.</li></ol>\n<p class=\"p_Normal\" style=\"line-height: 1.68;\">Для кластера без TLS:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo etcdctl cluster-health</span></p>\n<p class=\"p_Normal\">Для кластера c TLS:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo etcdctl -C https:</span><span class=\"f_CodeExample\">//postgres-server1.your_domain:2379 --key-file /path/to/private.key --cert-file /path/to/public.crt --ca-file /path/to/certCA.pem cluster-health</span></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"install-postgresql\"></a><span class=\"f_Heading2\">Шаг 3. Установка PostgreSQL</span></h2>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">начало внимание</span></p>\n<p class=\"p_Normal\">С аппаратными требованиями, необходимыми для корректной работы ELMA365 на PostgreSQL, можно ознакомиться в статье <a class=\"topiclink\" href=\"elma365-enterprise-on-premises.html#postgresql\">«Системные требования ELMA365 On-Premises»</a>.</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">конец внимание</span></p>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Для установки PostgreSQL добавьте официальный репозиторий <code><b>postgresql</b></code>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" &gt; /etc/apt/sources.list.d/pgdg.list'</span><br/>\n<span class=\"f_CodeExample\">wget --quiet -O - https:</span><span class=\"f_CodeExample\">//www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Обновите кеш пакетов, выполнив команду:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo apt update</span></p>\n<ol start=\"3\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Установите PostgreSQL на все узлы:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo apt install postgresql-13 -y</span></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"setting-postgresql\"></a><span class=\"f_Heading2\">Шаг 4. Настройка PostgreSQL</span></h2>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">начало примечание</span></p>\n<p class=\"p_Normal\"><span style=\"font-weight: bold;\">Примечание</span></p>\n<p class=\"p_Normal\">Для пароля разрешается применять следующие символы:</p>\n<ul style=\"list-style-type:disc\">\n<li class=\"p_Normal\">Заглавные латинские буквы: от A до Z;</li><li class=\"p_Normal\">Строчные латинские буквы: от a до z;</li><li class=\"p_Normal\">Цифры от 0 до 9;</li><li class=\"p_Normal\">Символы:  -_.</li></ul>\n<p class=\"p_Normal\">Зарезервированные (недопустимые) символы:</p>\n<p class=\"p_Normal\">! * ' ( ) ; : @ &amp; = + $ , / ? % # [ ]</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">конец примечание</span></p>\n<h4 class=\"p_Heading4\"><span class=\"f_Heading4\">Действия для узла postgres-server1.your_domain:</span></h4>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Создайте новую роль <code><b>elma365</b></code> с паролем <span style=\"font-weight: bold;\">SecretPassword</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres psql -c \\</span><br/>\n<span class=\"f_CodeExample\">\"CREATE ROLE elma365 WITH login password 'SecretPassword';\"</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Создайте базу данных <code><b>elma365</b></code> с базовой локалью и назначьте выделенного пользователя <span style=\"font-weight: bold;\">elma365 </span>её владельцем:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres psql -c \\</span><br/>\n<span class=\"f_CodeExample\">\"CREATE DATABASE elma365 WITH OWNER elma365;\"</span></p>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A4')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Создание базы данных с локалью ru_RU.UTF-8</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A4\" style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_Normal\"> <br/>\nВы можете создать базу данных <span style=\"font-weight: bold;\">elma365</span> с локалью <span style=\"font-weight: bold;\">ru_RU.UTF-8</span>. Это позволит улучшить работу механизмов сортировки и индексирования русскоязычных данных, а также ускорить выполнение поисковых и текстовых операций. Для этого:</p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"1\">Убедитесь, что локаль ru_RU.UTF-8 доступна в системе:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid; margin: 0 0 0 34px;\"><span class=\"f_CodeExample\">locale -a | grep ru_RU</span></p>\n<p class=\"p_Normal\"> <br/>\nПри наличии локали отобразится её название.</p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"2\">Если в системе отсутствует локаль <span style=\"font-weight: bold;\">ru_RU.UTF-8</span>, установите её, выполнив команду:</li></ol>\n<p class=\"p_CodeExample\" style=\"white-space: normal; page-break-inside: avoid; margin: 0 0 0 33px;\"><span class=\"f_CodeExample\">sudo locale-gen ru_RU.UTF-8 &amp;&amp; sudo update-locale</span></p>\n<p class=\"p_Normal\"> <br/>\nПосле установки перезагрузите сервис PostgreSQL для применения изменений:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid; margin: 0 0 0 33px;\"><span class=\"f_CodeExample\">sudo systemctl restart postgresql</span></p>\n<ol style=\"list-style-type:decimal\">\n<li class=\"p_Normal\" value=\"3\">Создайте базу данных с локалью<span style=\"font-weight: bold;\"> ru_RU.UTF-8</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid; margin: 0 0 0 35px;\"><span class=\"f_CodeExample\">sudo -u postgres psql -c \"CREATE DATABASE elma365 WITH OWNER = elma365</span><br/>\n<span class=\"f_CodeExample\">LOCALE_PROVIDER = icu ICU_LOCALE = 'ru-RU' ENCODING = 'UTF8' LC_COLLATE =</span><br/>\n<span class=\"f_CodeExample\">'ru_RU.UTF-8' LC_CTYPE = 'ru_RU.UTF-8' TEMPLATE = template0;\"</span></p>\n</td>\n</tr>\n</table>\n</div>\n<ol start=\"3\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Добавьте необходимые расширения для базы данных <code><b>elma365</b></code>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres psql -d elma365 -c \\</span><br/>\n<span class=\"f_CodeExample\">\"CREATE EXTENSION \\\"uuid-ossp\\\"; CREATE EXTENSION pg_trgm;\"</span></p>\n<ol start=\"4\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"4\">Создайте новую роль <code><b>replicator</b></code> с паролем <span style=\"font-weight: bold;\">ReplicatorPassword</span> для работы с репликами. Должно совпадать с настройками <span style=\"font-weight: bold;\">Patroni</span> из блока <code><b>postgresql - authentication - replication</b></code> и списком разрешённых хостов postgresql в файле <code><b>pg_hba.conf</b></code>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres psql -c \\</span><br/>\n<span class=\"f_CodeExample\">\"CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'ReplicatorPassword';\"</span></p>\n<ol start=\"5\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"5\">Установите пароль для пользователя <span style=\"font-weight: bold;\">postgres</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo -u postgres psql -c \"ALTER USER postgres PASSWORD 'PostgresPassword';\"</span></p>\n<ol start=\"6\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"6\">Остановите PostgreSQL:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">systemctl stop postgresql</span></p>\n<h4 class=\"p_Heading4\"><span class=\"f_Heading4\">Действия для узла postgres-server2.your_domain и postgres-server3.your_domain:</span></h4>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\"> Остановите PostgreSQL:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">systemctl stop postgresql</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Удалите каталог данных на нодах <span style=\"font-weight: bold;\">postgres-server2.your_domain</span> и <span style=\"font-weight: bold;\">postgres-server3.your_domain</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">rm -rf /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/lib/postgresql/13/main</span></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"install-patroni\"></a><span class=\"f_Heading2\">Шаг 5. Установка Patroni</span></h2>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Установите Patroni и PIP на все узлы:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo apt-get install python3-pip python3-dev libpq-dev -y</span><br/>\n<span class=\"f_CodeExample\">sudo apt-get install patroni -y</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Установите зависимости для работы Patroni на все узлы:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">pip3 install psycopg2-binary</span><br/>\n<span class=\"f_CodeExample\">pip3 install wheel</span><br/>\n<span class=\"f_CodeExample\">pip3 install python-etcd</span></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"setting-patroni\"></a><span class=\"f_Heading2\">Шаг 6. Настройка Patroni</span></h2>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Создайте файл настроек:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo nano /etc/patroni/config.yml</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">В созданный файл <code><b>/etc/patroni/config.yml</b></code> нужно поместить пример начальной конфигурации, изменив ip-адреса на свои на каждом узле кластера. Обратите внимание на комментарии в данном файле.</li></ol>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A5')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Пример начальной конфигурации</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A5\" style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">scope: postgres-cluster # одинаковое значение на всех узлах</span><br/>\n<span class=\"f_CodeExample\">name: postgresql-server1 # разное значение на всех узлах</span><br/>\n<span class=\"f_CodeExample\">namespace: /service/ # одинаковое значение на всех узлах</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">restapi:</span><br/>\n<span class=\"f_CodeExample\">  listen: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\">  connect_address: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">etcd:</span><br/>\n<span class=\"f_CodeExample\">  hosts: postgres-server1.your_domain:2379,postgres-server2.your_domain:2379,postgres-server3.your_domain:2379 # список всех узлов, на которых установлен etcd</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">bootstrap:</span><br/>\n<span class=\"f_CodeExample\">  method: initdb</span><br/>\n<span class=\"f_CodeExample\">  dcs:</span><br/>\n<span class=\"f_CodeExample\">    ttl: 30</span><br/>\n<span class=\"f_CodeExample\">    loop_wait: 10</span><br/>\n<span class=\"f_CodeExample\">    retry_timeout: 10</span><br/>\n<span class=\"f_CodeExample\">    maximum_lag_on_failover: 1048576</span><br/>\n<span class=\"f_CodeExample\">    master_start_timeout: 300</span><br/>\n<span class=\"f_CodeExample\">    synchronous_mode: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">    synchronous_mode_strict: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">    synchronous_node_count: 1</span><br/>\n<span class=\"f_CodeExample\">    postgresql:</span><br/>\n<span class=\"f_CodeExample\">      use_pg_rewind: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">      use_slots: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">      parameters:</span><br/>\n<span class=\"f_CodeExample\">        max_connections: 2000</span><br/>\n<span class=\"f_CodeExample\">        superuser_reserved_connections: 5</span><br/>\n<span class=\"f_CodeExample\">        max_locks_per_transaction: 64</span><br/>\n<span class=\"f_CodeExample\">        max_prepared_transactions: 0</span><br/>\n<span class=\"f_CodeExample\">        huge_pages: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">try</span><br/>\n<span class=\"f_CodeExample\">        shared_buffers: 512MB</span><br/>\n<span class=\"f_CodeExample\">        work_mem: 128MB</span><br/>\n<span class=\"f_CodeExample\">        maintenance_work_mem: 256MB</span><br/>\n<span class=\"f_CodeExample\">        effective_cache_size: 4GB</span><br/>\n<span class=\"f_CodeExample\">        checkpoint_timeout: 15min</span><br/>\n<span class=\"f_CodeExample\">        checkpoint_completion_target: 0.9</span><br/>\n<span class=\"f_CodeExample\">        wal_compression: on</span><br/>\n<span class=\"f_CodeExample\">        min_wal_size: 2GB</span><br/>\n<span class=\"f_CodeExample\">        max_wal_size: 4GB</span><br/>\n<span class=\"f_CodeExample\">        wal_buffers: 32MB</span><br/>\n<span class=\"f_CodeExample\">        default_statistics_target: 1000</span><br/>\n<span class=\"f_CodeExample\">        seq_page_cost: 1</span><br/>\n<span class=\"f_CodeExample\">        random_page_cost: 4</span><br/>\n<span class=\"f_CodeExample\">        effective_io_concurrency: 2</span><br/>\n<span class=\"f_CodeExample\">        synchronous_commit: on</span><br/>\n<span class=\"f_CodeExample\">        autovacuum: on</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_max_workers: 5</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_vacuum_scale_factor: 0.01</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_analyze_scale_factor: 0.02</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_vacuum_cost_limit: 200</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_vacuum_cost_delay: 20</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_naptime: 1s</span><br/>\n<span class=\"f_CodeExample\">        max_files_per_process: 4096</span><br/>\n<span class=\"f_CodeExample\">        archive_mode: on</span><br/>\n<span class=\"f_CodeExample\">        archive_timeout: 1800s</span><br/>\n<span class=\"f_CodeExample\">        archive_command: cd .</span><br/>\n<span class=\"f_CodeExample\">        wal_level: replica</span><br/>\n<span class=\"f_CodeExample\">        wal_keep_segments: 130</span><br/>\n<span class=\"f_CodeExample\">        max_wal_senders: 10</span><br/>\n<span class=\"f_CodeExample\">        max_replication_slots: 10</span><br/>\n<span class=\"f_CodeExample\">        hot_standby: on</span><br/>\n<span class=\"f_CodeExample\">        hot_standby_feedback: True</span><br/>\n<span class=\"f_CodeExample\">        wal_log_hints: on</span><br/>\n<span class=\"f_CodeExample\">        shared_preload_libraries: pg_stat_statements,auto_explain</span><br/>\n<span class=\"f_CodeExample\">        pg_stat_statements.max: 10000</span><br/>\n<span class=\"f_CodeExample\">        pg_stat_statements.track: all</span><br/>\n<span class=\"f_CodeExample\">        pg_stat_statements.save: off</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_min_duration: 10s</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_analyze: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_buffers: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_timing: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_triggers: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_verbose: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_nested_statements: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        standard_conforming_strings: true</span><br/>\n<span class=\"f_CodeExample\">        track_io_timing: on</span><br/>\n<span class=\"f_CodeExample\">        log_lock_waits: on</span><br/>\n<span class=\"f_CodeExample\">        log_temp_files: 3</span><br/>\n<span class=\"f_CodeExample\">        track_activities: on</span><br/>\n<span class=\"f_CodeExample\">        track_counts: on</span><br/>\n<span class=\"f_CodeExample\">        track_functions: all</span><br/>\n<span class=\"f_CodeExample\">        log_checkpoints: on</span><br/>\n<span class=\"f_CodeExample\">        logging_collector: on</span><br/>\n<span class=\"f_CodeExample\">        log_truncate_on_rotation: on</span><br/>\n<span class=\"f_CodeExample\">        log_rotation_age: 1d</span><br/>\n<span class=\"f_CodeExample\">        log_rotation_size: 0</span><br/>\n<span class=\"f_CodeExample\">        log_line_prefix: '%t [%p-%l] %r %q%u@%d '</span><br/>\n<span class=\"f_CodeExample\">        log_filename: 'postgresql-%a.log'</span><br/>\n<span class=\"f_CodeExample\">        log_directory: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/log/postgresql</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">  initdb: # List options to be passed on to initdb</span><br/>\n<span class=\"f_CodeExample\">    - encoding: UTF8</span><br/>\n<span class=\"f_CodeExample\">    - locale: en_US.UTF-8</span><br/>\n<span class=\"f_CodeExample\">    - data-checksums</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">  pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере</span><br/>\n<span class=\"f_CodeExample\">    - local all postgres peer</span><br/>\n<span class=\"f_CodeExample\">    - local all all peer</span><br/>\n<span class=\"f_CodeExample\">    - host all all 0.0.0.0/0 md5</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator localhost trust</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator 192.168.1.1/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator 192.168.1.2/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator 192.168.1.3/32 md5</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">postgresql:</span><br/>\n<span class=\"f_CodeExample\">  listen: 192.168.1.1,127.0.0.1:5432 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\">  connect_address: 192.168.1.1:5432 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\">  use_unix_socket: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">  data_dir: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/lib/postgresql/13/main # каталог данных</span><br/>\n<span class=\"f_CodeExample\">  bin_dir: /usr/lib/postgresql/13/bin</span><br/>\n<span class=\"f_CodeExample\">  config_dir: /etc/postgresql/13/main</span><br/>\n<span class=\"f_CodeExample\">  pgpass: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/lib/postgresql/.pgpass_patroni</span><br/>\n<span class=\"f_CodeExample\">  authentication:</span><br/>\n<span class=\"f_CodeExample\">    replication:</span><br/>\n<span class=\"f_CodeExample\">      username: replicator</span><br/>\n<span class=\"f_CodeExample\">      password: ReplicatorPassword</span><br/>\n<span class=\"f_CodeExample\">    superuser:</span><br/>\n<span class=\"f_CodeExample\">      username: postgres</span><br/>\n<span class=\"f_CodeExample\">      password: PostgresPassword</span><br/>\n<span class=\"f_CodeExample\">  parameters:</span><br/>\n<span class=\"f_CodeExample\">    unix_socket_directories: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/run/postgresql</span><br/>\n<span class=\"f_CodeExample\">  pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере</span><br/>\n<span class=\"f_CodeExample\">    - local all postgres peer</span><br/>\n<span class=\"f_CodeExample\">    - local all all peer</span><br/>\n<span class=\"f_CodeExample\">    - host all all 0.0.0.0/0 md5</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator localhost trust</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator 192.168.1.1/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator 192.168.1.2/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - host replication replicator 192.168.1.3/32 md5</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">  remove_data_directory_on_rewind_failure: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  remove_data_directory_on_diverged_timelines: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\" style=\"font-weight: bold;\"> </span><br/>\n<span class=\"f_CodeExample\">  create_replica_methods:</span><br/>\n<span class=\"f_CodeExample\">    - basebackup</span><br/>\n<span class=\"f_CodeExample\">  basebackup:</span><br/>\n<span class=\"f_CodeExample\">    max-rate: '100M'</span><br/>\n<span class=\"f_CodeExample\">    checkpoint: 'fast'</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">watchdog:</span><br/>\n<span class=\"f_CodeExample\">  mode: off # Allowed values: off, automatic, required</span><br/>\n<span class=\"f_CodeExample\">  device: /dev/watchdog</span><br/>\n<span class=\"f_CodeExample\">  safety_margin: 5</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">tags:</span><br/>\n<span class=\"f_CodeExample\">  nofailover: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  noloadbalance: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  clonefrom: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  nosync: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span></p>\n</td>\n</tr>\n</table>\n</div>\n<p class=\"p_Normal\"><a class=\"dropdown-toggle\" href=\"javascript:HMToggle('toggle','TOGGLE0186A6')\" style=\"font-style: normal; font-weight: normal; color: #000000; background-color: transparent; text-decoration: none;\">Пример начальной конфигурации для включения поддержки TLS/SSL в Patroni</a></p>\n<div class=\"dropdown-toggle-body\" id=\"TOGGLE0186A6\" style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0;\">\n<tr>\n<td style=\"vertical-align:top; padding:0; border:none\"><p class=\"p_Normal\"> <br/>\nНужно поместить пример начальной конфигурации с TLS/SSL в файл <code><b>/etc/patroni/config.yml</b></code>. Обратите внимание на комментарии в данном файле:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">scope: postgres-cluster # одинаковое значение на всех узлах</span><br/>\n<span class=\"f_CodeExample\">name: postgresql-server1 # разное значение на всех узлах</span><br/>\n<span class=\"f_CodeExample\">namespace: /service/ # одинаковое значение на всех узлах</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">restapi:</span><br/>\n<span class=\"f_CodeExample\">  listen: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\">  connect_address: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\">  cafile: /path/to/pgCA.pem</span><br/>\n<span class=\"f_CodeExample\">  certfile: /path/to/pg.crt # путь до файла сертификата сервера</span><br/>\n<span class=\"f_CodeExample\">  keyfile: /path/to/pg.key # путь до файла закрытого ключа</span><br/>\n<span class=\"f_CodeExample\">  verify_client: required # путь до файла корневого CA</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">etcd:</span><br/>\n<span class=\"f_CodeExample\">  protocol: https</span><br/>\n<span class=\"f_CodeExample\">  cert: /path/to/</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">public</span><span class=\"f_CodeExample\">.crt # путь до файла сертификата сервера</span><br/>\n<span class=\"f_CodeExample\">  key: /path/to/</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">private</span><span class=\"f_CodeExample\">.key # путь до файла закрытого ключа</span><br/>\n<span class=\"f_CodeExample\">  cacert: /path/to/certCA.pem # путь до файла корневого CA</span><br/>\n<span class=\"f_CodeExample\">  hosts: postgres-server1.your_domain:2379,postgres-server2.your_domain:2379,postgres-server3.your_domain:2379 # список всех узлов, на которых установлен etcd</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">ctl:</span><br/>\n<span class=\"f_CodeExample\">  insecure: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><span class=\"f_CodeExample\"> # Allow connections to SSL sites without certs</span><br/>\n<span class=\"f_CodeExample\">  certfile: /path/to/pg.crt # путь до файла сертификата сервера</span><br/>\n<span class=\"f_CodeExample\">  keyfile: /path/to/pg.key # путь до файла закрытого ключа</span><br/>\n<span class=\"f_CodeExample\">  cacert: /path/to/pgCA.pem # путь до файла корневого CA</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">bootstrap:</span><br/>\n<span class=\"f_CodeExample\">  method: initdb</span><br/>\n<span class=\"f_CodeExample\">  dcs:</span><br/>\n<span class=\"f_CodeExample\">    ttl: 30</span><br/>\n<span class=\"f_CodeExample\">    loop_wait: 10</span><br/>\n<span class=\"f_CodeExample\">    retry_timeout: 10</span><br/>\n<span class=\"f_CodeExample\">    maximum_lag_on_failover: 1048576</span><br/>\n<span class=\"f_CodeExample\">    master_start_timeout: 300</span><br/>\n<span class=\"f_CodeExample\">    synchronous_mode: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">    synchronous_mode_strict: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">    synchronous_node_count: 1</span><br/>\n<span class=\"f_CodeExample\">    postgresql:</span><br/>\n<span class=\"f_CodeExample\">      use_pg_rewind: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">      use_slots: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">      parameters:</span><br/>\n<span class=\"f_CodeExample\">        max_connections: 2000</span><br/>\n<span class=\"f_CodeExample\">        superuser_reserved_connections: 5</span><br/>\n<span class=\"f_CodeExample\">        max_locks_per_transaction: 64</span><br/>\n<span class=\"f_CodeExample\">        max_prepared_transactions: 0</span><br/>\n<span class=\"f_CodeExample\">        huge_pages: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">try</span><br/>\n<span class=\"f_CodeExample\">        shared_buffers: 512MB</span><br/>\n<span class=\"f_CodeExample\">        work_mem: 128MB</span><br/>\n<span class=\"f_CodeExample\">        maintenance_work_mem: 256MB</span><br/>\n<span class=\"f_CodeExample\">        effective_cache_size: 4GB</span><br/>\n<span class=\"f_CodeExample\">        checkpoint_timeout: 15min</span><br/>\n<span class=\"f_CodeExample\">        checkpoint_completion_target: 0.9</span><br/>\n<span class=\"f_CodeExample\">        wal_compression: on</span><br/>\n<span class=\"f_CodeExample\">        min_wal_size: 2GB</span><br/>\n<span class=\"f_CodeExample\">        max_wal_size: 4GB</span><br/>\n<span class=\"f_CodeExample\">        wal_buffers: 32MB</span><br/>\n<span class=\"f_CodeExample\">        default_statistics_target: 1000</span><br/>\n<span class=\"f_CodeExample\">        seq_page_cost: 1</span><br/>\n<span class=\"f_CodeExample\">        random_page_cost: 4</span><br/>\n<span class=\"f_CodeExample\">        effective_io_concurrency: 2</span><br/>\n<span class=\"f_CodeExample\">        synchronous_commit: on</span><br/>\n<span class=\"f_CodeExample\">        autovacuum: on</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_max_workers: 5</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_vacuum_scale_factor: 0.01</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_analyze_scale_factor: 0.02</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_vacuum_cost_limit: 200</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_vacuum_cost_delay: 20</span><br/>\n<span class=\"f_CodeExample\">        autovacuum_naptime: 1s</span><br/>\n<span class=\"f_CodeExample\">        max_files_per_process: 4096</span><br/>\n<span class=\"f_CodeExample\">        archive_mode: on</span><br/>\n<span class=\"f_CodeExample\">        archive_timeout: 1800s</span><br/>\n<span class=\"f_CodeExample\">        archive_command: cd .</span><br/>\n<span class=\"f_CodeExample\">        wal_level: replica</span><br/>\n<span class=\"f_CodeExample\">        wal_keep_segments: 130</span><br/>\n<span class=\"f_CodeExample\">        max_wal_senders: 10</span><br/>\n<span class=\"f_CodeExample\">        max_replication_slots: 10</span><br/>\n<span class=\"f_CodeExample\">        hot_standby: on</span><br/>\n<span class=\"f_CodeExample\">        hot_standby_feedback: True</span><br/>\n<span class=\"f_CodeExample\">        wal_log_hints: on</span><br/>\n<span class=\"f_CodeExample\">        shared_preload_libraries: pg_stat_statements,auto_explain</span><br/>\n<span class=\"f_CodeExample\">        pg_stat_statements.max: 10000</span><br/>\n<span class=\"f_CodeExample\">        pg_stat_statements.track: all</span><br/>\n<span class=\"f_CodeExample\">        pg_stat_statements.save: off</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_min_duration: 10s</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_analyze: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_buffers: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_timing: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_triggers: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_verbose: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        auto_explain.log_nested_statements: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">        standard_conforming_strings: true</span><br/>\n<span class=\"f_CodeExample\">        track_io_timing: on</span><br/>\n<span class=\"f_CodeExample\">        log_lock_waits: on</span><br/>\n<span class=\"f_CodeExample\">        log_temp_files: 3</span><br/>\n<span class=\"f_CodeExample\">        track_activities: on</span><br/>\n<span class=\"f_CodeExample\">        track_counts: on</span><br/>\n<span class=\"f_CodeExample\">        track_functions: all</span><br/>\n<span class=\"f_CodeExample\">        log_checkpoints: on</span><br/>\n<span class=\"f_CodeExample\">        logging_collector: on</span><br/>\n<span class=\"f_CodeExample\">        log_truncate_on_rotation: on</span><br/>\n<span class=\"f_CodeExample\">        log_rotation_age: 1d</span><br/>\n<span class=\"f_CodeExample\">        log_rotation_size: 0</span><br/>\n<span class=\"f_CodeExample\">        log_line_prefix: '%t [%p-%l] %r %q%u@%d '</span><br/>\n<span class=\"f_CodeExample\">        log_filename: 'postgresql-%a.log'</span><br/>\n<span class=\"f_CodeExample\">        log_directory: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/log/postgresql</span><br/>\n<span class=\"f_CodeExample\">        ssl: on</span><br/>\n<span class=\"f_CodeExample\">        ssl_ca_file: '/path/to/pgCA.pem'</span><br/>\n<span class=\"f_CodeExample\">        ssl_cert_file: '/path/to/pg.crt'</span><br/>\n<span class=\"f_CodeExample\">        ssl_key_file: '/path/to/pg.key'</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">  initdb: # List options to be passed on to initdb</span><br/>\n<span class=\"f_CodeExample\">    - encoding: UTF8</span><br/>\n<span class=\"f_CodeExample\">    - locale: en_US.UTF-8</span><br/>\n<span class=\"f_CodeExample\">    - data-checksums</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">  pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере</span><br/>\n<span class=\"f_CodeExample\">    - local all postgres peer</span><br/>\n<span class=\"f_CodeExample\">    - local all all peer</span><br/>\n<span class=\"f_CodeExample\">    - hostssl all all 0.0.0.0/0 md5</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator localhost trust</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator 192.168.1.1/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator 192.168.1.2/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator 192.168.1.3/32 md5</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">postgresql:</span><br/>\n<span class=\"f_CodeExample\">  listen: 192.168.1.1,127.0.0.1:5432 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\">  connect_address: 192.168.1.1:5432 # адрес узла, на котором находится этот файл</span><br/>\n<span class=\"f_CodeExample\">  use_unix_socket: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">true</span><br/>\n<span class=\"f_CodeExample\">  data_dir: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/lib/postgresql/13/main # каталог данных</span><br/>\n<span class=\"f_CodeExample\">  bin_dir: /usr/lib/postgresql/13/bin</span><br/>\n<span class=\"f_CodeExample\">  config_dir: /etc/postgresql/13/main</span><br/>\n<span class=\"f_CodeExample\">  pgpass: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/lib/postgresql/.pgpass_patroni</span><br/>\n<span class=\"f_CodeExample\">  authentication:</span><br/>\n<span class=\"f_CodeExample\">    replication:</span><br/>\n<span class=\"f_CodeExample\">      username: replicator</span><br/>\n<span class=\"f_CodeExample\">      password: ReplicatorPassword</span><br/>\n<span class=\"f_CodeExample\">      sslcert: /path/to/pg.crt # путь до файла сертификата сервера</span><br/>\n<span class=\"f_CodeExample\">      sslkey: /path/to/pg.key # путь до файла закрытого ключа</span><br/>\n<span class=\"f_CodeExample\">      sslrootcert: /path/to/pgCA.pem # путь до файла корневого CA</span><br/>\n<span class=\"f_CodeExample\">    superuser:</span><br/>\n<span class=\"f_CodeExample\">      username: postgres</span><br/>\n<span class=\"f_CodeExample\">      password: PostgresPassword</span><br/>\n<span class=\"f_CodeExample\">      sslcert: /path/to/pg.crt # путь до файла сертификата сервера</span><br/>\n<span class=\"f_CodeExample\">      sslkey: /path/to/pg.key # путь до файла закрытого ключа</span><br/>\n<span class=\"f_CodeExample\">      sslrootcert: /path/to/pgCA.pem # путь до файла корневого CA</span><br/>\n<span class=\"f_CodeExample\">  parameters:</span><br/>\n<span class=\"f_CodeExample\">    unix_socket_directories: /</span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">var</span><span class=\"f_CodeExample\">/run/postgresql</span><br/>\n<span class=\"f_CodeExample\">  pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере</span><br/>\n<span class=\"f_CodeExample\">    - local all postgres peer</span><br/>\n<span class=\"f_CodeExample\">    - local all all peer</span><br/>\n<span class=\"f_CodeExample\">    - hostssl all all 0.0.0.0/0 md5</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator localhost trust</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator 192.168.1.1/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator 192.168.1.2/32 md5</span><br/>\n<span class=\"f_CodeExample\">    - hostssl replication replicator 192.168.1.3/32 md5</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">  remove_data_directory_on_rewind_failure: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  remove_data_directory_on_diverged_timelines: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\" style=\"font-weight: bold;\"> </span><br/>\n<span class=\"f_CodeExample\">  create_replica_methods:</span><br/>\n<span class=\"f_CodeExample\">    - basebackup</span><br/>\n<span class=\"f_CodeExample\">  basebackup:</span><br/>\n<span class=\"f_CodeExample\">    max-rate: '100M'</span><br/>\n<span class=\"f_CodeExample\">    checkpoint: 'fast'</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">watchdog:</span><br/>\n<span class=\"f_CodeExample\">  mode: off # Allowed values: off, automatic, required</span><br/>\n<span class=\"f_CodeExample\">  device: /dev/watchdog</span><br/>\n<span class=\"f_CodeExample\">  safety_margin: 5</span><br/>\n<span class=\"f_CodeExample\"> </span><br/>\n<span class=\"f_CodeExample\">tags:</span><br/>\n<span class=\"f_CodeExample\">  nofailover: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  noloadbalance: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  clonefrom: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span><br/>\n<span class=\"f_CodeExample\">  nosync: </span><span class=\"f_CodeExample\" style=\"font-weight: bold;\">false</span></p>\n<p class=\"p_Normal\"> <br/>\nСделайте пользователя postgres владельцем файла закрытого ключа <code><b>pg.key</b></code>:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">Начало внимание</span></p>\n<p class=\"p_Normal\">Файл закрытого ключа <code><b>pg.key</b></code> указанный в секции <code><b>postgresql</b></code> должен иметь разрешения u=rw (0600) или меньше, если он принадлежит пользователю базы данных postgres, или разрешения u=rw, g=r (0640) или меньше, если он принадлежит пользователю root.</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">Конец внимание</span></p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo chown postgres:postgres -R /path/to/pg.key</span><br/>\n<span class=\"f_CodeExample\">sudo chmod 600 /path/to/pg.key</span></p>\n<p class=\"p_Normal\"> <br/>\nПодробнее о настройке TLS/SSL в Patroni читайте в <a class=\"weblink\" href=\"https://patroni.readthedocs.io/en/latest/yaml_configuration.html\" target=\"_blank\">официальной документации Patroni</a>.</p>\n</td>\n</tr>\n</table>\n</div>\n<ol start=\"3\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"3\">Сделайте пользователя <span style=\"font-weight: bold;\">postgres</span> владельцем каталога настроек:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo chown postgres:postgres -R /etc/patroni</span><br/>\n<span class=\"f_CodeExample\">sudo chmod 700 /etc/patroni</span></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"preparation-postgresql-patroni\"></a><span class=\"f_Heading2\">Шаг 7. Подготовка кластера PostgreSQL+Patroni</span></h2>\n<ol style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"1\">Запустите службу Patroni на узле <span style=\"font-weight: bold;\">postgres-server1.your_domain</span>, а затем на узлах <span style=\"font-weight: bold;\">postgres-server2.your_domain</span> и <span style=\"font-weight: bold;\">postgres-server3.your_domain</span>:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">sudo systemctl enable --now patroni.service</span></p>\n<ol start=\"2\" style=\"list-style-type:upper-roman\">\n<li class=\"p_Normal\" value=\"2\">Проверьте состояние кластера:</li></ol>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">patronictl -c /etc/patroni/config.yml list</span></p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"prepare-pgbouncer\"></a><span class=\"f_Heading2\">Шаг 8. Подготовка PGBouncer (опционально)</span></h2>\n<p class=\"p_Normal\">PGBouncer предназначен для управления пулом соединений к PostgreSQL и позволяет минимизировать издержки, связанные с установлением новых подключений к PostgreSQL.</p>\n<p class=\"p_Normal\">Про установку и настройку PGBouncer читайте в статье <a class=\"topiclink\" href=\"pgbouncer-installation.html\">«Установка PGBouncer»</a>.</p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"haproxy-configuration\"></a><span class=\"f_Heading2\">Шаг 9. Конфигурация HAProxy (блок postgres)</span></h2>\n<p class=\"p_Normal\">Настройте «<a class=\"topiclink\" href=\"fail-safe-haproxy.html\">Отказоустойчивый HAProxy</a>» для приёма запросов к PostgreSQL и балансировку нагрузки между нодами кластера PostgreSQL. Подробнее об этом читайте в статье <a class=\"topiclink\" href=\"haproxy-postgresql.html\">«Конфигурация HAProxy для PostgreSQL»</a>.</p>\n<h2 class=\"p_Heading2\"><a class=\"hmanchor\" id=\"connecting-to-postgresql\"></a><span class=\"f_Heading2\">Шаг 10. Подключение к PostgreSQL</span></h2>\n<p class=\"p_Normal\">Строка для подключения к кластеру PostgreSQL через Haproxy‑сервер:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">psqlUrl: postgresql:</span><span class=\"f_CodeExample\">//elma365:SecretPassword@haproxy-server.your_domain:5000/elma365?sslmode=prefer</span></p>\n<p class=\"p_Normal\">Строка для подключения к кластеру PostgreSQL только для чтения через Haproxy‑сервер:</p>\n<p class=\"p_CodeExample\" style=\"page-break-inside: avoid;\"><span class=\"f_CodeExample\">psqlUrl: postgresql:</span><span class=\"f_CodeExample\">//elma365:SecretPassword@haproxy-server.your_domain:5001/elma365?sslmode=prefer</span></p>\n<p class=\"p_Normal\">Строка для подключения к кластеру PostgreSQL с поддержкой реплик:</p>\n<p class=\"p_CodeExample\" style=\"white-space: normal; page-break-inside: avoid;\"><span class=\"f_CodeExample\">psqlUrl: postgresql://elma365:SecretPassword@postgresql-server1.your_domain:5432,postgresql-server2.your_domain:5432,postgresql-server3.your_domain:5432/elma365?sslmode=prefer&amp;target_session_attrs=primary</span></p>\n<p class=\"p_Normal\">Строка для подключения к кластеру PostgreSQL только для чтения с поддержкой реплик:</p>\n<p class=\"p_CodeExample\" style=\"white-space: normal; page-break-inside: avoid;\"><span class=\"f_CodeExample\">roPsqlUrl: postgresql://elma365:SecretPassword@postgresql-server1.your_domain:5432,postgresql-server2.your_domain:5432,postgresql-server3.your_domain:5432/elma365?sslmode=prefer&amp;target_session_attrs=prefer-standby</span></p>\n<p class=\"p_Normal\">Если настроено внешнее хранилище секретов, например Vault, для подключения к реплике PostgreSQL только для чтения <a class=\"topiclink\" href=\"install-vault.html#secrets\">необходимо задать переменные окружения</a> <code><b>RO_POSTGRES_URL</b></code> и <code><b>ELMA365_POOL_POSTGRES_URL</b></code>.</p>\n<h2 class=\"p_Heading2\"><span class=\"f_Heading2\">Подготовка базы данных в PostgreSQL к восстановлению</span></h2>\n<p class=\"p_Normal\">Если вам потребовалось восстановить базу данных из резервной копии, сначала подготовьте БД к восстановлению. Подробнее об этом читайте в статье <a class=\"topiclink\" href=\"postgresql.html#prepare-to-recovery\">«PostgreSQL»</a>.</p>\n<div class=\"bottom-nav\">\n<a class=\"topic__navi_prev\" href=\"configure-system.html\" id=\"prev-link\">\n<span class=\"bottom-nav__arrow bottom-nav__arrow--prev\"></span> <span class=\"bottom-nav__link\">configure-system.html</span>\n</a>\n<a class=\"topic__navi_next\" href=\"configure-hot-standby-postgresql.html\" id=\"next-link\">\n<span class=\"bottom-nav__link\">configure-hot-standby-postgresql.html</span> <span class=\"bottom-nav__arrow bottom-nav__arrow--next\"></span>\n</a>\n</div>\n<!-- добавляет на страницу строку блок Была ли статья полезной?  -->\n<div class=\"feedback-wrap\"><div class=\"feedback\" id=\"feedback\"><span><b>Была ли статья полезной?</b></span><form action=\"\" class=\"feedback-form\" id=\"feedback-form\" method=\"POST\"><div class=\"feedback__popup feedback__popup-response\" id=\"feedback__popup_thx\">Спасибо за ваш отзыв!</div><div id=\"feedback-success-popup\"><div class=\"wrap\"><button class=\"feedback-popup-close\" type=\"button\">×</button><svg fill=\"none\" height=\"44\" viewbox=\"0 0 44 44\" width=\"44\" xmlns=\"http://www.w3.org/2000/svg\"><g clip-path=\"url(#clip0_212_2187)\"><path d=\"M22 0.6875C10.2294 0.6875 0.6875 10.2294 0.6875 22C0.6875 33.7706 10.2294 43.3125 22 43.3125C33.7706 43.3125 43.3125 33.7706 43.3125 22C43.3125 10.2294 33.7706 0.6875 22 0.6875ZM22 40.5625C11.8023 40.5625 3.4375 32.3078 3.4375 22C3.4375 11.8024 11.6922 3.4375 22 3.4375C32.1977 3.4375 40.5625 11.6922 40.5625 22C40.5625 32.1976 32.3078 40.5625 22 40.5625ZM34.1713 16.933L18.6613 32.3186C18.257 32.7197 17.604 32.7171 17.203 32.3128L9.82283 24.873C9.42176 24.4686 9.42434 23.8157 9.82867 23.4146L10.5609 22.6884C10.9652 22.2873 11.6181 22.2899 12.0192 22.6942L17.9468 28.6697L31.9926 14.7366C32.3969 14.3356 33.0498 14.3382 33.4509 14.7425L34.1772 15.4747C34.5783 15.879 34.5757 16.532 34.1713 16.933Z\" fill=\"#27AE60\"></path></g><defs><clippath id=\"clip0_212_2187\"><rect fill=\"white\" height=\"44\" width=\"44\"></rect></clippath></defs></svg><p>Ваш отзыв успешно отправлен!</p><span>Спасибо за обратную связь.</span></div></div><div class=\"feedback__popup\" id=\"feedback__popup_why\"><button class=\"feedback-popup-close\" type=\"button\">×</button><div class=\"feedback__popup-header\">Уточните, почему:</div><input id=\"bad_recommendation\" name=\"category\" type=\"radio\" value=\"bad_recommendation\"/><label for=\"bad_recommendation\">Рекомендации не помогли</label><input id=\"difficult_text\" name=\"category\" type=\"radio\" value=\"difficult_text\"/><label for=\"difficult_text\">Текст трудно понять</label><input id=\"no_answer\" name=\"category\" type=\"radio\" value=\"no_answer\"/><label for=\"no_answer\">Нет ответа на мой вопрос</label><input id=\"bad_header\" name=\"category\" type=\"radio\" value=\"bad_header\"/><label for=\"bad_header\">Содержание статьи не соответствует заголовку</label><input id=\"other_reason\" name=\"category\" type=\"radio\" value=\"other_reason\"/><label for=\"other_reason\">Другая причина</label></div><div class=\"feedback__popup\" id=\"feedback__popup-other\"><button class=\"feedback-popup-close\" type=\"button\">×</button> <div class=\"feedback__popup-header\">Расскажите, что вам не понравилось в статье:</div><textarea class=\"feedback__textarea\" id=\"\" name=\"other\"></textarea><input class=\"feedback__other-btn\" type=\"submit\" value=\"Отправить\"/></div><div class=\"feedback-form__btn-group\"><input id=\"feedback__useful_yes\" name=\"useful\" type=\"radio\" value=\"true\"/><label for=\"feedback__useful_yes\"><img src=\"like.svg\"/><span class=\"feedback-form__btn-group_yes-btn\">Да</span></label><input id=\"feedback__useful_no\" name=\"useful\" type=\"radio\" value=\"false\"/><label for=\"feedback__useful_no\"><img src=\"dislike.svg\"/><span class=\"feedback-form__btn-group_no-btn\">Нет</span></label></div><select name=\"category\"><option disabled=\"\">Выберите вариант</option><option selected=\"\" value=\"bad_recommendation\">Рекомендации не помогли</option><option value=\"difficult_text\">Текст трудно понять</option><option value=\"no_answer\">Нет ответа на мой вопрос</option><option value=\"bad_header\">Содержание статьи не соответствует заголовку</option><option value=\"other_reason\">Другая причина</option></select><input type=\"submit\"/></form></div></div>\n</section>\n</div>\n<aside class=\"article__sidebar\" style=\"display:none\">\n<input type=\"checkbox\"/>\n<div class=\"article__arrow\"></div>\n<div class=\"table-of-contents elma365-right\" id=\"toc2Content\">\n<h3 class=\"h3-toc\">В этой статье</h3>\n<nav id=\"toc2\"></nav>\n</div>\n</aside>\n</div>\n</article>\n</main>\n<footer class=\"footer\">\n<div class=\"footer-container\">\n<div class=\"footer-mobile\">\n<ul class=\"footer-mobile__list\"><li><a href=\"https://api.elma365.com/ru/\" target=\"_blank\">API</a></li><li><a href=\"https://tssdk.elma365.com/\" target=\"_blank\">TS SDK</a></li><li><a href=\"https://community.elma365.com/\" target=\"_blank\">Community</a></li><li><a href=\"https://elma-academy.com/ru/elma365\" target=\"_blank\">Академия</a></li></ul><ul class=\"footer-mobile__list\"><li><a href=\"https://elma365.com/ru/help/platform/get-trial.html\">Платформа</a></li><li><a href=\"https://elma365.com/ru/help/ecm/ecm-functions.html\">ECM</a></li><li><a href=\"https://elma365.com/ru/help/service/service-functions.html\">Service</a></li><li><a href=\"https://elma365.com/ru/help/projects/projects-functions.html\">Проекты</a></li></ul>\n</div>\n<div class=\"container\">\n<div class=\"footer-wrap\">\n<div><span class=\"mobile-question-popup\">Отправить фидбэк</span><form action=\"\" class=\"question__popup question-xs\" id=\"question__popup\" method=\"POST\"><div class=\"question-wrap\"><span class=\"close\"></span><span class=\"title\">Задать вопрос</span><label for=\"help_question\" style=\"display: none;\"></label><textarea id=\"help_question\" name=\"help_question\"></textarea><input type=\"submit\" value=\"Отправить\"/></div></form><div class=\"hidden fade-in question-success-xs\">Ваш фидбэк отправлен.</div></div>\n<div class=\"footer-flex-b\">\n<div class=\"footer-top\">\n<span class=\"footer-copy\">© 2025 \n              ELMA365\n            \n            \n          </span>\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</div>\n<div class=\"footer-line\">\n<div class=\"footer-line-copy\">\n<span class=\"footer-copy\">© 2025 \n                  ELMA365\n                \n                \n              </span>\n</div>\n<ul class=\"footer-list\">\n<li class=\"footer-item footer-url-elma\"><a class=\"footer-link footer-url-link-elma\" href=\"https://elma365.com/ru/\" style=\"color: #0D4A75;\" target=\"_blank\"><img alt=\"browse icon\" class=\"footer-img footer-img-elma-url\" src=\"browse.svg\"/>elma365.com</a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vkvideo.ru/@elma_bpm\" target=\"_blank\"><img alt=\"vk-video icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk-video.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://vk.com/elma_bpm\" target=\"_blank\"><img alt=\"vk icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"vk.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://t.me/elmaday\" target=\"_blank\"><img alt=\"telegram icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"telegram.svg\" width=\"20\"/></a></li><li class=\"footer-item\"><a class=\"footer-link\" href=\"https://dzen.ru/elma\" target=\"_blank\"><img alt=\"dzen icon\" class=\"footer-img social-footer-img\" height=\"20\" src=\"social_dzen.svg\" width=\"20\"/></a></li>\n<li class=\"footer-item sk-footer-img\">\n<a class=\"sk-img\" href=\"https://navigator.sk.ru/orn/1122971\" target=\"_blank\">\n<img alt=\"sk icon\" class=\"footer-img\" height=\"34\" src=\"sk-resident.svg\" width=\"117\"/>\n</a>\n</li>\n</ul>\n</div>\n</div>\n</div>\n</div>\n<a class=\"arrow-top\" href=\"#\"></a>\n</div>\n</footer>\n<!--    <script type=\"text/javascript\" src=\"jquery1.min.js\"></script>-->\n<iframe name=\"hmnavigation\" style=\"display:none!important\"></iframe>\n<!--<script src=\"./jquery-ui.js\"></script> -->\n<script src=\"./jquery-ui.min.js\"></script>\n<!--script src=\"//cdn.jsdelivr.net/npm/featherlight@1.7.14/release/featherlight.min.js\" type=\"text/javascript\" charset=\"utf-8\"></script-->\n<script src=\"./jquery.tocify.min.js\"></script>\n<script src=\"./TypoReporter.min.js\"></script>\n<script src=\"./google-search.js\"></script>\n<script src=\"./main.js\"></script>\n<script type=\"text/javascript\">\nHMInitToggle('TOGGLE0186A1','hm.type','dropdown','hm.state','0');\nHMInitToggle('TOGGLE0186A2','hm.type','dropdown','hm.state','0');\nHMInitToggle('TOGGLE0186A3','hm.type','dropdown','hm.state','0');\nHMInitToggle('TOGGLE0186A4','hm.type','dropdown','hm.state','0');\nHMInitToggle('TOGGLE0186A5','hm.type','dropdown','hm.state','0');\nHMInitToggle('TOGGLE0186A6','hm.type','dropdown','hm.state','0');\n</script>\n</body>\n</html>\n",
  "plain_text": "Кластер PostgreSQL ﻿ Платформа CSP CRM+CX Проекты Service КЭДО Бизнес-решения Academy Community API SDK Сайт ELMA365 ELMA365 On-Premises > Подготовка инфраструктуры ELMA365 On-Premises > Базы данных > Отказоустойчивая инфраструктура / Кластер PostgreSQL Кластер PostgreSQL В статье описана установка PostgreSQL 13 для ОС Ubuntu Linux 20.04 и 22.04. Смотрите поддерживаемые версии PostgreSQL для корректной работы системы в статье «Системные требования ELMA365 On-Premises» . Также вы можете ознакомиться с руководством в официальной документации PostgreSQL . Установка состоит из нескольких этапов: Подготовка нод (серверов) . Подготовка кластера etcd . Установка PostgreSQL . Настройка PostgreSQL . Установка Patroni . Настройка Patroni . Подготовка кластера PostgreSQL+Patroni . Подготовка PGBouncer (опционально) . Конфигурация HAProxy (блок postgres) . Подключение к PostgreSQL . Шаг 1. Подготовка нод (серверов) Создайте три ноды (сервера) с последовательно пронумерованными именами хостов. начало внимание Минимальное количество серверов для организации кластера — три. конец внимание В этом примере используется три узла со следующими hostname и IP-адресами: postgres-server1.your_domain, 192.168.1.1 ; postgres-server2.your_domain, 192.168.1.2 ; postgres-server3.your_domain, 192.168.1.3 . Создайте необходимые сопоставления имён хостов в DNS. Если такой возможности нет, внесите нужные записи в /etc/hosts . Шаг 2. Подготовка кластера etcd Установите etcd на все узлы: sudo apt- get install etcd -y Остановите etcd на всех узлах: sudo systemctl stop etcd Удалите каталог данных: sudo rm -rf / var /lib/etcd /* Переместите конфигурационный файл по умолчанию: sudo mv /etc/default/etcd{,.original} Создайте и откройте для редактирования новый конфигурационный файл: sudo nano /etc/default/etcd Добавьте пример конфигураций в файл для узла postgres-server1.your_domain : ETCD_NAME=\"postgres-server1\" ETCD_DATA_DIR=\"/var/lib/etcd/default\" ETCD_HEARTBEAT_INTERVAL=\"1000\" ETCD_ELECTION_TIMEOUT=\"5000\" ETCD_LISTEN_PEER_URLS=\"http://192.168.1.1:2380\" ETCD_LISTEN_CLIENT_URLS=\"http://192.168.1.1:2379,http://localhost:2379\" ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.1.1:2380\" ETCD_INITIAL_CLUSTER=\"postgres-server1=http://192.168.1.1:2380,postgres-server2=http://192.168.1.2:2380,postgres-server3=http://192.168.1.3:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.1.1:2379\" ETCD_ENABLE_V2=\"true\" ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\" Пример конфигураций с включением TLS/SSL для узла postgres-server1.your_domain ETCD_NAME=\"postgres-server1\" ETCD_DATA_DIR=\"/var/lib/etcd/default\" ETCD_HEARTBEAT_INTERVAL=\"1000\" ETCD_ELECTION_TIMEOUT=\"5000\" ETCD_LISTEN_PEER_URLS=\"https://192.168.1.1:2380\" ETCD_LISTEN_CLIENT_URLS=\"https://192.168.1.1:2379,https://localhost:2379\" ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://postgres-server1.your_domain:2380\" ETCD_INITIAL_CLUSTER=\"postgres-server1=https://postgres-server1.your_domain:2380,postgres-server2=https://postgres-server2.your_domain:2380,postgres-server3=https://postgres-server3.your_domain:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"https://postgres-server1.your_domain:2379\" ETCD_ENABLE_V2=\"true\" ETCD_CERT_FILE=\"/path/to/public.crt\" ETCD_KEY_FILE=\"/path/to/private.key\" ETCD_CLIENT_CERT_AUTH=\"true\" ETCD_TRUSTED_CA_FILE=\"/path/to/certCA.pem\" ETCD_PEER_CERT_FILE=\"/path/to/public.crt\" ETCD_PEER_KEY_FILE=\"/path/to/private.key\" ETCD_PEER_CLIENT_CERT_AUTH=\"true\" ETCD_PEER_TRUSTED_CA_FILE=\"/path/to/certCA.pem\" ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\" Добавьте пример конфигураций в файл для узла postgres-server2.your_domain : ETCD_NAME=\"postgres-server2\" ETCD_DATA_DIR=\"/var/lib/etcd/default\" ETCD_HEARTBEAT_INTERVAL=\"1000\" ETCD_ELECTION_TIMEOUT=\"5000\" ETCD_LISTEN_PEER_URLS=\"http://192.168.1.2:2380\" ETCD_LISTEN_CLIENT_URLS=\"http://192.168.1.2:2379,http://127.0.0.1:2379\" ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.1.2:2380\" ETCD_INITIAL_CLUSTER=\"postgres-server1=http://192.168.1.1:2380,postgres-server2=http://192.168.1.2:2380,postgres-server3=http://192.168.1.3:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.1.2:2379\" ETCD_ENABLE_V2=\"true\" ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\" Пример конфигураций с включением TLS/SSL для узла postgres-server2.your_domain ETCD_NAME=\"postgres-server2\" ETCD_DATA_DIR=\"/var/lib/etcd/default\" ETCD_HEARTBEAT_INTERVAL=\"1000\" ETCD_ELECTION_TIMEOUT=\"5000\" ETCD_LISTEN_PEER_URLS=\"https://192.168.1.2:2380\" ETCD_LISTEN_CLIENT_URLS=\"https://192.168.1.2:2379,https://localhost:2379\" ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://postgres-server2.your_domain:2380\" ETCD_INITIAL_CLUSTER=\"postgres-server1=https://postgres-server1.your_domain:2380,postgres-server2=https://postgres-server2.your_domain:2380,postgres-server3=https://postgres-server3.your_domain:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"https://postgres-server2.your_domain:2379\" ETCD_ENABLE_V2=\"true\" ETCD_CERT_FILE=\"/path/to/public.crt\" ETCD_KEY_FILE=\"/path/to/private.key\" ETCD_CLIENT_CERT_AUTH=\"true\" ETCD_TRUSTED_CA_FILE=\"/path/to/certCA.pem\" ETCD_PEER_CERT_FILE=\"/path/to/public.crt\" ETCD_PEER_KEY_FILE=\"/path/to/private.key\" ETCD_PEER_CLIENT_CERT_AUTH=\"true\" ETCD_PEER_TRUSTED_CA_FILE=\"/path/to/certCA.pem\" ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\" Добавьте пример конфигураций в файл для узла postgres-server3.your_domain : ETCD_NAME=\"postgres-server3\" ETCD_DATA_DIR=\"/var/lib/etcd/default\" ETCD_HEARTBEAT_INTERVAL=\"1000\" ETCD_ELECTION_TIMEOUT=\"5000\" ETCD_LISTEN_PEER_URLS=\"http://192.168.1.3:2380\" ETCD_LISTEN_CLIENT_URLS=\"http://192.168.1.3:2379,http://localhost:2379\" ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://192.168.1.3:2380\" ETCD_INITIAL_CLUSTER=\"postgres-server1=http://192.168.1.1:2380,postgres-server2=http://192.168.1.2:2380,postgres-server3=http://192.168.1.3:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"http://192.168.1.3:2379\" ETCD_ENABLE_V2=\"true\" ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\" Пример конфигураций с включением TLS/SSL для узла postgres-server3.your_domain ETCD_NAME=\"postgres-server3\" ETCD_DATA_DIR=\"/var/lib/etcd/default\" ETCD_HEARTBEAT_INTERVAL=\"1000\" ETCD_ELECTION_TIMEOUT=\"5000\" ETCD_LISTEN_PEER_URLS=\"https://192.168.1.3:2380\" ETCD_LISTEN_CLIENT_URLS=\"https://192.168.1.3:2379,https://localhost:2379\" ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://postgres-server3.your_domain:2380\" ETCD_INITIAL_CLUSTER=\"postgres-server1=https://postgres-server1.your_domain:2380,postgres-server2=https://postgres-server2.your_domain:2380,postgres-server3=https://postgres-server3.your_domain:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-postgres-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"https://postgres-server3.your_domain:2379\" ETCD_ENABLE_V2=\"true\" ETCD_CERT_FILE=\"/path/to/public.crt\" ETCD_KEY_FILE=\"/path/to/private.key\" ETCD_CLIENT_CERT_AUTH=\"true\" ETCD_TRUSTED_CA_FILE=\"/path/to/certCA.pem\" ETCD_PEER_CERT_FILE=\"/path/to/public.crt\" ETCD_PEER_KEY_FILE=\"/path/to/private.key\" ETCD_PEER_CLIENT_CERT_AUTH=\"true\" ETCD_PEER_TRUSTED_CA_FILE=\"/path/to/certCA.pem\" ETCD_INITIAL_ELECTION_TICK_ADVANCE=\"false\" Рассмотрим введённые параметры: ETCD_NAME — имя этого узла кластера. Должно быть уникально в кластере; ETCD_LISTEN_CLIENT_URLS — точка подключения для клиентов кластера; ETCD_ADVERTISE_CLIENT_URLS — список URL-адресов, по которым его могут найти остальные узлы кластера; ETCD_LISTEN_PEER_URLS — точка подключения для остальных узлов кластера; ETCD_INITIAL_ADVERTISE_PEER_URLS — начальный список URL-адресов, по которым его могут найти остальные узлы кластера; ETCD_INITIAL_CLUSTER_TOKEN — токен кластера, должен совпадать на всех узлах кластера; ETCD_INITIAL_CLUSTER — список узлов кластера на момент запуска; ETCD_INITIAL_CLUSTER_STATE — может принимать два значения: new и existing ; ETCD_DATA_DIR — расположение каталога данных кластера; ETCD_ELECTION_TIMEOUT — время в миллисекундах, которое проходит между последним принятым оповещением от лидера кластера, до попытки захватить роль лидера на ведомом узле; ETCD_HEARTBEAT_INTERVAL — время в миллисекундах между рассылками лидером оповещений о том, что он всё ещё лидер; ETCD_CERT_FILE — путь до файла сертификата сервера; ETCD_KEY_FILE — путь до файла закрытого ключа; ETCD_TRUSTED_CA_FILE — путь до файла корневого CA; ETCD_CLIENT_CERT_AUTH — может принимать два значения: true и false ; ETCD_PEER_CERT_FILE — путь до файла сертификата сервера; ETCD_PEER_KEY_FILE — путь до файла закрытого ключа; ETCD_PEER_TRUSTED_CA_FILE — путь до файла корневого CA; ETCD_PEER_CLIENT_CERT_AUTH — может принимать два значения: true и false . Перезапустите etcd на всех узлах: sudo systemctl restart etcd Проверьте состояние кластера. Для кластера без TLS: sudo etcdctl cluster-health Для кластера c TLS: sudo etcdctl -C https: //postgres-server1.your_domain:2379 --key-file /path/to/private.key --cert-file /path/to/public.crt --ca-file /path/to/certCA.pem cluster-health Шаг 3. Установка PostgreSQL начало внимание С аппаратными требованиями, необходимыми для корректной работы ELMA365 на PostgreSQL, можно ознакомиться в статье «Системные требования ELMA365 On-Premises» . конец внимание Для установки PostgreSQL добавьте официальный репозиторий postgresql : sudo sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list' wget --quiet -O - https: //www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - Обновите кеш пакетов, выполнив команду: sudo apt update Установите PostgreSQL на все узлы: sudo apt install postgresql-13 -y Шаг 4. Настройка PostgreSQL начало примечание Примечание Для пароля разрешается применять следующие символы: Заглавные латинские буквы: от A до Z; Строчные латинские буквы: от a до z; Цифры от 0 до 9; Символы: -_. Зарезервированные (недопустимые) символы: ! * ' ( ) ; : @ & = + $ , / ? % # [ ] конец примечание Действия для узла postgres-server1.your_domain: Создайте новую роль elma365 с паролем SecretPassword : sudo -u postgres psql -c \\ \"CREATE ROLE elma365 WITH login password 'SecretPassword';\" Создайте базу данных elma365 с базовой локалью и назначьте выделенного пользователя elma365 её владельцем: sudo -u postgres psql -c \\ \"CREATE DATABASE elma365 WITH OWNER elma365;\" Создание базы данных с локалью ru_RU.UTF-8 Вы можете создать базу данных elma365 с локалью ru_RU.UTF-8 . Это позволит улучшить работу механизмов сортировки и индексирования русскоязычных данных, а также ускорить выполнение поисковых и текстовых операций. Для этого: Убедитесь, что локаль ru_RU.UTF-8 доступна в системе: locale -a | grep ru_RU При наличии локали отобразится её название. Если в системе отсутствует локаль ru_RU.UTF-8 , установите её, выполнив команду: sudo locale-gen ru_RU.UTF-8 && sudo update-locale После установки перезагрузите сервис PostgreSQL для применения изменений: sudo systemctl restart postgresql Создайте базу данных с локалью ru_RU.UTF-8 : sudo -u postgres psql -c \"CREATE DATABASE elma365 WITH OWNER = elma365 LOCALE_PROVIDER = icu ICU_LOCALE = 'ru-RU' ENCODING = 'UTF8' LC_COLLATE = 'ru_RU.UTF-8' LC_CTYPE = 'ru_RU.UTF-8' TEMPLATE = template0;\" Добавьте необходимые расширения для базы данных elma365 : sudo -u postgres psql -d elma365 -c \\ \"CREATE EXTENSION \\\"uuid-ossp\\\"; CREATE EXTENSION pg_trgm;\" Создайте новую роль replicator с паролем ReplicatorPassword для работы с репликами. Должно совпадать с настройками Patroni из блока postgresql - authentication - replication и списком разрешённых хостов postgresql в файле pg_hba.conf : sudo -u postgres psql -c \\ \"CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'ReplicatorPassword';\" Установите пароль для пользователя postgres : sudo -u postgres psql -c \"ALTER USER postgres PASSWORD 'PostgresPassword';\" Остановите PostgreSQL: systemctl stop postgresql Действия для узла postgres-server2.your_domain и postgres-server3.your_domain: Остановите PostgreSQL: systemctl stop postgresql Удалите каталог данных на нодах postgres-server2.your_domain и postgres-server3.your_domain : rm -rf / var /lib/postgresql/13/main Шаг 5. Установка Patroni Установите Patroni и PIP на все узлы: sudo apt-get install python3-pip python3-dev libpq-dev -y sudo apt-get install patroni -y Установите зависимости для работы Patroni на все узлы: pip3 install psycopg2-binary pip3 install wheel pip3 install python-etcd Шаг 6. Настройка Patroni Создайте файл настроек: sudo nano /etc/patroni/config.yml В созданный файл /etc/patroni/config.yml нужно поместить пример начальной конфигурации, изменив ip-адреса на свои на каждом узле кластера. Обратите внимание на комментарии в данном файле. Пример начальной конфигурации scope: postgres-cluster # одинаковое значение на всех узлах name: postgresql-server1 # разное значение на всех узлах namespace: /service/ # одинаковое значение на всех узлах restapi: listen: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл connect_address: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл etcd: hosts: postgres-server1.your_domain:2379,postgres-server2.your_domain:2379,postgres-server3.your_domain:2379 # список всех узлов, на которых установлен etcd bootstrap: method: initdb dcs: ttl: 30 loop_wait: 10 retry_timeout: 10 maximum_lag_on_failover: 1048576 master_start_timeout: 300 synchronous_mode: false synchronous_mode_strict: false synchronous_node_count: 1 postgresql: use_pg_rewind: true use_slots: true parameters: max_connections: 2000 superuser_reserved_connections: 5 max_locks_per_transaction: 64 max_prepared_transactions: 0 huge_pages: try shared_buffers: 512MB work_mem: 128MB maintenance_work_mem: 256MB effective_cache_size: 4GB checkpoint_timeout: 15min checkpoint_completion_target: 0.9 wal_compression: on min_wal_size: 2GB max_wal_size: 4GB wal_buffers: 32MB default_statistics_target: 1000 seq_page_cost: 1 random_page_cost: 4 effective_io_concurrency: 2 synchronous_commit: on autovacuum: on autovacuum_max_workers: 5 autovacuum_vacuum_scale_factor: 0.01 autovacuum_analyze_scale_factor: 0.02 autovacuum_vacuum_cost_limit: 200 autovacuum_vacuum_cost_delay: 20 autovacuum_naptime: 1s max_files_per_process: 4096 archive_mode: on archive_timeout: 1800s archive_command: cd . wal_level: replica wal_keep_segments: 130 max_wal_senders: 10 max_replication_slots: 10 hot_standby: on hot_standby_feedback: True wal_log_hints: on shared_preload_libraries: pg_stat_statements,auto_explain pg_stat_statements.max: 10000 pg_stat_statements.track: all pg_stat_statements.save: off auto_explain.log_min_duration: 10s auto_explain.log_analyze: true auto_explain.log_buffers: true auto_explain.log_timing: false auto_explain.log_triggers: true auto_explain.log_verbose: true auto_explain.log_nested_statements: true standard_conforming_strings: true track_io_timing: on log_lock_waits: on log_temp_files: 3 track_activities: on track_counts: on track_functions: all log_checkpoints: on logging_collector: on log_truncate_on_rotation: on log_rotation_age: 1d log_rotation_size: 0 log_line_prefix: '%t [%p-%l] %r %q%u@%d ' log_filename: 'postgresql-%a.log' log_directory: / var /log/postgresql initdb: # List options to be passed on to initdb - encoding: UTF8 - locale: en_US.UTF-8 - data-checksums pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере - local all postgres peer - local all all peer - host all all 0.0.0.0/0 md5 - host replication replicator localhost trust - host replication replicator 192.168.1.1/32 md5 - host replication replicator 192.168.1.2/32 md5 - host replication replicator 192.168.1.3/32 md5 postgresql: listen: 192.168.1.1,127.0.0.1:5432 # адрес узла, на котором находится этот файл connect_address: 192.168.1.1:5432 # адрес узла, на котором находится этот файл use_unix_socket: true data_dir: / var /lib/postgresql/13/main # каталог данных bin_dir: /usr/lib/postgresql/13/bin config_dir: /etc/postgresql/13/main pgpass: / var /lib/postgresql/.pgpass_patroni authentication: replication: username: replicator password: ReplicatorPassword superuser: username: postgres password: PostgresPassword parameters: unix_socket_directories: / var /run/postgresql pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере - local all postgres peer - local all all peer - host all all 0.0.0.0/0 md5 - host replication replicator localhost trust - host replication replicator 192.168.1.1/32 md5 - host replication replicator 192.168.1.2/32 md5 - host replication replicator 192.168.1.3/32 md5 remove_data_directory_on_rewind_failure: false remove_data_directory_on_diverged_timelines: false create_replica_methods: - basebackup basebackup: max-rate: '100M' checkpoint: 'fast' watchdog: mode: off # Allowed values: off, automatic, required device: /dev/watchdog safety_margin: 5 tags: nofailover: false noloadbalance: false clonefrom: false nosync: false Пример начальной конфигурации для включения поддержки TLS/SSL в Patroni Нужно поместить пример начальной конфигурации с TLS/SSL в файл /etc/patroni/config.yml . Обратите внимание на комментарии в данном файле: scope: postgres-cluster # одинаковое значение на всех узлах name: postgresql-server1 # разное значение на всех узлах namespace: /service/ # одинаковое значение на всех узлах restapi: listen: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл connect_address: postgres-server1.your_domain:8008 # адрес узла, на котором находится этот файл cafile: /path/to/pgCA.pem certfile: /path/to/pg.crt # путь до файла сертификата сервера keyfile: /path/to/pg.key # путь до файла закрытого ключа verify_client: required # путь до файла корневого CA etcd: protocol: https cert: /path/to/ public .crt # путь до файла сертификата сервера key: /path/to/ private .key # путь до файла закрытого ключа cacert: /path/to/certCA.pem # путь до файла корневого CA hosts: postgres-server1.your_domain:2379,postgres-server2.your_domain:2379,postgres-server3.your_domain:2379 # список всех узлов, на которых установлен etcd ctl: insecure: false # Allow connections to SSL sites without certs certfile: /path/to/pg.crt # путь до файла сертификата сервера keyfile: /path/to/pg.key # путь до файла закрытого ключа cacert: /path/to/pgCA.pem # путь до файла корневого CA bootstrap: method: initdb dcs: ttl: 30 loop_wait: 10 retry_timeout: 10 maximum_lag_on_failover: 1048576 master_start_timeout: 300 synchronous_mode: false synchronous_mode_strict: false synchronous_node_count: 1 postgresql: use_pg_rewind: true use_slots: true parameters: max_connections: 2000 superuser_reserved_connections: 5 max_locks_per_transaction: 64 max_prepared_transactions: 0 huge_pages: try shared_buffers: 512MB work_mem: 128MB maintenance_work_mem: 256MB effective_cache_size: 4GB checkpoint_timeout: 15min checkpoint_completion_target: 0.9 wal_compression: on min_wal_size: 2GB max_wal_size: 4GB wal_buffers: 32MB default_statistics_target: 1000 seq_page_cost: 1 random_page_cost: 4 effective_io_concurrency: 2 synchronous_commit: on autovacuum: on autovacuum_max_workers: 5 autovacuum_vacuum_scale_factor: 0.01 autovacuum_analyze_scale_factor: 0.02 autovacuum_vacuum_cost_limit: 200 autovacuum_vacuum_cost_delay: 20 autovacuum_naptime: 1s max_files_per_process: 4096 archive_mode: on archive_timeout: 1800s archive_command: cd . wal_level: replica wal_keep_segments: 130 max_wal_senders: 10 max_replication_slots: 10 hot_standby: on hot_standby_feedback: True wal_log_hints: on shared_preload_libraries: pg_stat_statements,auto_explain pg_stat_statements.max: 10000 pg_stat_statements.track: all pg_stat_statements.save: off auto_explain.log_min_duration: 10s auto_explain.log_analyze: true auto_explain.log_buffers: true auto_explain.log_timing: false auto_explain.log_triggers: true auto_explain.log_verbose: true auto_explain.log_nested_statements: true standard_conforming_strings: true track_io_timing: on log_lock_waits: on log_temp_files: 3 track_activities: on track_counts: on track_functions: all log_checkpoints: on logging_collector: on log_truncate_on_rotation: on log_rotation_age: 1d log_rotation_size: 0 log_line_prefix: '%t [%p-%l] %r %q%u@%d ' log_filename: 'postgresql-%a.log' log_directory: / var /log/postgresql ssl: on ssl_ca_file: '/path/to/pgCA.pem' ssl_cert_file: '/path/to/pg.crt' ssl_key_file: '/path/to/pg.key' initdb: # List options to be passed on to initdb - encoding: UTF8 - locale: en_US.UTF-8 - data-checksums pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере - local all postgres peer - local all all peer - hostssl all all 0.0.0.0/0 md5 - hostssl replication replicator localhost trust - hostssl replication replicator 192.168.1.1/32 md5 - hostssl replication replicator 192.168.1.2/32 md5 - hostssl replication replicator 192.168.1.3/32 md5 postgresql: listen: 192.168.1.1,127.0.0.1:5432 # адрес узла, на котором находится этот файл connect_address: 192.168.1.1:5432 # адрес узла, на котором находится этот файл use_unix_socket: true data_dir: / var /lib/postgresql/13/main # каталог данных bin_dir: /usr/lib/postgresql/13/bin config_dir: /etc/postgresql/13/main pgpass: / var /lib/postgresql/.pgpass_patroni authentication: replication: username: replicator password: ReplicatorPassword sslcert: /path/to/pg.crt # путь до файла сертификата сервера sslkey: /path/to/pg.key # путь до файла закрытого ключа sslrootcert: /path/to/pgCA.pem # путь до файла корневого CA superuser: username: postgres password: PostgresPassword sslcert: /path/to/pg.crt # путь до файла сертификата сервера sslkey: /path/to/pg.key # путь до файла закрытого ключа sslrootcert: /path/to/pgCA.pem # путь до файла корневого CA parameters: unix_socket_directories: / var /run/postgresql pg_hba: # должен содержать адреса ВСЕХ машин, используемых в кластере - local all postgres peer - local all all peer - hostssl all all 0.0.0.0/0 md5 - hostssl replication replicator localhost trust - hostssl replication replicator 192.168.1.1/32 md5 - hostssl replication replicator 192.168.1.2/32 md5 - hostssl replication replicator 192.168.1.3/32 md5 remove_data_directory_on_rewind_failure: false remove_data_directory_on_diverged_timelines: false create_replica_methods: - basebackup basebackup: max-rate: '100M' checkpoint: 'fast' watchdog: mode: off # Allowed values: off, automatic, required device: /dev/watchdog safety_margin: 5 tags: nofailover: false noloadbalance: false clonefrom: false nosync: false Сделайте пользователя postgres владельцем файла закрытого ключа pg.key : Начало внимание Файл закрытого ключа pg.key указанный в секции postgresql должен иметь разрешения u=rw (0600) или меньше, если он принадлежит пользователю базы данных postgres, или разрешения u=rw, g=r (0640) или меньше, если он принадлежит пользователю root. Конец внимание sudo chown postgres:postgres -R /path/to/pg.key sudo chmod 600 /path/to/pg.key Подробнее о настройке TLS/SSL в Patroni читайте в официальной документации Patroni . Сделайте пользователя postgres владельцем каталога настроек: sudo chown postgres:postgres -R /etc/patroni sudo chmod 700 /etc/patroni Шаг 7. Подготовка кластера PostgreSQL+Patroni Запустите службу Patroni на узле postgres-server1.your_domain , а затем на узлах postgres-server2.your_domain и postgres-server3.your_domain : sudo systemctl enable --now patroni.service Проверьте состояние кластера: patronictl -c /etc/patroni/config.yml list Шаг 8. Подготовка PGBouncer (опционально) PGBouncer предназначен для управления пулом соединений к PostgreSQL и позволяет минимизировать издержки, связанные с установлением новых подключений к PostgreSQL. Про установку и настройку PGBouncer читайте в статье «Установка PGBouncer» . Шаг 9. Конфигурация HAProxy (блок postgres) Настройте « Отказоустойчивый HAProxy » для приёма запросов к PostgreSQL и балансировку нагрузки между нодами кластера PostgreSQL. Подробнее об этом читайте в статье «Конфигурация HAProxy для PostgreSQL» . Шаг 10. Подключение к PostgreSQL Строка для подключения к кластеру PostgreSQL через Haproxy‑сервер: psqlUrl: postgresql: //elma365:SecretPassword@haproxy-server.your_domain:5000/elma365?sslmode=prefer Строка для подключения к кластеру PostgreSQL только для чтения через Haproxy‑сервер: psqlUrl: postgresql: //elma365:SecretPassword@haproxy-server.your_domain:5001/elma365?sslmode=prefer Строка для подключения к кластеру PostgreSQL с поддержкой реплик: psqlUrl: postgresql://elma365:SecretPassword@postgresql-server1.your_domain:5432,postgresql-server2.your_domain:5432,postgresql-server3.your_domain:5432/elma365?sslmode=prefer&target_session_attrs=primary Строка для подключения к кластеру PostgreSQL только для чтения с поддержкой реплик: roPsqlUrl: postgresql://elma365:SecretPassword@postgresql-server1.your_domain:5432,postgresql-server2.your_domain:5432,postgresql-server3.your_domain:5432/elma365?sslmode=prefer&target_session_attrs=prefer-standby Если настроено внешнее хранилище секретов, например Vault, для подключения к реплике PostgreSQL только для чтения необходимо задать переменные окружения RO_POSTGRES_URL и ELMA365_POOL_POSTGRES_URL . Подготовка базы данных в PostgreSQL к восстановлению Если вам потребовалось восстановить базу данных из резервной копии, сначала подготовьте БД к восстановлению. Подробнее об этом читайте в статье «PostgreSQL» . configure-system.html configure-hot-standby-postgresql.html Была ли статья полезной? Спасибо за ваш отзыв! × Ваш отзыв успешно отправлен! Спасибо за обратную связь. × Уточните, почему: Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина × Расскажите, что вам не понравилось в статье: Да Нет Выберите вариант Рекомендации не помогли Текст трудно понять Нет ответа на мой вопрос Содержание статьи не соответствует заголовку Другая причина В этой статье API TS SDK Community Академия Платформа ECM Service Проекты Отправить фидбэк Задать вопрос Ваш фидбэк отправлен. © 2025 ELMA365 © 2025 ELMA365 elma365.com",
  "links": [
    "https://elma365.com/ru/help",
    "https://elma365.com/ru/help/platform/get-trial.html",
    "https://elma365.com/ru/help/ecm/ecm-functions.html",
    "https://elma365.com/ru/help/crm/crm-functions.html",
    "https://elma365.com/ru/help/projects/projects-functions.html",
    "https://elma365.com/ru/help/service/service-functions.html",
    "https://elma365.com/ru/help/kedo/kedo.html",
    "https://elma365.com/ru/help/business_solutions/-elma365-store.html",
    "https://elma-academy.com/ru/",
    "https://community.elma365.com/ru/",
    "https://api.elma365.com/ru/",
    "https://tssdk.elma365.com/latest/",
    "https://elma365.com/ru/",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/elma365-on-premises.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/infrastructure-preparation.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/elma365-enterprise-on-premises.html",
    "https://www.postgresql.org/docs/13/high-availability.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/configure-postgresql.html",
    "https://patroni.readthedocs.io/en/latest/yaml_configuration.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/pgbouncer-installation.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/fail-safe-haproxy.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/haproxy-postgresql.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/install-vault.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/postgresql.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/configure-system.html",
    "https://elma365.com/ru/help/business_solutions/ /ru/help/platform/configure-hot-standby-postgresql.html",
    "https://tssdk.elma365.com/",
    "https://community.elma365.com/",
    "https://elma-academy.com/ru/elma365",
    "https://navigator.sk.ru/orn/1122971",
    "https://vkvideo.ru/@elma_bpm",
    "https://vk.com/elma_bpm",
    "https://t.me/elmaday",
    "https://dzen.ru/elma"
  ],
  "last_crawled": "2025-11-29T22:03:25.115045",
  "metadata": {
    "depth": 10,
    "saved_at": "2025-11-29T22:03:25.214293"
  }
}